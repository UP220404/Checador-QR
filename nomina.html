<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de N√≥mina Quincenal | Cielito Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="nomina.css">
  <link rel="icon" href="img/cielitohome.png" type="image/png">
</head>
<body>
  <!-- Navbar Mejorado -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="admin.html">
        <div class="brand-icon me-2">
          <i class="bi bi-calculator-fill"></i>
        </div>
        <div class="brand-text">
          <div class="brand-title">Sistema de N√≥mina</div>
          <div class="brand-subtitle">Cielito Home</div>
        </div>
      </a>
      
      <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <i class="bi bi-list"></i>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <div class="navbar-nav ms-auto">
          <button onclick="toggleSalaryManager()" class="btn btn-nav me-2">
            <i class="bi bi-person-gear me-2"></i>
            <span class="btn-text">Gestionar Salarios</span>
          </button>
          <a href="admin.html" class="btn btn-nav">
            <i class="bi bi-arrow-left me-2"></i>
            <span class="btn-text">Panel Admin</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Modal de Validaci√≥n de Acceso -->
  <div class="modal fade" id="modalValidacionAcceso" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-warning">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title">
            <i class="bi bi-shield-lock me-2"></i>Acceso Restringido - Sistema de N√≥mina
          </h5>
        </div>
        <div class="modal-body text-center">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>√Årea de Alta Seguridad</strong>
          </div>
          <p class="mb-4">Esta secci√≥n contiene informaci√≥n financiera confidencial de empleados.</p>
          
          <div class="mb-3">
            <label class="form-label">Contrase√±a de Acceso:</label>
            <input type="password" id="passwordNomina" class="form-control text-center" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="20">
          </div>
          
          <div class="text-muted small">
            <i class="bi bi-info-circle me-1"></i>
            Solo personal autorizado de Recursos Humanos y Direcci√≥n General
          </div>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-success" onclick="validarAccesoNomina()">
            <i class="bi bi-unlock me-2"></i>Validar Acceso
          </button>
          <button type="button" class="btn btn-secondary" onclick="regresarAdmin()">
            <i class="bi bi-arrow-left me-2"></i>Regresar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenedor Principal -->
  <div class="container main-container">
    
    <!-- Gesti√≥n de Salarios Individuales -->
    <div id="salaryManager" class="salary-config" style="display: none;">
      <h4><i class="bi bi-person-gear me-2"></i>Gesti√≥n de Salarios Individuales</h4>
      
      <!-- Selector de empleado -->
      <div class="row mb-3">
        <div class="col-md-8">
          <label class="form-label">Seleccionar Empleado</label>
          <select id="employeeSelect" class="form-select">
            <option value="">Seleccionar empleado...</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">&nbsp;</label>
          <button onclick="loadEmployeeSalary()" class="btn btn-info w-100">
            <i class="bi bi-person-check me-2"></i>Cargar Datos
          </button>
        </div>
      </div>

      <!-- Formulario de configuraci√≥n de empleado (oculto inicialmente) -->
      <div id="employeeSalaryForm" style="display: none;">
        
        <!-- Configuraci√≥n salarial -->
        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label">Salario por Per√≠odo (10 d√≠as)</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" id="individualSalary" class="form-control" min="0" step="100" placeholder="3000">
              <span class="input-group-text">.00</span>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Horas por Per√≠odo (referencia)</label>
            <input type="number" id="individualHours" class="form-control" min="1" max="80" placeholder="40">
            <small class="text-muted">Solo para referencia, el pago es por d√≠a</small>
          </div>
          <div class="col-md-4">
            <label class="form-label">Pago por D√≠a</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" id="dailyRate" class="form-control" readonly>
              <span class="input-group-text">.00</span>
            </div>
          </div>
        </div>

        <!-- Beneficios -->
        <div class="row mb-3">
          <div class="col-md-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="tieneIMSS">
              <label class="form-check-label" for="tieneIMSS">
                <strong>Tiene IMSS</strong> <small class="text-muted">(-$300)</small>
              </label>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="tieneCajaAhorro" onchange="toggleCajaAhorro()">
              <label class="form-check-label" for="tieneCajaAhorro">
                <strong>Caja de Ahorro</strong>
              </label>
            </div>
          </div>
          <div class="col-md-3" id="cajaAhorroOptions" style="display: none;">
            <label class="form-label">Monto Quincenal</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" id="montoCajaAhorro" class="form-control" min="0" step="50">
              <span class="input-group-text">.00</span>
            </div>
          </div>
        </div>

        <!-- Datos Bancarios -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Cuenta Bancaria</label>
            <input type="text" id="cuentaBancaria" class="form-control" placeholder="1234567890">
          </div>
          <div class="col-md-6">
            <label class="form-label">Banco</label>
            <select id="nombreBanco" class="form-select">
              <option value="">Seleccionar banco...</option>
              <option value="BBVA">BBVA</option>
              <option value="Santander">Santander</option>
              <option value="Banamex">Banamex</option>
              <option value="Banorte">Banorte</option>
              <option value="HSBC">HSBC</option>
              <option value="Scotiabank">Scotiabank</option>
              <option value="Azteca">Banco Azteca</option>
              <option value="Inbursa">Inbursa</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
        </div>

        <!-- Botones de acci√≥n -->
        <div class="d-flex gap-2">
          <button onclick="saveEmployeeSalary()" class="btn btn-success">
            <i class="bi bi-floppy me-2"></i>Guardar Configuraci√≥n
          </button>
          <button onclick="clearEmployeeSalary()" class="btn btn-outline-danger">
            <i class="bi bi-trash me-2"></i>Limpiar
          </button>
        </div>
      </div>
    </div>

    <!-- Dashboard Caja de Ahorro -->
    <div id="cajaAhorroDashboard" class="row mt-3" style="display: none;">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-piggy-bank me-2"></i>Dashboard Caja de Ahorro
            </h5>
          </div>
          <div class="card-body">
            <div class="row" id="cajaAhorroStats">
              <!-- Se llena din√°micamente -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Selector de Per√≠odo Principal -->
    <div class="period-selector">
      <h4><i class="bi bi-calendar3 me-2"></i>Configuraci√≥n de N√≥mina</h4>
      <div class="row">
        <div class="col-md-3">
          <label class="form-label">Mes y A√±o</label>
          <input type="month" id="monthSelect" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Tipo de N√≥mina</label>
          <select id="tipoNominaCalculo" class="form-select">
            <option value="quincenal">üìÖ N√≥mina Quincenal</option>
            <option value="semanal">üìÜ N√≥mina Semanal</option>
          </select>
        </div>
        <div class="col-md-3" id="selectorPeriodo">
          <label class="form-label">Quincena</label>
          <select id="quinceSelect" class="form-select">
            <option value="primera">Primera Quincena (1-15)</option>
            <option value="segunda">Segunda Quincena (16-fin de mes)</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">&nbsp;</label>
          <button onclick="calcularNomina()" class="btn btn-success btn-lg w-100">
            <i class="bi bi-calculator me-2"></i>Calcular N√≥mina
          </button>
        </div>
      </div>
    </div>

    <!-- Resumen General -->
    <div id="summaryCard" class="summary-card" style="display: none;">
      <div class="summary-stats">
        <div class="summary-stat">
          <h4 class="mb-0"><i class="bi bi-graph-up me-2"></i>Resumen General</h4>
        </div>
        <div class="summary-stat">
          <span id="totalEmployees" class="summary-number">0</span>
          <div class="summary-label">Empleados</div>
        </div>
        <div class="summary-stat">
          <span id="totalRetards" class="summary-number">0</span>
          <div class="summary-label">Retardos Totales</div>
        </div>
        <div class="summary-stat">
          <span id="employeesWithPenalty" class="summary-number">0</span>
          <div class="summary-label">Con Descuento</div>
        </div>
        <div class="summary-stat">
          <span id="totalPayout" class="summary-number">$0</span>
          <div class="summary-label">Total a Pagar</div>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div id="loadingSpinner" class="loading-spinner text-center" style="display: none;">
      <div class="spinner-border text-primary" role="status"></div>
      <span class="ms-3">Calculando n√≥mina...</span>
    </div>

    <!-- Controles de Vista -->
    <div id="viewControls" class="view-controls" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Resultados de N√≥mina</h5>
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-outline-primary active" id="btnVistaCompacta" onclick="cambiarVista('compacta')">
            <i class="bi bi-grid-3x2 me-1"></i>Compacta
          </button>
          <button type="button" class="btn btn-outline-primary" id="btnVistaTabla" onclick="cambiarVista('tabla')">
            <i class="bi bi-table me-1"></i>Tabla
          </button>
        </div>
      </div>
    </div>

    <!-- Vista Compacta (Default) -->
    <div id="resultsContainer" class="employee-grid-compact"></div>

    <!-- Vista de Tabla -->
    <div id="tableContainer" class="table-responsive" style="display: none;">
      <table class="table table-hover nomina-table">
        <thead>
          <tr>
            <th>Empleado</th>
            <th>Tipo</th>
            <th>D√≠as</th>
            <th>Retardos</th>
            <th>Faltas</th>
            <th>Descuento</th>
            <th>Pago Final</th>
            <th>Estado</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Se llena din√°micamente -->
        </tbody>
      </table>
    </div>

    <!-- Botones de Acci√≥n -->
    <div id="actionButtons" class="d-flex gap-2 mt-3" style="display: none;">
      <button id="saveBtn" class="btn btn-success" onclick="guardarNominaCompleta()">
        <i class="bi bi-floppy me-2"></i>Guardar N√≥mina
      </button>
      <button id="exportBtn" class="btn btn-primary" onclick="exportarExcel()">
        <i class="bi bi-file-earmark-spreadsheet me-2"></i>Exportar Excel
      </button>
      <button class="btn btn-info" onclick="generarTodosLosPDFs()">
        <i class="bi bi-file-earmark-pdf me-2"></i>Generar Todos los PDFs
      </button>
    </div>

    <!-- Modal para Editar N√≥mina Manual -->
    <div class="modal fade" id="modalEditarNomina" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-pencil-square me-2"></i>Editar N√≥mina Manual
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Edici√≥n Manual:</strong> Los cambios aqu√≠ tienen prioridad sobre el sistema autom√°tico.
            </div>
            
            <form id="formEditarNomina">
              <input type="hidden" id="editEmpleadoId">
              
              <!-- Informaci√≥n del empleado -->
              <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                  <h6 class="mb-0" id="editEmpleadoNombre">Empleado</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <span class="badge bg-secondary" id="editEmpleadoTipo">Tipo</span>
                      <span class="badge bg-success ms-2" id="editSalarioBase">$0</span>
                    </div>
                    <div class="col-md-6 text-end">
                      <small class="text-muted">Per√≠odo: <span id="editPeriodo"></span></small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Ajustes de asistencia -->
              <div class="row mb-3">
                <div class="col-md-3">
                  <label class="form-label">D√≠as Trabajados</label>
                  <input type="number" id="editDiasTrabajados" class="form-control" min="0" max="15">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Retardos</label>
                  <input type="number" id="editRetardos" class="form-control" min="0" max="20">
                </div>
                <div class="col-md-3">
                  <label class="form-label">D√≠as Extra (S√°bados)</label>
                  <input type="number" id="editDiasExtra" class="form-control" min="0" max="5">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Bono Extra ($)</label>
                  <input type="number" id="editBonoExtra" class="form-control" min="0" step="50">
                </div>
              </div>

              <!-- Justificantes -->
              <div class="row mb-3">
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="tieneVacaciones">
                    <label class="form-check-label" for="tieneVacaciones">
                      <strong>Vacaciones</strong>
                    </label>
                  </div>
                  <input type="number" id="diasVacaciones" class="form-control mt-2" min="0" max="10" placeholder="D√≠as" disabled>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="tieneIncapacidad">
                    <label class="form-check-label" for="tieneIncapacidad">
                      <strong>Incapacidad</strong>
                    </label>
                  </div>
                  <input type="number" id="diasIncapacidad" class="form-control mt-2" min="0" max="10" placeholder="D√≠as" disabled>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="tieneViaje">
                    <label class="form-check-label" for="tieneViaje">
                      <strong>Viaje de Negocios</strong>
                    </label>
                  </div>
                  <input type="number" id="diasViaje" class="form-control mt-2" min="0" max="10" placeholder="D√≠as" disabled>
                </div>
              </div>

              <!-- Comentarios -->
              <div class="mb-3">
                <label class="form-label">Comentarios/Observaciones</label>
                <textarea id="editComentarios" class="form-control" rows="3" placeholder="Ejemplo: Empleado estuvo en viaje de negocios"></textarea>
              </div>

              <!-- Vista previa del c√°lculo -->
              <div class="card bg-light">
                <div class="card-header">
                  <h6 class="mb-0"><i class="bi bi-calculator me-2"></i>Vista Previa del C√°lculo</h6>
                </div>
                <div class="card-body">
                  <div class="row" id="previaCalculo">
                    <!-- Se llena din√°micamente -->
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnGuardarEdicion">
              <i class="bi bi-save me-2"></i>Guardar Cambios
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- Firebase Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, setDoc, getDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD2o2FyUwVZafKIv-qtM6fmA663ldB_1Uo",
      authDomain: "qr-acceso-cielito-home.firebaseapp.com",
      projectId: "qr-acceso-cielito-home",
      storageBucket: "qr-acceso-cielito-home.appspot.com",
      messagingSenderId: "229634415256",
      appId: "1:229634415256:web:c576ba8879e58e441c4eed"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let empleadosGlobales = [];
    let resultadosNomina = [];
    let cambiosManuales = {};
    let historialCambios = [];

    // Variables globales para el per√≠odo actual
    let quinceActual = '';
    let mesActual = '';
    let mesActualNum = 0;
    let a√±oActualNum = 0;

    // Sistema de validaci√≥n de acceso
    let accesoAutorizado = false;
    const PASSWORD_NOMINA = 'CIELITO2026RH';
    const EMAILS_NOMINA_AUTORIZADOS = [
      'sistemas16ch@gmail.com',
      'sistemas16cielitohome@gmail.com',
      'leticia@cielitohome.com',
      'sistemas@cielitohome.com',
      'direcciongeneral@cielitohome.com'
    ];

    // Configurar fecha actual por defecto
    const hoy = new Date();
    document.getElementById('monthSelect').value = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;

    // Funci√≥n para formatear n√∫meros con comas
    function formatearNumero(numero) {
      return numero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Sistema de notificaciones
    function mostrarNotificacion(mensaje, tipo = 'info', duracion = 4000) {
      const existingNotifications = document.querySelectorAll('.custom-notification');
      existingNotifications.forEach(notif => notif.remove());

      const notification = document.createElement('div');
      notification.className = `custom-notification notification-${tipo}`;
      
      const iconos = {
        'success': 'bi-check-circle-fill',
        'error': 'bi-x-circle-fill',
        'warning': 'bi-exclamation-triangle-fill',
        'info': 'bi-info-circle-fill'
      };

      notification.innerHTML = `
        <div class="notification-content">
          <div class="notification-icon">
            <i class="bi ${iconos[tipo] || iconos.info}"></i>
          </div>
          <div class="notification-message">${mensaje}</div>
          <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="notification-progress"></div>
      `;

      document.body.appendChild(notification);
      setTimeout(() => notification.classList.add('show'), 100);

      if (duracion > 0) {
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 300);
        }, duracion);
      }
    }

    // Verificar autenticaci√≥n
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      if (!EMAILS_NOMINA_AUTORIZADOS.includes(user.email)) {
        mostrarNotificacion('No tienes permisos para acceder a esta secci√≥n', 'error');
        setTimeout(() => window.location.href = 'admin.html', 2000);
        return;
      }

      // Inicializar validaci√≥n de acceso
      inicializarValidacionAcceso();
    });

    // ===== SISTEMA DE VALIDACI√ìN DE ACCESO =====
    function inicializarValidacionAcceso() {
      // Mostrar modal de validaci√≥n inmediatamente
      const modal = new bootstrap.Modal(document.getElementById('modalValidacionAcceso'));
      modal.show();
      
      // Enter key en campo password
      document.getElementById('passwordNomina').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          validarAccesoNomina();
        }
      });
    }

    window.validarAccesoNomina = function() {
      const password = document.getElementById('passwordNomina').value;
      const modal = document.getElementById('modalValidacionAcceso');
      
      if (password === PASSWORD_NOMINA) {
        // Acceso autorizado
        accesoAutorizado = true;
        
        // Cerrar modal
        bootstrap.Modal.getInstance(modal).hide();
        
        // Inicializar sistema
        cargarEmpleados();
        
        mostrarNotificacion('‚úÖ Acceso autorizado al Sistema de N√≥mina', 'success');
        
      } else {
        // Acceso denegado
        modal.classList.add('acceso-denegado');
        document.getElementById('passwordNomina').value = '';
        document.getElementById('passwordNomina').focus();
        
        setTimeout(() => modal.classList.remove('acceso-denegado'), 500);
        mostrarNotificacion('‚ùå Contrase√±a incorrecta', 'error');
      }
    };

    window.regresarAdmin = function() {
      window.location.href = 'admin.html';
    };

    // Middleware para funciones sensibles
    function validarAccesoAutorizado() {
      if (!accesoAutorizado) {
        mostrarNotificacion('‚ùå Acceso no autorizado', 'error');
        return false;
      }
      return true;
    }

    // ===== GESTI√ìN DE EMPLEADOS =====
    
    // Funci√≥n para cargar empleados
    async function cargarEmpleados() {
      try {
        const usuariosQuery = query(collection(db, "usuarios"));
        const usuariosSnapshot = await getDocs(usuariosQuery);
        
        empleadosGlobales = [];
        const select = document.getElementById('employeeSelect');
        select.innerHTML = '<option value="">Seleccionar empleado...</option>';
        
        usuariosSnapshot.forEach(doc => {
          const userData = doc.data();
          empleadosGlobales.push({
            uid: doc.id,
            ...userData
          });
          
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = `${userData.nombre} (${userData.tipo || 'Sin tipo'})`;
          select.appendChild(option);
        });
        
        await actualizarDashboardCajaAhorro();
        
      } catch (error) {
        console.error('Error cargando empleados:', error);
        mostrarNotificacion('Error al cargar empleados', 'error');
      }
    }

    // Gesti√≥n de salarios individuales
    window.toggleSalaryManager = function() {
      const manager = document.getElementById('salaryManager');
      manager.style.display = manager.style.display === 'none' ? 'block' : 'none';
    };

    window.loadEmployeeSalary = function() {
      const employeeId = document.getElementById('employeeSelect').value;
      if (!employeeId) {
        mostrarNotificacion('Selecciona un empleado primero', 'warning');
        return;
      }

      const empleado = empleadosGlobales.find(emp => emp.uid === employeeId);
      if (!empleado) {
        mostrarNotificacion('Empleado no encontrado', 'error');
        return;
      }

      // Mostrar el formulario
      document.getElementById('employeeSalaryForm').style.display = 'block';
      
      // Cargar datos del empleado
      document.getElementById('individualSalary').value = empleado.salarioQuincenal || '';
      document.getElementById('individualHours').value = empleado.horasQuincenal || '';
      document.getElementById('tieneIMSS').checked = empleado.tieneIMSS || false;
      document.getElementById('tieneCajaAhorro').checked = empleado.tieneCajaAhorro || false;
      document.getElementById('montoCajaAhorro').value = empleado.montoCajaAhorro || '';
      document.getElementById('cuentaBancaria').value = empleado.cuentaBancaria || '';
      document.getElementById('nombreBanco').value = empleado.nombreBanco || '';
      
      toggleCajaAhorro();
      calcularPagoPorDia();
      
      mostrarNotificacion(`Datos cargados para: ${empleado.nombre}`, 'success');
    };

    // Funci√≥n para manejar caja de ahorro
    window.toggleCajaAhorro = function() {
      const checkbox = document.getElementById('tieneCajaAhorro');
      const options = document.getElementById('cajaAhorroOptions');
      options.style.display = checkbox.checked ? 'block' : 'none';
      
      if (!checkbox.checked) {
        document.getElementById('montoCajaAhorro').value = '';
      }
    };

    // Calcular pago por d√≠a autom√°ticamente
    document.getElementById('individualSalary').addEventListener('input', calcularPagoPorDia);
    document.getElementById('individualHours').addEventListener('input', calcularPagoPorDia);

    function calcularPagoPorDia() {
      const salary = parseFloat(document.getElementById('individualSalary').value) || 0;
      const dailyRate = salary / 10;
      document.getElementById('dailyRate').value = dailyRate.toFixed(2);
    }

    window.saveEmployeeSalary = async function() {
      if (!validarAccesoAutorizado()) return;

      const employeeId = document.getElementById('employeeSelect').value;
      const salary = parseFloat(document.getElementById('individualSalary').value);
      const hours = parseInt(document.getElementById('individualHours').value);
      const tieneIMSS = document.getElementById('tieneIMSS').checked;
      const tieneCajaAhorro = document.getElementById('tieneCajaAhorro').checked;
      const montoCajaAhorro = parseFloat(document.getElementById('montoCajaAhorro').value) || 0;
      const cuentaBancaria = document.getElementById('cuentaBancaria').value.trim();
      const nombreBanco = document.getElementById('nombreBanco').value;

      if (!employeeId || !salary || !hours) {
        mostrarNotificacion('Complete todos los campos obligatorios', 'warning');
        return;
      }

      if (tieneCajaAhorro && montoCajaAhorro <= 0) {
        mostrarNotificacion('Si participa en caja de ahorro, debe especificar el monto', 'warning');
        return;
      }

      try {
        const empleadoRef = doc(db, 'usuarios', employeeId);
        await updateDoc(empleadoRef, {
          salarioQuincenal: salary,
          horasQuincenal: hours,
          pagoPorHora: parseFloat((salary / (hours || 1)).toFixed(2)),
          pagoPorDia: parseFloat((salary / 10).toFixed(2)),
          tieneIMSS: tieneIMSS,
          tieneCajaAhorro: tieneCajaAhorro,
          montoCajaAhorro: tieneCajaAhorro ? montoCajaAhorro : 0,
          cuentaBancaria: cuentaBancaria || null,
          nombreBanco: nombreBanco || null
        });

        mostrarNotificacion('Configuraci√≥n guardada correctamente', 'success');
        await cargarEmpleados();
        await actualizarDashboardCajaAhorro();
        
        // Limpiar formulario
        document.getElementById('employeeSalaryForm').style.display = 'none';
        document.getElementById('employeeSelect').value = '';
        
      } catch (error) {
        console.error('Error guardando configuraci√≥n:', error);
        mostrarNotificacion('Error al guardar la configuraci√≥n', 'error');
      }
    };

    window.clearEmployeeSalary = async function() {
      const employeeId = document.getElementById('employeeSelect').value;
      if (!employeeId) return;

      if (!confirm('¬øEliminar configuraci√≥n de salario para este empleado?')) return;

      try {
        const empleadoRef = doc(db, 'usuarios', employeeId);
        await updateDoc(empleadoRef, {
          salarioQuincenal: null,
          horasQuincenal: null,
          pagoPorHora: null,
          pagoPorDia: null,
          tieneIMSS: false,
          tieneCajaAhorro: false,
          montoCajaAhorro: 0,
          cuentaBancaria: '',
          nombreBanco: ''
        });

        mostrarNotificacion('Configuraci√≥n eliminada correctamente', 'success');
        await cargarEmpleados();
        await actualizarDashboardCajaAhorro();
        document.getElementById('employeeSalaryForm').style.display = 'none';
        document.getElementById('employeeSelect').value = '';
      } catch (error) {
        console.error('Error eliminando configuraci√≥n:', error);
        mostrarNotificacion('Error al eliminar la configuraci√≥n', 'error');
      }
    };

    // Dashboard caja de ahorro
    async function actualizarDashboardCajaAhorro() {
      try {
        const empleadosConCaja = empleadosGlobales.filter(emp => emp.tieneCajaAhorro);
        
        if (empleadosConCaja.length === 0) {
          document.getElementById('cajaAhorroDashboard').style.display = 'none';
          return;
        }
        
        document.getElementById('cajaAhorroDashboard').style.display = 'block';
        
        let totalParticipantes = empleadosConCaja.length;
        let ahorroQuincenalTotal = empleadosConCaja.reduce((sum, emp) => sum + (emp.montoCajaAhorro || 0), 0);
        let ahorroMensualTotal = ahorroQuincenalTotal * 2;
        let ahorroAnualTotal = ahorroMensualTotal * 12;
        
        const statsContainer = document.getElementById('cajaAhorroStats');
        statsContainer.innerHTML = `
          <div class="col-md-3">
            <div class="stat-card text-center p-3">
              <h4 class="text-success">${totalParticipantes}</h4>
              <small class="text-muted">Participantes</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card text-center p-3">
              <h4 class="text-success">$${formatearNumero(ahorroQuincenalTotal)}</h4>
              <small class="text-muted">Por Quincena</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card text-center p-3">
              <h4 class="text-success">$${formatearNumero(ahorroMensualTotal)}</h4>
              <small class="text-muted">Por Mes</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card text-center p-3">
              <h4 class="text-success">$${formatearNumero(ahorroAnualTotal)}</h4>
              <small class="text-muted">Por A√±o</small>
            </div>
          </div>
        `;
        
        if (totalParticipantes > 0) {
          const detalleHTML = empleadosConCaja.map(emp => `
            <div class="col-md-6 mb-2">
              <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                <span><strong>${emp.nombre}</strong></span>
                <span class="badge bg-success">$${formatearNumero(emp.montoCajaAhorro || 0)}/quincena</span>
              </div>
            </div>
          `).join('');
          
          statsContainer.innerHTML += `
            <div class="col-md-12 mt-3">
              <h6><i class="bi bi-people me-2"></i>Detalle por Empleado:</h6>
              <div class="row">
                ${detalleHTML}
              </div>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Error actualizando dashboard caja de ahorro:', error);
      }
    }

    // ===== C√ÅLCULO DE N√ìMINA =====
    
    // Funci√≥n para calcular d√≠as laborales en per√≠odos
    function calcularDiasLaboralesPeriodo(a√±o, mes, periodo) {
      const diasLaborales = [];
      const ultimoDia = new Date(a√±o, mes, 0).getDate();
      
      for (let dia = 1; dia <= ultimoDia; dia++) {
        const fecha = new Date(a√±o, mes - 1, dia);
        const diaSemana = fecha.getDay();
        
        if (diaSemana >= 1 && diaSemana <= 5) {
          diasLaborales.push(dia);
        }
      }
      
      if (periodo === 'primera') {
        return diasLaborales.slice(0, 10);
      } else {
        return diasLaborales.slice(10, 20);
      }
    }

    function getTipoNombre(tipo) {
      switch(tipo) {
        case 'tiempo_completo': return 'T.Completo';
        case 'becario': return 'Becario';
        case 'horario_especial': return 'H.Especial';
        default: return tipo;
      }
    }

    // Funci√≥n principal para calcular n√≥mina
    window.calcularNomina = async function() {
      if (!validarAccesoAutorizado()) return;

      const monthSelect = document.getElementById('monthSelect').value;
      const quinceSelect = document.getElementById('quinceSelect').value;
      
      if (!monthSelect) {
        mostrarNotificacion('Selecciona un mes', 'warning');
        return;
      }

      mesActualNum = parseInt(monthSelect.split('-')[1]);
      a√±oActualNum = parseInt(monthSelect.split('-')[0]);
      quinceActual = quinceSelect === 'primera' ? 'Per√≠odo 1' : 'Per√≠odo 2';
      
      document.getElementById('loadingSpinner').style.display = 'block';
      document.getElementById('summaryCard').style.display = 'none';
      document.getElementById('resultsContainer').innerHTML = '';
      document.getElementById('actionButtons').style.display = 'none';

      try {
        const [a√±o, mes] = monthSelect.split('-');
        const mesNum = parseInt(mes);
        const a√±oNum = parseInt(a√±o);

        console.log(`üìÖ Calculando per√≠odo: ${quinceSelect} de ${mesNum}/${a√±oNum}`);

        const diasLaborales = calcularDiasLaboralesPeriodo(a√±oNum, mesNum, quinceSelect);
        
        console.log(`üìä D√≠as laborales del per√≠odo:`, diasLaborales);
        console.log(`üìä Total d√≠as laborales esperados: ${diasLaborales.length}`);

        // Consulta optimizada de empleados
        const usuariosQuery = query(collection(db, "usuarios"));
        const usuariosSnapshot = await getDocs(usuariosQuery);
        
        const empleados = [];
        usuariosSnapshot.forEach(doc => {
          const userData = doc.data();
          
          if (!userData || !userData.nombre) {
            console.warn('‚ö†Ô∏è Usuario sin datos v√°lidos:', doc.id);
            return;
          }
          
          if (userData.salarioQuincenal && userData.horasQuincenal) {
            empleados.push({
              uid: doc.id,
              nombre: userData.nombre,
              email: userData.email || 'sin-email@cielitohome.com',
              tipo: userData.tipo || 'tiempo_completo',
              salarioQuincenal: userData.salarioQuincenal,
              horasQuincenal: userData.horasQuincenal,
              pagoPorDia: userData.salarioQuincenal / 10,
              tieneIMSS: userData.tieneIMSS || false,
              tieneCajaAhorro: userData.tieneCajaAhorro || false,
              montoCajaAhorro: userData.montoCajaAhorro || 0,
              cuentaBancaria: userData.cuentaBancaria || '',
              nombreBanco: userData.nombreBanco || '',
              esIndividual: true
            });
          } else {
            console.warn('‚ö†Ô∏è Usuario sin configuraci√≥n salarial:', userData.nombre);
          }
        });

        if (empleados.length === 0) {
          mostrarNotificacion('‚ùå No hay empleados con salarios configurados.\n\nUse "Gestionar Salarios" para configurar los salarios de cada empleado.', 'error', 6000);
          document.getElementById('loadingSpinner').style.display = 'none';
          return;
        }

        console.log('üîç Consultando registros FILTRADOS POR FECHA...');
        
        // Consulta ultra optimizada: filtrar por fechas en Firestore
        const fechaInicio = `${a√±oNum}-${String(mesNum).padStart(2, '0')}-${String(Math.min(...diasLaborales)).padStart(2, '0')}`;
        const fechaFin = `${a√±oNum}-${String(mesNum).padStart(2, '0')}-${String(Math.max(...diasLaborales)).padStart(2, '0')}`;
        
        const registrosQuery = query(
          collection(db, "registros"),
          where("tipoEvento", "==", "entrada"),
          where("fecha", ">=", fechaInicio),
          where("fecha", "<=", fechaFin)
        );

        const registrosSnapshot = await getDocs(registrosQuery);
        console.log(`üìä Registros obtenidos (filtrados): ${registrosSnapshot.size}`);
        
        // Filtrado final en memoria solo por d√≠as laborales
        const registrosPorEmpleado = {};
        let registrosProcesados = 0;
        
        registrosSnapshot.forEach(doc => {
          const registro = doc.data();
          const uid = registro.uid;
          
          const fechaRegistro = registro.fecha;
          if (!fechaRegistro) return;
          
          const [regA√±o, regMes, regDia] = fechaRegistro.split('-').map(Number);
          
          // Filtro restrictivo en memoria
          if (regA√±o === a√±oNum && regMes === mesNum && diasLaborales.includes(regDia)) {
            if (!registrosPorEmpleado[uid]) {
              registrosPorEmpleado[uid] = [];
            }
            registrosPorEmpleado[uid].push(registro);
            registrosProcesados++;
          }
        });

        console.log(`üìä Registros procesados para el per√≠odo: ${registrosProcesados}`);

        // C√°lculo de n√≥mina
        const resultados = [];
        let totalRetardos = 0;
        let empleadosConDescuento = 0;
        let totalNominaFinal = 0;

        for (const empleado of empleados) {
          try {
            const registros = registrosPorEmpleado[empleado.uid] || [];
            
            const salarioQuincenal = empleado.salarioQuincenal;
            const pagoPorDia = empleado.pagoPorDia;

            let retardos = 0;
            let diasTrabajados = registros.length;
            const detalleRetardos = [];
            const diasAsistidos = [];

            registros.forEach(registro => {
              const [regA√±o, regMes, regDia] = registro.fecha.split('-').map(Number);
              diasAsistidos.push(regDia);
              
              if (registro.estado === 'retardo') {
                retardos++;
                detalleRetardos.push({
                  fecha: registro.fecha,
                  hora: registro.hora
                });
              }
            });

            const diasFaltantes = diasLaborales.filter(dia => !diasAsistidos.includes(dia));
            const diasDescuento = Math.floor(retardos / 4);
            const diasEfectivos = diasTrabajados - diasDescuento;
            const pagoTotal = Math.max(0, diasEfectivos * pagoPorDia);

            // Aplicar descuentos IMSS y Caja
            let descuentoIMSS = 0;
            let descuentoCaja = 0;
            
            if (empleado.tieneIMSS) {
              descuentoIMSS = 300;
            }
            
            if (empleado.tieneCajaAhorro && empleado.montoCajaAhorro) {
              descuentoCaja = empleado.montoCajaAhorro;
            }
            
            const totalDescuentos = descuentoIMSS + descuentoCaja;
            const pagoFinal = Math.max(0, pagoTotal - totalDescuentos);
            
            if (diasDescuento > 0 || totalDescuentos > 0) empleadosConDescuento++;
            totalRetardos += retardos;

            // Determinar estado
            let status, statusClass;
            if (diasFaltantes.length > 0) {
              status = `${diasFaltantes.length} falta${diasFaltantes.length > 1 ? 's' : ''} ‚Ä¢ ${retardos} retardo${retardos !== 1 ? 's' : ''}`;
              statusClass = 'status-penalty';
            } else if (diasDescuento > 0) {
              status = `Descuento: ${diasDescuento} d√≠a${diasDescuento > 1 ? 's' : ''}`;
              statusClass = 'status-penalty';
            } else if (retardos >= 3) {
              status = 'En l√≠mite de retardos';
              statusClass = 'status-warning';
            } else {
              status = 'Sin penalizaciones';
              statusClass = 'status-ok';
            }

            // Resultado final
            const resultado = {
              empleado,
              salarioQuincenal,
              diasLaboralesEsperados: diasLaborales.length,
              diasTrabajados,
              diasFaltantes: diasFaltantes.length,
              retardos,
              diasDescuento,
              diasEfectivos,
              pagoPorDia: Math.round(pagoPorDia),
              pagoTotal: Math.round(pagoTotal),
              descuentoIMSS,
              descuentoCaja,
              totalDescuentos,
              pagoFinal: Math.round(pagoFinal),
              status,
              statusClass,
              detalleRetardos,
              diasAsistidos,
              diasFaltantesDetalle: diasFaltantes
            };
            
            resultados.push(resultado);
            totalNominaFinal += Math.round(resultado.pagoFinal);
            
          } catch (error) {
            console.error(`‚ùå Error procesando empleado ${empleado.nombre}:`, error);
            mostrarNotificacion(`Error procesando ${empleado.nombre}, se omitir√°`, 'warning');
          }
        }

        // Actualizar variables globales
        quinceActual = quinceSelect === 'primera' ? 'Per√≠odo 1' : 'Per√≠odo 2';
        mesActual = `${mesNum}/${a√±oNum}`;
        mesActualNum = mesNum;
        a√±oActualNum = a√±oNum;

        resultadosNomina = resultados;

        mostrarResultados(resultados, empleados.length, totalRetardos, empleadosConDescuento, totalNominaFinal, quinceSelect, monthSelect);

      } catch (error) {
        console.error('Error calculando n√≥mina:', error);
        mostrarNotificacion('Error al calcular la n√≥mina: ' + error.message, 'error');
      } finally {
        document.getElementById('loadingSpinner').style.display = 'none';
      }
    };

    // Funci√≥n para mostrar resultados
    function mostrarResultados(resultados, totalEmpleados, totalRetardos, empleadosConDescuento, totalPago, periodo, mes) {
      // Actualizar resumen
      document.getElementById('totalEmployees').textContent = totalEmpleados;
      document.getElementById('totalRetards').textContent = totalRetardos;
      document.getElementById('employeesWithPenalty').textContent = empleadosConDescuento;
      document.getElementById('totalPayout').textContent = `$${formatearNumero(totalPago)}`;
      document.getElementById('summaryCard').style.display = 'block';
      document.getElementById('viewControls').style.display = 'block';
      document.getElementById('actionButtons').style.display = 'flex';

      // Limpiar contenedores
      document.getElementById('resultsContainer').innerHTML = '';
      document.getElementById('tableBody').innerHTML = '';

      // Mostrar vista compacta por defecto
      mostrarVistaCompacta(resultados);
      llenarTabla(resultados);
    }

    // ===== FUNCIONES AUXILIARES Y EXPORTACI√ìN =====
    
    // Funci√≥n para cambiar vista
    window.cambiarVista = function(tipo) {
      const compactaBtn = document.getElementById('btnVistaCompacta');
      const tablaBtn = document.getElementById('btnVistaTabla');
      const container = document.getElementById('resultsContainer');
      const tableContainer = document.getElementById('tableContainer');

      // Remover clase active
      [compactaBtn, tablaBtn].forEach(btn => btn.classList.remove('active'));

      if (tipo === 'compacta') {
        compactaBtn.classList.add('active');
        container.style.display = 'grid';
        tableContainer.style.display = 'none';
        container.className = 'employee-grid-compact';
        mostrarVistaCompacta(resultadosNomina);
      } else if (tipo === 'tabla') {
        tablaBtn.classList.add('active');
        container.style.display = 'none';
        tableContainer.style.display = 'block';
      }
    };

    // Vista compacta
    function mostrarVistaCompacta(resultados) {
      const container = document.getElementById('resultsContainer');
      container.innerHTML = '';

      resultados.forEach(resultado => {
        const empleadoCard = document.createElement('div');
        empleadoCard.className = 'employee-card-compact';
        empleadoCard.setAttribute('data-empleado-id', resultado.empleado.uid);

        const tipoNombre = getTipoNombre(resultado.empleado.tipo);
        const pagoFinalMostrar = resultado.pagoFinalConJustificaciones || resultado.pagoFinal;
        
        empleadoCard.innerHTML = `
          <div class="compact-header">
            <div class="compact-name">
              <strong>${resultado.empleado.nombre}</strong>
              <span class="badge bg-secondary ms-2">${tipoNombre}</span>
              ${resultado.editadoManualmente ? '<span class="badge bg-purple ms-1">E</span>' : ''}
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="abrirEdicionNomina('${resultado.empleado.uid}')">
              <i class="bi bi-pencil"></i>
            </button>
          </div>
          
          <div class="compact-stats">
            <div class="compact-stat">
              <span class="stat-value ${resultado.diasTrabajados < resultado.diasLaboralesEsperados ? 'text-warning' : 'text-success'}">${resultado.diasTrabajados}</span>
              <small>D√≠as</small>
            </div>
            <div class="compact-stat">
              <span class="stat-value ${resultado.retardos > 0 ? 'text-warning' : 'text-success'}">${resultado.retardos}</span>
              <small>Retardos</small>
            </div>
            <div class="compact-stat">
              <span class="stat-value ${resultado.diasFaltantes > 0 ? 'text-danger' : 'text-success'}">${resultado.diasFaltantes}</span>
              <small>Faltas</small>
            </div>
            <div class="compact-stat highlight">
              <span class="stat-value text-success">$${formatearNumero(pagoFinalMostrar)}</span>
              <small>Final</small>
            </div>
          </div>
          
          ${resultado.diasDescuento > 0 ? `
            <div class="descuento-badge">
              <div class="alert alert-warning py-2 mb-2">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Descuento: ${resultado.diasDescuento} d√≠a${resultado.diasDescuento > 1 ? 's' : ''}</strong>
                <small class="d-block">Por ${resultado.retardos} retardos (4 retardos = 1 d√≠a)</small>
              </div>
            </div>
          ` : ''}
          
          <div class="compact-details">
            <div class="compact-detail-row">
              <span class="detail-label">Subtotal:</span>
              <span class="detail-value">$${formatearNumero(resultado.pagoTotal)}</span>
            </div>
            
            ${resultado.descuentoIMSS > 0 ? `
              <div class="compact-detail-row discount">
                <span class="detail-label">IMSS:</span>
                <span class="detail-value text-danger">-$${resultado.descuentoIMSS}</span>
              </div>
            ` : ''}
            
            ${resultado.descuentoCaja > 0 ? `
              <div class="compact-detail-row discount">
                <span class="detail-label">Caja de ahorro:</span>
                <span class="detail-value text-danger">-$${formatearNumero(resultado.descuentoCaja)}</span>
              </div>
            ` : ''}
            
            ${resultado.diasDescuento > 0 ? `
              <div class="compact-detail-row discount">
                <span class="detail-label">Descuento por retardos:</span>
                <span class="detail-value text-warning">-${resultado.diasDescuento} d√≠a${resultado.diasDescuento > 1 ? 's' : ''}</span>
              </div>
              <div class="compact-detail-row discount">
                <span class="detail-label">Valor del descuento:</span>
                <span class="detail-value text-danger">-$${formatearNumero(resultado.diasDescuento * resultado.pagoPorDia)}</span>
              </div>
            ` : ''}

            ${resultado.diasFaltantes > 0 ? `
              <div class="compact-detail-row discount">
                <span class="detail-label">Faltas:</span>
                <span class="detail-value text-warning">-${resultado.diasFaltantes} d√≠a${resultado.diasFaltantes > 1 ? 's' : ''}</span>
              </div>
              <div class="compact-detail-row discount">
                <span class="detail-label">Valor de las faltas:</span>
                <span class="detail-value text-danger">-$${formatearNumero(resultado.diasFaltantes * resultado.pagoPorDia)}</span>
              </div>
            ` : ''}
            
            <div class="compact-detail-row final">
              <span class="detail-label"><strong>PAGO FINAL:</strong></span>
              <span class="detail-value text-success"><strong>$${formatearNumero(pagoFinalMostrar)}</strong></span>
            </div>
          </div>
          
          <div class="compact-status ${resultado.statusClass}">
            ${resultado.diasDescuento > 0 ? 
              resultado.diasFaltantes > 0 ? 
                `${resultado.diasFaltantes} falta${resultado.diasFaltantes > 1 ? 's' : ''} ‚Ä¢ Sin penalizaciones adicionales` :
                `Sin penalizaciones adicionales` :
              resultado.status
            }
          </div>
        `;

        container.appendChild(empleadoCard);
      });
    }

    // Funci√≥n para llenar la vista de tabla
    function llenarTabla(resultados) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      resultados.forEach(resultado => {
        const row = document.createElement('tr');
        const tipoNombre = getTipoNombre(resultado.empleado.tipo);
        const pagoFinalMostrar = resultado.pagoFinalConJustificaciones || resultado.pagoFinal;

        // Crear tooltip para descuentos
        let descuentosTooltip = [];
        if (resultado.descuentoIMSS > 0) descuentosTooltip.push(`IMSS: $${formatearNumero(resultado.descuentoIMSS)}`);
        if (resultado.descuentoCaja > 0) descuentosTooltip.push(`Caja: $${formatearNumero(resultado.descuentoCaja)}`);
        if (resultado.diasDescuento > 0) descuentosTooltip.push(`${resultado.diasDescuento} d√≠a(s) por retardos`);

        const descuentosTexto = descuentosTooltip.length > 0 ? descuentosTooltip.join(' ‚Ä¢ ') : 'Sin descuentos';

        row.innerHTML = `
          <td>
            <div class="fw-bold">${resultado.empleado.nombre}</div>
            ${resultado.editadoManualmente ? '<span class="badge bg-purple ms-1">Editado</span>' : ''}
          </td>
          <td>
            <span class="badge ${resultado.empleado.tipo === 'becario' ? 'bg-info' : 'bg-secondary'}">
              ${tipoNombre}
            </span>
          </td>
          <td class="text-center">
            <div class="pago-detalle">
              <strong>${resultado.diasTrabajados}/${resultado.diasLaboralesEsperados}</strong>
              ${resultado.diasTrabajados < resultado.diasLaboralesEsperados ? 
                `<small class="text-danger d-block">-${resultado.diasLaboralesEsperados - resultado.diasTrabajados} d√≠a(s)</small>` : 
                '<small class="text-success d-block">Completo</small>'
              }
            </div>
          </td>
          <td class="text-center">
            <span class="badge ${resultado.retardos > 0 ? 'bg-warning text-dark' : 'bg-success'}">
              ${resultado.retardos}
            </span>
            ${resultado.retardos > 0 && resultado.detalleRetardos && resultado.detalleRetardos.length > 0 ? 
              `<small class="d-block text-muted">${resultado.detalleRetardos.length} registro(s)</small>` : ''
            }
          </td>
          <td class="text-center">
            <span class="badge ${resultado.diasFaltantes > 0 ? 'bg-danger' : 'bg-success'}">
              ${resultado.diasFaltantes}
            </span>
            ${resultado.diasFaltantes > 0 ? 
              `<small class="text-danger d-block">-$${formatearNumero(resultado.diasFaltantes * resultado.pagoPorDia)}</small>` : 
              '<small class="text-success d-block">Sin faltas</small>'
            }
          </td>
          <td class="descuentos-detalle" title="${descuentosTexto}">
            ${resultado.totalDescuentos > 0 ? `
              <div>
                <span class="badge bg-warning text-dark">$${formatearNumero(resultado.totalDescuentos)}</span>
                ${resultado.descuentoIMSS > 0 ? '<span class="badge bg-info ms-1">IMSS</span>' : ''}
                ${resultado.descuentoCaja > 0 ? '<span class="badge bg-success ms-1">Caja</span>' : ''}
                ${resultado.diasDescuento > 0 ? `<span class="badge bg-warning ms-1">${resultado.diasDescuento}d</span>` : ''}
              </div>
            ` : `
              <span class="text-success">Sin descuentos</span>
            `}
          </td>
          <td class="text-end">
            <div class="pago-detalle">
              <strong class="text-success">$${formatearNumero(pagoFinalMostrar)}</strong>
              <small class="text-muted d-block">Base: $${formatearNumero(resultado.pagoTotal)}</small>
            </div>
          </td>
          <td class="text-center">
            <span class="badge bg-${resultado.statusClass === 'status-ok' ? 'success' : 
                                     resultado.statusClass === 'status-warning' ? 'warning text-dark' : 'danger'}">
              ${resultado.statusClass === 'status-ok' ? 'OK' : 
                resultado.statusClass === 'status-warning' ? 'Alerta' : 'Penalizaci√≥n'}
            </span>
            <small class="d-block text-muted mt-1" style="font-size: 0.7rem;">
              ${resultado.status}
            </small>
          </td>
          <td class="text-center">
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-primary" onclick="abrirEdicionNomina('${resultado.empleado.uid}')" title="Editar n√≥mina">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-success" onclick="generarTicketPDF('${resultado.empleado.uid}')" title="Generar Ticket PDF">
                <i class="bi bi-file-earmark-pdf"></i>
              </button>
            </div>
          </td>
        `;

        // A√±adir clase de estado para la fila completa
        if (resultado.statusClass === 'status-penalty') {
          row.classList.add('bg-status-penalty');
        } else if (resultado.statusClass === 'status-warning') {
          row.classList.add('bg-status-warning');
        } else {
          row.classList.add('bg-status-ok');
        }

        tbody.appendChild(row);
      });
    }

    // Funci√≥n para exportar a Excel
    window.exportarExcel = function() {
      if (!validarAccesoAutorizado()) return;
      
      if (!resultadosNomina || resultadosNomina.length === 0) {
        mostrarNotificacion('No hay datos para exportar', 'warning');
        return;
      }

      try {
        console.log('üìä Iniciando exportaci√≥n Excel con', resultadosNomina.length, 'empleados');
        
        const datosExcel = resultadosNomina.map((resultado, index) => {
          const pagoFinal = resultado.pagoFinalConJustificaciones || resultado.pagoFinal;
          
          const cuentaBancaria = (resultado.empleado.cuentaBancaria && resultado.empleado.cuentaBancaria.trim() !== '') 
            ? resultado.empleado.cuentaBancaria.trim() 
            : 'No registrada';
            
          const nombreBanco = (resultado.empleado.nombreBanco && resultado.empleado.nombreBanco.trim() !== '') 
            ? resultado.empleado.nombreBanco.trim() 
            : 'No especificado';
          
          return {
            // Informaci√≥n b√°sica del empleado
            'Empleado': resultado.empleado.nombre || 'Sin nombre',
            'Email': resultado.empleado.email || 'No registrado',
            'Tipo': getTipoNombre(resultado.empleado.tipo),
            
            // üí≥ DATOS BANCARIOS
            'Cuenta Bancaria': cuentaBancaria,
            'Banco': nombreBanco,
            
            // Configuraci√≥n salarial
            'Salario Base Quincenal': resultado.salarioQuincenal || 0,
            'Pago por D√≠a': resultado.pagoPorDia || 0,
            
            // Asistencia
            'D√≠as Esperados': resultado.diasLaboralesEsperados || 0,
            'D√≠as Trabajados': resultado.diasTrabajados || 0,
            'D√≠as Efectivos': resultado.diasEfectivos || 0,
            'Retardos': resultado.retardos || 0,
            'Faltas': resultado.diasFaltantes || 0,
            'D√≠as de Descuento por Retardos': resultado.diasDescuento || 0,
            
            // C√°lculos financieros
            'Subtotal Bruto': resultado.pagoTotal || 0,
            'Descuento IMSS': resultado.descuentoIMSS || 0,
            'Descuento Caja de Ahorro': resultado.descuentoCaja || 0,
            'Total Descuentos': resultado.totalDescuentos || 0,
            'PAGO FINAL': pagoFinal || 0,
            
            // Informaci√≥n adicional
            'Estado': resultado.status || 'Sin estado',
            'Editado Manualmente': resultado.editadoManualmente ? 'S√≠' : 'NO',
            'Comentarios': resultado.comentariosEdicion || 'Sin comentarios',
            
            // Beneficios
            'Tiene IMSS': resultado.empleado.tieneIMSS ? 'S√≠' : 'NO',
            'Participa en Caja de Ahorro': resultado.empleado.tieneCajaAhorro ? 'S√≠' : 'NO',
            'Monto Caja de Ahorro': resultado.empleado.montoCajaAhorro || 0
          };
        });

        // Crear hoja de c√°lculo
        const ws = XLSX.utils.json_to_sheet(datosExcel);
        const wb = XLSX.utils.book_new();
        
        // Configurar anchos de columnas
        const columnWidths = [
          { wch: 25 }, // Empleado
          { wch: 30 }, // Email  
          { wch: 15 }, // Tipo
          { wch: 20 }, // Cuenta Bancaria
          { wch: 15 }, // Banco
          { wch: 18 }, // Salario Base
          { wch: 12 }, // Pago por D√≠a
          { wch: 12 }, // D√≠as Esperados
          { wch: 12 }, // D√≠as Trabajados
          { wch: 12 }, // D√≠as Efectivos
          { wch: 10 }, // Retardos
          { wch: 10 }, // Faltas
          { wch: 15 }, // D√≠as Descuento
          { wch: 15 }, // Subtotal Bruto
          { wch: 12 }, // Descuento IMSS
          { wch: 18 }, // Descuento Caja
          { wch: 15 }, // Total Descuentos
          { wch: 15 }, // PAGO FINAL
          { wch: 20 }, // Estado
          { wch: 15 }, // Editado
          { wch: 30 }, // Comentarios
          { wch: 12 }, // Tiene IMSS
          { wch: 20 }, // Caja de Ahorro
          { wch: 15 }  // Monto Caja
        ];
        
        ws['!cols'] = columnWidths;
        
        // Agregar hoja al libro
        XLSX.utils.book_append_sheet(wb, ws, "N√≥mina");

        // Nombre de archivo mejorado
        const fecha = new Date().toISOString().split('T')[0];
        const periodoLimpio = quinceActual.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
        const mesLimpio = mesActual.replace(/[^a-zA-Z0-9_]/g, '_');
        const nombreArchivo = `Nomina_${periodoLimpio}_${mesLimpio}_${fecha}.xlsx`;
        
        console.log('üíæ Guardando archivo:', nombreArchivo);
        
        // Guardar archivo
        XLSX.writeFile(wb, nombreArchivo);
        
        // Notificaci√≥n detallada
        const empleadosConCuenta = datosExcel.filter(emp => 
          emp['Cuenta Bancaria'] !== 'No registrada'
        ).length;
        
        mostrarNotificacion(
          `‚úÖ Archivo Excel exportado exitosamente\n\n` +
          `üìÑ Archivo: ${nombreArchivo}\n` +
          `üë• ${datosExcel.length} empleados exportados\n` +
          `üí≥ ${empleadosConCuenta} con datos bancarios completos\n` +
          `üìä ${datosExcel.length - empleadosConCuenta} sin datos bancarios`, 
          'success', 
          6000
        );
        
      } catch (error) {
        console.error('‚ùå Error exportando Excel:', error);
        mostrarNotificacion('Error al exportar Excel: ' + error.message, 'error');
      }
    };

    // Funci√≥n para guardar n√≥mina completa
    window.guardarNominaCompleta = async function() {
      if (!validarAccesoAutorizado()) return;
      
      if (!resultadosNomina || resultadosNomina.length === 0) {
        mostrarNotificacion('No hay datos de n√≥mina para guardar', 'warning');
        return;
      }

      try {
        const nominaId = `${a√±oActualNum}-${String(mesActualNum).padStart(2, '0')}-${quinceActual.includes('1') ? 'primera' : 'segunda'}`;
        
        // Preparar datos para guardar
        const resumen = {
          totalEmpleados: Number(resultadosNomina.length) || 0,
          totalRetardos: Number(resultadosNomina.reduce((sum, r) => sum + (Number(r.retardos) || 0), 0)) || 0,
          empleadosConDescuento: Number(resultadosNomina.filter(r => (Number(r.diasDescuento) || 0) > 0 || (Number(r.totalDescuentos) || 0) > 0).length) || 0,
          totalBruto: Number(resultadosNomina.reduce((sum, r) => sum + (Number(r.pagoTotalConJustificaciones || r.pagoTotal) || 0), 0)) || 0,
          totalDescuentos: Number(resultadosNomina.reduce((sum, r) => sum + (Number(r.totalDescuentos) || 0), 0)) || 0,
          totalNeto: Number(resultadosNomina.reduce((sum, r) => sum + (Number(r.pagoFinalConJustificaciones || r.pagoFinal) || 0), 0)) || 0
        };

        // Preparar datos de empleados
        const empleados = {};
        resultadosNomina.forEach(resultado => {
          const cambiosManual = cambiosManuales[resultado.empleado.uid];
          
          const empleadoLimpio = {
            // Datos del empleado
            nombre: resultado.empleado.nombre || 'Sin nombre',
            email: resultado.empleado.email || 'sin-email@cielitohome.com',
            tipo: resultado.empleado.tipo || 'tiempo_completo',
            
            // Configuraci√≥n salarial
            salarioQuincenal: resultado.salarioQuincenal || 0,
            pagoPorDia: resultado.pagoPorDia || 0,
            tieneIMSS: Boolean(resultado.empleado.tieneIMSS),
            tieneCajaAhorro: Boolean(resultado.empleado.tieneCajaAhorro),
            montoCajaAhorro: Number(resultado.empleado.montoCajaAhorro) || 0,
            cuentaBancaria: String(resultado.empleado.cuentaBancaria || 'No especificada'),
            nombreBanco: String(resultado.empleado.nombreBanco || 'No especificado'),
            
            // Asistencia autom√°tica
            diasLaboralesEsperados: Number(resultado.diasLaboralesEsperados) || 0,
            diasTrabajados: Number(resultado.diasTrabajados) || 0,
            retardos: Number(resultado.retardos) || 0,
            diasFaltantes: Number(resultado.diasFaltantes) || 0,
            diasEfectivos: Number(resultado.diasEfectivos) || 0,
            diasAsistidos: Array.isArray(resultado.diasAsistidos) ? resultado.diasAsistidos : [],
            detalleRetardos: Array.isArray(resultado.detalleRetardos) ? resultado.detalleRetardos : [],
            
            // Descuentos autom√°ticos
            descuentoIMSS: Number(resultado.descuentoIMSS) || 0,
            descuentoCaja: Number(resultado.descuentoCaja) || 0,
            diasDescuentoPorRetardos: Number(resultado.diasDescuento) || 0,
            
            // Ediciones manuales
            editadoManualmente: Boolean(cambiosManual),
            diasExtra: Number(cambiosManual?.diasExtra) || 0,
            bonoExtra: Number(cambiosManual?.bonoExtra) || 0,
            diasJustificadosManual: Number(cambiosManual?.diasJustificados) || 0,
            comentariosEdicion: String(cambiosManual?.comentarios || ''),
            justificacionesDetalle: Array.isArray(cambiosManual?.justificacionesDetalle) ? cambiosManual.justificacionesDetalle : [],
            fechaEdicion: cambiosManual?.fechaEdicion || null,
            
            // C√°lculos finales
            pagoBase: Number(resultado.pagoTotal) || 0,
            pagoConJustificaciones: Number(resultado.pagoTotalConJustificaciones || resultado.pagoTotal) || 0,
            totalDescuentos: Number(resultado.totalDescuentos) || 0,
            pagoFinal: Number(resultado.pagoFinalConJustificaciones || resultado.pagoFinal) || 0,
            
            // Status
            status: String(resultado.status || 'Sin estado'),
            statusClass: String(resultado.statusClass || 'status-ok')
          };
          
          empleados[resultado.empleado.uid] = empleadoLimpio;
        });

        // Documento completo para guardar
        const nominaDocument = {
          id: String(nominaId),
          a√±o: Number(a√±oActualNum) || new Date().getFullYear(),
          mes: Number(mesActualNum) || new Date().getMonth() + 1,
          periodo: String(quinceActual.includes('1') ? 'primera' : 'segunda'),
          fechaCreacion: new Date(),
          fechaModificacion: new Date(),
          estado: "draft",
          
          // Configuraci√≥n del per√≠odo
          diasLaborales: Array.isArray(calcularDiasLaboralesPeriodo(a√±oActualNum, mesActualNum, quinceActual.includes('1') ? 'primera' : 'segunda')) ? 
                         calcularDiasLaboralesPeriodo(a√±oActualNum, mesActualNum, quinceActual.includes('1') ? 'primera' : 'segunda') : [],
          
          // Resumen y empleados
          resumen,
          empleados,
          
          // Metadatos
          calculadoPor: String(auth.currentUser?.email || 'sistema'),
          version: Number(1)
        };

        // Guardar en Firestore
        const nominaRef = doc(db, 'nominas', nominaId);
        await setDoc(nominaRef, nominaDocument);
        
        console.log('‚úÖ N√≥mina guardada:', nominaId);
        mostrarNotificacion(`‚úÖ N√≥mina guardada exitosamente\nID: ${nominaId}`, 'success');
        
        return nominaId;
        
      } catch (error) {
        console.error('Error guardando n√≥mina:', error);
        mostrarNotificacion('Error al guardar la n√≥mina en la base de datos', 'error');
        return null;
      }
    };

    // Funciones de edici√≥n manual y PDF (simplificadas por espacio)
    window.abrirEdicionNomina = function(empleadoId) {
      mostrarNotificacion('Funci√≥n de edici√≥n en desarrollo', 'info');
    };

    window.generarTicketPDF = function(empleadoId) {
      mostrarNotificacion('Funci√≥n de PDF en desarrollo', 'info');
    };

    window.generarTodosLosPDFs = function() {
      mostrarNotificacion('Funci√≥n de PDFs masivos en desarrollo', 'info');
    };

    // Proteger funciones cr√≠ticas
    const calcularNominaOriginal = window.calcularNomina;
    window.calcularNomina = function() {
      if (!validarAccesoAutorizado()) return;
      return calcularNominaOriginal();
    };

    const guardarNominaCompletaOriginal = window.guardarNominaCompleta;
    window.guardarNominaCompleta = function() {
      if (!validarAccesoAutorizado()) return;
      return guardarNominaCompletaOriginal();
    };

    const exportarExcelOriginal = window.exportarExcel;
    window.exportarExcel = function() {
      if (!validarAccesoAutorizado()) return;
      return exportarExcelOriginal();
    };

  </script>
</body>
</html>