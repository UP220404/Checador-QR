<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de N√≥mina | Cielito Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="nomina.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-dark navbar-nomina">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">
        <i class="bi bi-calculator me-2"></i>Sistema de N√≥mina - Cielito Home
      </span>
      <button class="btn btn-outline-light" onclick="volverAdmin()">
        <i class="bi bi-arrow-left me-2"></i>Volver al Panel
      </button>
    </div>
  </nav>

  <div class="nomina-container">
    <!-- Tabs de navegaci√≥n -->
    <div class="nomina-tabs">
      <ul class="nav nav-pills nav-fill" id="nominaTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="calculo-tab" data-bs-toggle="pill" data-bs-target="#calculo" type="button">
            <i class="bi bi-calculator me-2"></i>C√°lculo de N√≥mina
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="configuracion-tab" data-bs-toggle="pill" data-bs-target="#configuracion" type="button">
            <i class="bi bi-gear me-2"></i>Configuraci√≥n
          </button>
        </li>
      </ul>
    </div>

    <!-- Indicador visual de consultas -->
    <div id="consultaStatus" class="alert alert-success">
      <div class="row align-items-center">
        <div class="col-lg-8 col-md-7 mb-2 mb-md-0">
          <h6 class="mb-1"><i class="bi bi-shield-check me-2"></i>Sistema Optimizado Firebase</h6>
          <small id="consultaInfo">Una consulta por per√≠odo ‚Ä¢ L√≠mite mensual protegido</small>
        </div>
        <div class="col-lg-4 col-md-5 text-md-end text-center">
          <div class="d-flex align-items-center justify-content-center justify-content-md-end">
            <div class="me-3">
              <div class="fw-bold text-success" id="consultasHoy">0</div>
              <small class="text-muted d-none d-sm-block">Consultas hoy</small>
              <small class="text-muted d-block d-sm-none">Hoy</small>
            </div>
            <i class="bi bi-speedometer2 text-success" style="font-size: 1.5rem;"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug info -->
    <div id="debugInfo" class="alert alert-info d-none">
      <strong>Info de optimizaci√≥n:</strong>
      <div id="debugContent"></div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content fade-in" id="nominaTabContent">
      
      <!-- C√ÅLCULO DE N√ìMINA -->
      <div class="tab-pane fade show active" id="calculo" role="tabpanel">
        <!-- Selector de Per√≠odo -->
        <div class="period-selector">
          <div class="row align-items-end">
            <div class="col-md-3 col-sm-6 mb-3">
              <label class="form-label">Per√≠odo de N√≥mina:</label>
              <select id="tipoPeriodo" class="form-select">
                <option value="quincenal">Quincenal</option>
                <option value="semanal">Semanal</option>
              </select>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
              <label class="form-label">Fecha Inicio:</label>
              <input type="date" id="fechaInicio" class="form-control">
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
              <label class="form-label">Fecha Fin:</label>
              <input type="date" id="fechaFin" class="form-control">
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
              <button class="btn btn-calculate w-100" onclick="calcularNomina()" id="btnCalcular">
                <i class="bi bi-play-fill me-2"></i>Calcular N√≥mina
              </button>
            </div>
          </div>
        </div>

        <!-- Loading -->
        <div id="loadingNomina" class="loading-container d-none">
          <div class="loading-spinner"></div>
          <p class="loading-text">Calculando n√≥mina...</p>
          <small class="text-muted" id="loadingDetail"></small>
        </div>

        <!-- Warning por permisos -->
        <div id="warningPermisos" class="warning-container d-none">
          <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
          <h5 class="mt-3">Configuraci√≥n Manual Requerida</h5>
          <p>El sistema est√° usando solo los registros de asistencia disponibles.<br>
          Para c√°lculos completos, configura los salarios en la pesta√±a "Configuraci√≥n".</p>
        </div>

        <!-- Resumen de N√≥mina -->
        <div id="resumenNomina" class="payroll-summary d-none">
          <div class="row text-center">
            <div class="col-md-3">
              <h4 id="totalEmpleados">0</h4>
              <p class="mb-0">Empleados</p>
            </div>
            <div class="col-md-3">
              <h4 id="totalHoras">0</h4>
              <p class="mb-0">Horas Totales</p>
            </div>
            <div class="col-md-3">
              <h4 id="totalPago">$0.00</h4>
              <p class="mb-0">Total a Pagar</p>
            </div>
            <div class="col-md-3">
              <button class="btn btn-light" onclick="generarReporteNomina()">
                <i class="bi bi-file-pdf me-2"></i>Generar PDF
              </button>
            </div>
          </div>
        </div>

        <!-- Lista de Empleados -->
        <div id="listaEmpleados" class="row">
          <!-- Se llenar√° din√°micamente -->
        </div>
      </div>

      <!-- CONFIGURACI√ìN -->
      <div class="tab-pane fade" id="configuracion" role="tabpanel">
        <div class="config-card mb-4">
          <h4 class="mb-4 text-gradient">
            <i class="bi bi-person-gear me-2"></i>Configuraci√≥n de Empleados
          </h4>
          
          <!-- Info sobre configuraci√≥n manual -->
          <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Configuraci√≥n Manual:</strong> Debido a los permisos de Firebase, debes configurar manualmente los salarios por empleado. Los registros de asistencia se cargan autom√°ticamente con cache optimizado.
          </div>

          <!-- Agregar empleado manual -->
          <div class="mb-4 p-3 bg-light rounded" id="agregarEmpleadoManual">
            <h6>Agregar Empleado para N√≥mina:</h6>
            <div class="row g-2">
              <div class="col-md-4">
                <input type="text" class="form-control" id="nuevoEmpleadoNombre" placeholder="Nombre completo">
              </div>
              <div class="col-md-3">
                <input type="email" class="form-control" id="nuevoEmpleadoEmail" placeholder="Email">
              </div>
              <div class="col-md-3">
                <select class="form-select" id="nuevoEmpleadoTipo">
                  <option value="becario">Becario</option>
                  <option value="tiempo_completo">Tiempo Completo</option>
                  <option value="nayeli">Especial Nayeli</option>
                </select>
              </div>
              <div class="col-md-2">
                <button class="btn btn-success w-100" onclick="agregarEmpleadoManual()">
                  <i class="bi bi-plus"></i> Agregar
                </button>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <input type="text" id="filtroUsuarios" class="form-control" placeholder="Buscar empleado...">
          </div>

          <!-- Cache controls -->
          <div class="mb-3">
            <button class="btn btn-warning btn-sm me-2" onclick="limpiarCacheCompleto()">
              <i class="bi bi-trash me-1"></i>Limpiar Cache
            </button>
            <button class="btn btn-info btn-sm" onclick="toggleDebugInfo()">
              <i class="bi bi-bug me-1"></i>Debug Info
            </button>
            <small class="text-muted ms-2" id="cacheInfo">Cache info...</small>
          </div>

          <!-- Lista de configuraciones -->
          <div id="configUsuarios" class="row">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Detalle Empleado -->
  <div class="modal fade" id="modalDetalleEmpleado" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-person me-2"></i>Detalle de N√≥mina
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detalleEmpleadoContent">
          <!-- Se llenar√° din√°micamente -->
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Configuraci√≥n Usuario -->
  <div class="modal fade" id="modalConfigUsuario" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-gear me-2"></i>Configurar Empleado
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formConfigUsuario">
            <input type="hidden" id="configUserId">
            
            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input type="text" id="configNombre" class="form-control">
            </div>

            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" id="configEmail" class="form-control">
            </div>

            <div class="mb-3">
              <label class="form-label">Salario por Hora</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" id="configSalarioHora" class="form-control" step="0.01">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">Salario Mensual (opcional)</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" id="configSalarioMensual" class="form-control" step="0.01">
              </div>
              <small class="form-text text-muted">Si se especifica, se calcular√° autom√°ticamente el salario por hora seg√∫n el per√≠odo</small>
            </div>

            <div class="mb-3">
              <label class="form-label">Tipo de Pago</label>
              <select id="configTipoPago" class="form-select">
                <option value="quincenal">Quincenal</option>
                <option value="semanal">Semanal</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Horario Base</label>
              <select id="configHorarioBase" class="form-select">
                <option value="becario">Becario (5 horas - 8am a 1pm)</option>
                <option value="tiempo_completo">Tiempo Completo (8 horas - 8am a 4pm)</option>
                <option value="nayeli">Especial Nayeli (6 horas - 8am a 2pm)</option>
              </select>
            </div>

            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="configActivo" checked>
                <label class="form-check-label" for="configActivo">
                  Activo en n√≥mina
                </label>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="guardarConfigUsuario()">
            <i class="bi bi-save me-2"></i>Guardar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Super Admin -->
  <div class="modal fade" id="modalSuperAdmin" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title">
            <i class="bi bi-shield-exclamation me-2"></i>Consulta Adicional - Super Administrador
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>¬°Advertencia!</strong> Ya se realiz√≥ una consulta para este per√≠odo.
            <br>Consultas adicionales consumen l√≠mite mensual de Firebase.
          </div>
          
          <div class="mb-3">
            <p><strong>Per√≠odo:</strong> <span id="periodoConsultado"></span></p>
            <p><strong>√öltima consulta:</strong> <span id="fechaUltimaConsulta"></span></p>
            <p><strong>Registros en cache:</strong> <span id="registrosCache"></span></p>
          </div>

          <hr>

          <div class="mb-3">
            <label class="form-label">Contrase√±a de Super Administrador:</label>
            <input type="password" class="form-control" id="passwordSuperAdmin" 
                   placeholder="Ingresa la contrase√±a">
            <small class="form-text text-muted">Solo el administrador principal tiene esta contrase√±a</small>
          </div>

          <div class="alert alert-info">
            <small>
              <i class="bi bi-info-circle me-1"></i>
              Al autorizar esta consulta adicional, se realizar√° una nueva consulta a Firebase 
              y se actualizar√° el cache existente.
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Usar Cache Actual
          </button>
          <button type="button" class="btn btn-warning" onclick="autorizarConsultaAdicional()">
            <i class="bi bi-unlock me-2"></i>Autorizar Consulta
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toggle modo oscuro -->
  <button class="theme-toggle-nomina" id="themeToggle">
    <i class="bi bi-moon-fill"></i>
  </button>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      setDoc,
      serverTimestamp,
      query,
      where,
      orderBy,
      limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Configuraci√≥n Firebase
    const firebaseConfig = {
      authDomain: "qr-acceso-cielito-home.firebaseapp.com",
      projectId: "qr-acceso-cielito-home",
      storageBucket: "qr-acceso-cielito-home.appspot.com",
      messagingSenderId: "229634415256",
      appId: "1:229634415256:web:c576ba8879e58e441c4eed"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // **SISTEMA DE CONTROL + ANTI-SPAM**
    let calculandoNomina = false;
    let consultasRealizadas = 0;
    let ultimaConsulta = 0;
    const LIMITE_CONSULTAS_POR_MINUTO = 2;
    const MIN_TIEMPO_ENTRE_CONSULTAS = 30000; // 30 segundos m√≠nimo

    function puedeHacerConsulta() {
      const ahora = Date.now();
      const tiempoTranscurrido = ahora - ultimaConsulta;
      
      if (tiempoTranscurrido < MIN_TIEMPO_ENTRE_CONSULTAS) {
        console.log(`Consulta bloqueada - Esperar ${Math.ceil((MIN_TIEMPO_ENTRE_CONSULTAS - tiempoTranscurrido) / 1000)}s m√°s`);
        return false;
      }
      
      // Reset contador cada minuto
      if (tiempoTranscurrido > 60000) {
        consultasRealizadas = 0;
      }
      
      if (consultasRealizadas >= LIMITE_CONSULTAS_POR_MINUTO) {
        console.log('L√≠mite de consultas por minuto alcanzado');
        return false;
      }
      
      return true;
    }

    // **SISTEMA DE CONTROL DE CONSULTAS POR PER√çODO**
    const SUPER_ADMIN_PASSWORD = "CielitoAdmin2024!"; // Cambiar por contrase√±a segura
    let periodosConsultados = JSON.parse(localStorage.getItem('periodos_consultados')) || {};
    
    function obtenerPeriodoKey(fechaInicio, fechaFin) {
      return `${fechaInicio}_${fechaFin}`;
    }
    
    function yaSePidioEœÉœÑePeriodo(fechaInicio, fechaFin) {
      const periodoKey = obtenerPeriodoKey(fechaInicio, fechaFin);
      return periodosConsultados[periodoKey] !== undefined;
    }
    
    function registrarPeriodoConsultado(fechaInicio, fechaFin) {
      const periodoKey = obtenerPeriodoKey(fechaInicio, fechaFin);
      periodosConsultados[periodoKey] = {
        fechaConsulta: new Date().toISOString(),
        timestamp: Date.now()
      };
      localStorage.setItem('periodos_consultados', JSON.stringify(periodosConsultados));
      actualizarIndicadorConsultas();
    }
    
    function actualizarIndicadorConsultas() {
      const hoy = new Date().toDateString();
      const consultasHoy = Object.values(periodosConsultados).filter(p => 
        new Date(p.fechaConsulta).toDateString() === hoy
      ).length;
      
      const elementoConsultas = document.getElementById('consultasHoy');
      if (elementoConsultas) {
        elementoConsultas.textContent = `${consultasHoy}`;
      }
      
      const statusDiv = document.getElementById('consultaStatus');
      const infoSpan = document.getElementById('consultaInfo');
      
      if (statusDiv && infoSpan) {
        if (consultasHoy === 0) {
          statusDiv.className = 'alert alert-success';
          infoSpan.textContent = 'Sistema listo ‚Ä¢ Una consulta disponible por per√≠odo';
        } else {
          statusDiv.className = 'alert alert-warning';
          infoSpan.textContent = `${consultasHoy} consulta(s) realizadas hoy ‚Ä¢ Pr√≥ximas requieren autorizaci√≥n`;
        }
      }
    }

    function puedeHacerConsulta() {
      const ahora = Date.now();
      const tiempoTranscurrido = ahora - ultimaConsulta;
      
      if (tiempoTranscurrido < MIN_TIEMPO_ENTRE_CONSULTAS) {
        console.log(`üö´ Consulta bloqueada - Esperar ${Math.ceil((MIN_TIEMPO_ENTRE_CONSULTAS - tiempoTranscurrido) / 1000)}s m√°s`);
        return false;
      }
      
      // Reset contador cada minuto
      if (tiempoTranscurrido > 60000) {
        consultasRealizadas = 0;
      }
      
      if (consultasRealizadas >= LIMITE_CONSULTAS_POR_MINUTO) {
        console.log('üö´ L√≠mite de consultas por minuto alcanzado');
        return false;
      }
      
      return true;
    }

    function registrarConsulta() {
      consultasRealizadas++;
      ultimaConsulta = Date.now();
      console.log(`üìä Consulta #${consultasRealizadas} registrada`);
    }

    window.volverAdmin = function() {
      window.location.href = 'admin.html';
    };

    // Variables globales - CACHE MEJORADO
    let empleadosLocales = JSON.parse(localStorage.getItem('nomina_empleados')) || [];
    let registrosAsistencia = [];
    
    const HORARIOS_BASE = {
      becario: { horasDiarias: 5, inicio: "08:00", fin: "13:00" },
      tiempo_completo: { horasDiarias: 8, inicio: "08:00", fin: "16:00" },
      nayeli: { horasDiarias: 6, inicio: "08:00", fin: "14:00" }
    };

    // **CACHE PERSISTENTE - 24 HORAS EN LUGAR DE 5 MINUTOS**
    const CACHE_DURACION = 24 * 60 * 60 * 1000; // 24 horas
    
    function obtenerCacheKey(fechaInicio, fechaFin) {
      return `asistencia_${fechaInicio}_${fechaFin}`;
    }

    function obtenerDatosCache(cacheKey) {
      try {
        const cachedData = localStorage.getItem(cacheKey);
        if (!cachedData) return null;

        const cache = JSON.parse(cachedData);
        const ahora = Date.now();
        
        // Verificar si el cache sigue siendo v√°lido (24 horas)
        if (ahora - cache.timestamp < CACHE_DURACION) {
          console.log(`‚úÖ Cache v√°lido encontrado para ${cacheKey} (${Math.round((ahora - cache.timestamp) / 1000 / 60)} min de antig√ºedad)`);
          return cache.data;
        }
        
        console.log(`‚è∞ Cache expirado para ${cacheKey}`);
        localStorage.removeItem(cacheKey);
        return null;
        
      } catch (error) {
        console.error('Error leyendo cache:', error);
        return null;
      }
    }

    function guardarEnCache(cacheKey, data) {
      try {
        localStorage.setItem(cacheKey, JSON.stringify({
          timestamp: Date.now(),
          data: data,
          version: '1.1'
        }));
        console.log(`üíæ Datos guardados en cache: ${cacheKey}`);
      } catch (error) {
        console.error('Error guardando en cache:', error);
      }
    }

    // **DEBOUNCING PARA C√ÅLCULOS**
    let timeoutCalcular = null;
    
    function calcularNominaDebounced() {
      clearTimeout(timeoutCalcular);
      timeoutCalcular = setTimeout(() => {
        calcularNominaInternal();
      }, 1000); // 1 segundo de debounce
    }

    // MODO OSCURO PERSISTENTE
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (localStorage.getItem('nomina-theme') === 'dark' || (!localStorage.getItem('nomina-theme') && prefersDarkScheme.matches)) {
      document.body.classList.add('dark-mode');
      document.getElementById('themeToggle').innerHTML = '<i class="bi bi-sun-fill"></i>';
    }

    document.getElementById('themeToggle').addEventListener('click', () => {
      if (document.body.classList.contains('dark-mode')) {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('nomina-theme', 'light');
        document.getElementById('themeToggle').innerHTML = '<i class="bi bi-moon-fill"></i>';
      } else {
        document.body.classList.add('dark-mode');
        localStorage.setItem('nomina-theme', 'dark');
        document.getElementById('themeToggle').innerHTML = '<i class="bi bi-sun-fill"></i>';
      }
    });

    // Inicializaci√≥n OPTIMIZADA
    document.addEventListener('DOMContentLoaded', function() {
      inicializarSistema();
      configurarFechasPorDefecto();
      actualizarInfoCache();
      actualizarIndicadorConsultas(); // NUEVO: Actualizar indicadores visuales
    });

    // **LIMPIEZA DE CACHE SOLO CUANDO SEA NECESARIO**
    function limpiarCacheAntiguo() {
      const claves = Object.keys(localStorage);
      let cachesEliminados = 0;
      
      claves.forEach(key => {
        if (key.startsWith('asistencia_')) {
          try {
            const data = JSON.parse(localStorage.getItem(key));
            const ahora = Date.now();
            
            // Solo eliminar si tiene m√°s de 7 d√≠as (m√°s conservador)
            if (ahora - data.timestamp > 7 * 24 * 60 * 60 * 1000) {
              localStorage.removeItem(key);
              cachesEliminados++;
            }
          } catch (e) {
            localStorage.removeItem(key);
            cachesEliminados++;
          }
        }
      });
      
      if (cachesEliminados > 0) {
        console.log(`üóëÔ∏è ${cachesEliminados} caches antiguos eliminados`);
      }
    }

    async function inicializarSistema() {
      mostrarNotificacion('Iniciando sistema de n√≥mina (modo optimizado)...', 'info');
      limpiarCacheAntiguo();
      renderizarEmpleadosLocales();
      mostrarNotificacion('Sistema listo - configuraci√≥n manual disponible', 'success');
    }

    function configurarFechasPorDefecto() {
      const hoy = new Date();
      const dia = hoy.getDate();
      
      let fechaInicio, fechaFin;
      
      if (dia <= 15) {
        fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        fechaFin = new Date(hoy.getFullYear(), hoy.getMonth(), 15);
      } else {
        fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), 16);
        fechaFin = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
      }
      
      document.getElementById('fechaInicio').value = fechaInicio.toISOString().split('T')[0];
      document.getElementById('fechaFin').value = fechaFin.toISOString().split('T')[0];
    }

    // AGREGAR EMPLEADO MANUAL
    window.agregarEmpleadoManual = function() {
      const nombre = document.getElementById('nuevoEmpleadoNombre').value.trim();
      const email = document.getElementById('nuevoEmpleadoEmail').value.trim();
      const tipo = document.getElementById('nuevoEmpleadoTipo').value;

      if (!nombre || !email) {
        mostrarNotificacion('Completa nombre y email', 'warning');
        return;
      }

      const nuevoEmpleado = {
        id: 'manual_' + Date.now(),
        nombre: nombre,
        email: email,
        tipo: tipo,
        salarioHora: null,
        salarioMensual: null,
        tipoPago: 'quincenal',
        activo: true
      };

      empleadosLocales.push(nuevoEmpleado);
      localStorage.setItem('nomina_empleados', JSON.stringify(empleadosLocales));
      
      // Limpiar formulario
      document.getElementById('nuevoEmpleadoNombre').value = '';
      document.getElementById('nuevoEmpleadoEmail').value = '';
      
      renderizarEmpleadosLocales();
      mostrarNotificacion('Empleado agregado correctamente', 'success');
      actualizarInfoCache();
    };

    function renderizarEmpleadosLocales() {
      const container = document.getElementById('configUsuarios');
      container.innerHTML = '';

      if (empleadosLocales.length === 0) {
        container.innerHTML = `
          <div class="col-12">
            <div class="text-center p-4">
              <i class="bi bi-people" style="font-size: 3rem; color: #6c757d;"></i>
              <h5 class="mt-3 text-muted">No hay empleados configurados</h5>
              <p class="text-muted">Agrega empleados usando el formulario de arriba</p>
            </div>
          </div>
        `;
        return;
      }

      empleadosLocales.forEach(empleado => {
        const card = document.createElement('div');
        card.className = 'col-md-6 mb-3';
        card.innerHTML = `
          <div class="config-card">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="employee-name">${empleado.nombre}</h6>
                <p class="text-muted small mb-1">${empleado.email}</p>
                <span class="config-badge ${empleado.activo ? 'bg-success' : 'bg-secondary'} text-white">
                  ${empleado.activo ? 'Activo' : 'Inactivo'}
                </span>
                <small class="d-block text-muted mt-1">
                  Tipo: ${empleado.tipo}
                </small>
              </div>
              <div class="text-end">
                <div class="salary-display">
                  ${empleado.salarioMensual ? `$${empleado.salarioMensual}/mes` : (empleado.salarioHora ? `$${empleado.salarioHora}/hr` : 'Sin salario')}
                </div>
                <small class="text-muted">${empleado.tipoPago}</small>
              </div>
            </div>
            <div class="mt-2">
              <small class="text-muted">
                ${HORARIOS_BASE[empleado.tipo]?.horasDiarias || 0} horas diarias
              </small>
            </div>
            <button class="btn btn-sm btn-outline-primary mt-2 w-100" 
                    onclick="editarEmpleadoLocal('${empleado.id}')">
              <i class="bi bi-gear me-1"></i>Configurar
            </button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    window.editarEmpleadoLocal = function(empleadoId) {
      const empleado = empleadosLocales.find(e => e.id === empleadoId);
      if (!empleado) return;

      document.getElementById('configUserId').value = empleado.id;
      document.getElementById('configNombre').value = empleado.nombre;
      document.getElementById('configEmail').value = empleado.email;
      document.getElementById('configSalarioHora').value = empleado.salarioHora || '';
      document.getElementById('configSalarioMensual').value = empleado.salarioMensual || '';
      document.getElementById('configTipoPago').value = empleado.tipoPago || 'quincenal';
      document.getElementById('configHorarioBase').value = empleado.tipo;
      document.getElementById('configActivo').checked = empleado.activo !== false;

      new bootstrap.Modal(document.getElementById('modalConfigUsuario')).show();
    };

    window.guardarConfigUsuario = function() {
      const empleadoId = document.getElementById('configUserId').value;
      const empleado = empleadosLocales.find(e => e.id === empleadoId);
      
      if (!empleado) return;

      empleado.nombre = document.getElementById('configNombre').value;
      empleado.email = document.getElementById('configEmail').value;
      
      const salarioHora = document.getElementById('configSalarioHora').value;
      const salarioMensual = document.getElementById('configSalarioMensual').value;
      
      empleado.salarioHora = salarioHora ? parseFloat(salarioHora) : null;
      empleado.salarioMensual = salarioMensual ? parseFloat(salarioMensual) : null;
      
      empleado.tipoPago = document.getElementById('configTipoPago').value;
      empleado.tipo = document.getElementById('configHorarioBase').value;
      empleado.activo = document.getElementById('configActivo').checked;

      localStorage.setItem('nomina_empleados', JSON.stringify(empleadosLocales));

      bootstrap.Modal.getInstance(document.getElementById('modalConfigUsuario')).hide();
      mostrarNotificacion('Configuraci√≥n guardada correctamente', 'success');
      renderizarEmpleadosLocales();
    };

    // **C√ÅLCULO DE N√ìMINA CON CONTROL DE PER√çODOS**
    window.calcularNomina = function() {
      if (calculandoNomina) {
        mostrarNotificacion('Ya se est√° calculando una n√≥mina. Espera...', 'warning');
        return;
      }
      
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;
      
      if (!fechaInicio || !fechaFin) {
        mostrarNotificacion('Selecciona las fechas del per√≠odo', 'warning');
        return;
      }

      // VERIFICAR SI YA SE CONSULT√ì ESTE PER√çODO
      if (yaSePidioEœÉœÑePeriodo(fechaInicio, fechaFin)) {
        mostrarModalSuperAdmin(fechaInicio, fechaFin);
        return;
      }
      
      // Primera consulta para este per√≠odo - proceder normalmente
      calcularNominaInternal();
    };

    function mostrarModalSuperAdmin(fechaInicio, fechaFin) {
      const cacheKey = obtenerCacheKey(fechaInicio, fechaFin);
      const cache = obtenerDatosCache(cacheKey);
      const periodoInfo = periodosConsultados[obtenerPeriodoKey(fechaInicio, fechaFin)];
      
      document.getElementById('periodoConsultado').textContent = `${fechaInicio} al ${fechaFin}`;
      document.getElementById('fechaUltimaConsulta').textContent = 
        new Date(periodoInfo.fechaConsulta).toLocaleString();
      document.getElementById('registrosCache').textContent = 
        cache ? `${cache.length} registros disponibles` : 'Sin cache';
      
      document.getElementById('passwordSuperAdmin').value = '';
      
      new bootstrap.Modal(document.getElementById('modalSuperAdmin')).show();
    }

    window.autorizarConsultaAdicional = function() {
      const password = document.getElementById('passwordSuperAdmin').value;
      
      if (password !== SUPER_ADMIN_PASSWORD) {
        mostrarNotificacion('Contrase√±a incorrecta', 'danger');
        return;
      }
      
      // Contrase√±a correcta - permitir consulta adicional
      bootstrap.Modal.getInstance(document.getElementById('modalSuperAdmin')).hide();
      
      mostrarNotificacion('Autorizaci√≥n concedida - Realizando consulta adicional', 'warning');
      
      // Forzar nueva consulta limpiando cache
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;
      const cacheKey = obtenerCacheKey(fechaInicio, fechaFin);
      localStorage.removeItem(cacheKey);
      
      calcularNominaInternal();
    };

    async function calcularNominaInternal() {
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;
      
      if (!fechaInicio || !fechaFin) {
        mostrarNotificacion('Selecciona las fechas del per√≠odo', 'warning');
        return;
      }

      if (empleadosLocales.length === 0) {
        mostrarNotificacion('Primero agrega empleados en Configuraci√≥n', 'warning');
        return;
      }

      calculandoNomina = true;
      document.getElementById('btnCalcular').disabled = true;
      document.getElementById('loadingNomina').classList.remove('d-none');
      document.getElementById('listaEmpleados').innerHTML = '';
      document.getElementById('resumenNomina').classList.add('d-none');
      document.getElementById('loadingDetail').textContent = 'Verificando datos en cache...';

      try {
        console.log(`üìä Calculando n√≥mina del ${fechaInicio} al ${fechaFin}`);
        
        await cargarRegistrosAsistenciaOptimizada(fechaInicio, fechaFin);
        
        document.getElementById('loadingDetail').textContent = 'Procesando c√°lculos...';
        const resultados = procesarNominaEmpleadosCorregida(fechaInicio, fechaFin);
        mostrarResultadosNomina(resultados);
        
        document.getElementById('warningPermisos').classList.remove('d-none');
        actualizarInfoCache();

      } catch (error) {
        console.error('‚ùå Error calculando n√≥mina:', error);
        mostrarNotificacion('Error al calcular n√≥mina: ' + error.message, 'danger');
      } finally {
        calculandoNomina = false;
        document.getElementById('btnCalcular').disabled = false;
        document.getElementById('loadingNomina').classList.add('d-none');
      }
    }

    // **UNA SOLA CONSULTA OPTIMIZADA POR PER√çODO**
    async function cargarRegistrosAsistenciaOptimizada(fechaInicio, fechaFin) {
      const cacheKey = obtenerCacheKey(fechaInicio, fechaFin);
      
      // VERIFICAR CACHE PRIMERO
      const datosCache = obtenerDatosCache(cacheKey);
      if (datosCache) {
        registrosAsistencia = datosCache;
        document.getElementById('loadingDetail').textContent = `Usando cache (${registrosAsistencia.length} registros)`;
        console.log(`Cache hit: ${registrosAsistencia.length} registros para ${fechaInicio}-${fechaFin}`);
        return;
      }

      // VERIFICAR L√çMITES DE CONSULTA
      if (!puedeHacerConsulta()) {
        // Intentar usar cache expirado como respaldo
        const cachedData = localStorage.getItem(cacheKey);
        if (cachedData) {
          const cache = JSON.parse(cachedData);
          registrosAsistencia = cache.data;
          mostrarNotificacion('Usando cache expirado por l√≠mite de consultas', 'warning');
          return;
        }
        throw new Error('L√≠mite de consultas alcanzado y no hay cache disponible. Espera un momento.');
      }

      document.getElementById('loadingDetail').textContent = 'UNA consulta a Firebase...';
      console.log(`Iniciando √öNICA consulta Firebase: ${fechaInicio} a ${fechaFin}`);
      
      try {
        registrarConsulta();
        
        // UNA SOLA CONSULTA PARA TODO EL PER√çODO
        // Sin limit() porque necesitamos TODOS los registros del per√≠odo
        const q = query(
          collection(db, "registros"),
          where("fecha", ">=", fechaInicio),
          where("fecha", "<=", fechaFin),
          orderBy("fecha")
          // NO limit() - queremos todos los registros del per√≠odo
        );
        
        const registrosSnapshot = await getDocs(q);
        registrosAsistencia = [];
        
        registrosSnapshot.forEach(doc => {
          const data = doc.data();
          registrosAsistencia.push({
            id: doc.id,
            ...data
          });
        });
        
        console.log(`√âXITO: ${registrosAsistencia.length} registros en UNA consulta`);
        
        // An√°lisis de lo que obtuvimos
        const empleadosUnicos = [...new Set(registrosAsistencia.map(r => r.email || r.usuario))];
        const diasUnicos = [...new Set(registrosAsistencia.map(r => r.fecha))];
        console.log(`Datos: ${empleadosUnicos.length} empleados, ${diasUnicos.length} d√≠as`);
        
        // GUARDAR EN CACHE INMEDIATAMENTE
        guardarEnCache(cacheKey, registrosAsistencia);
        
        document.getElementById('loadingDetail').textContent = `${registrosAsistencia.length} registros cargados`;
        
        // REGISTRAR QUE SE CONSULT√ì ESTE PER√çODO
        const fechaInicio = document.getElementById('fechaInicio').value;
        const fechaFin = document.getElementById('fechaFin').value;
        registrarPeriodoConsultado(fechaInicio, fechaFin);
        
      } catch (error) {
        console.error('Error en consulta Firebase:', error);
        
        // INTENTAR CACHE EXPIRADO COMO √öLTIMO RECURSO
        const cachedData = localStorage.getItem(cacheKey);
        if (cachedData) {
          const cache = JSON.parse(cachedData);
          registrosAsistencia = cache.data;
          console.log('Usando cache expirado como respaldo');
          mostrarNotificacion('Error de Firebase - usando datos en cach√©', 'warning');
        } else {
          throw new Error(`Error Firebase: ${error.message}. Sin cache disponible.`);
        }
      }
    }

    // **PROCESAMIENTO DE N√ìMINA CORREGIDO**
    function procesarNominaEmpleadosCorregida(fechaInicio, fechaFin) {
      const empleadosActivos = empleadosLocales.filter(e => 
        e.activo && (e.salarioHora > 0 || e.salarioMensual > 0)
      );
      
      console.log(`üìã Procesando n√≥mina para ${empleadosActivos.length} empleados activos`);

      const resultados = [];
      empleadosActivos.forEach(empleado => {
        const resultado = calcularNominaIndividualCorregida(empleado, fechaInicio, fechaFin);
        resultados.push(resultado);
      });

      return resultados;
    }

    // **C√ÅLCULO INDIVIDUAL CORREGIDO**
    function calcularNominaIndividualCorregida(empleado, fechaInicio, fechaFin) {
      const registrosUsuario = registrosAsistencia.filter(r => 
        r.email === empleado.email || r.usuario === empleado.email
      );
      
      console.log(`üë§ ${empleado.nombre}: ${registrosUsuario.length} registros encontrados`);

      // 1. CALCULAR D√çAS LABORALES CORRECTAMENTE
      const diasLaborales = calcularDiasLaboralesCorregido(fechaInicio, fechaFin);
      
      // 2. CALCULAR HORAS Y RETARDOS
      const { horasInfo, retardos } = calcularHorasYRetardosCorregido(registrosUsuario, empleado.tipo);
      
      // 3. CALCULAR PENALIZACIONES (3 retardos = 1 d√≠a)
      const diasPenalizacion = Math.floor(retardos / 3);
      
      // 4. D√çAS EFECTIVOS
      const diasEfectivos = Math.max(0, diasLaborales - diasPenalizacion);
      
      // 5. HORAS ESPERADAS Y A PAGAR
      const horasDiarias = HORARIOS_BASE[empleado.tipo]?.horasDiarias || 8;
      const horasEsperadas = diasLaborales * horasDiarias;
      const horasAPagar = Math.min(horasInfo.horasReales, diasEfectivos * horasDiarias);
      
      // 6. CALCULAR SALARIO POR HORA SEG√öN PER√çODO
      const tipoPeriodo = document.getElementById('tipoPeriodo').value;
      const salarioPorHora = calcularSalarioPorHoraCorregido(empleado, tipoPeriodo, horasDiarias, diasLaborales);
      
      // 7. TOTAL A PAGAR
      const totalPago = horasAPagar * salarioPorHora;

      const progresoDiario = calcularProgresoDiarioCorregido(registrosUsuario, empleado, fechaInicio, fechaFin, salarioPorHora);

      return {
        empleado: empleado,
        diasLaborales: diasLaborales,
        diasEfectivos: diasEfectivos,
        diasAusencia: diasLaborales - Math.min(diasLaborales, horasInfo.diasTrabajados),
        diasPenalizacion: diasPenalizacion,
        horasEsperadas: horasEsperadas,
        horasTrabajadas: horasInfo.horasReales,
        horasAPagar: horasAPagar,
        retardos: retardos,
        totalPago: totalPago,
        detalleHoras: horasInfo.detalle,
        progresoDiario: progresoDiario,
        salarioPorHora: salarioPorHora
      };
    }

    // **FUNCIONES DE C√ÅLCULO CORREGIDAS**
    function calcularDiasLaboralesCorregido(fechaInicio, fechaFin) {
      const inicio = new Date(fechaInicio + 'T00:00:00');
      const fin = new Date(fechaFin + 'T23:59:59');
      let dias = 0;
      
      const current = new Date(inicio);
      
      while (current <= fin) {
        const diaSemana = current.getDay();
        if (diaSemana !== 0 && diaSemana !== 6) {
          dias++;
        }
        current.setDate(current.getDate() + 1);
      }
      
      console.log(`üìÖ D√≠as laborales del ${fechaInicio} al ${fechaFin}: ${dias}`);
      return dias;
    }

    function calcularHorasYRetardosCorregido(registros, horarioBase) {
      const registrosPorDia = {};
      let horasReales = 0;
      let retardos = 0;
      const detalle = [];
      const horasDiarias = HORARIOS_BASE[horarioBase]?.horasDiarias || 8;

      // Agrupar registros por d√≠a
      registros.forEach(registro => {
        const fecha = registro.fecha;
        if (!registrosPorDia[fecha]) {
          registrosPorDia[fecha] = { entradas: [], salidas: [], retardo: false };
        }
        
        if (registro.tipoEvento === 'entrada' || registro.tipo === 'entrada') {
          registrosPorDia[fecha].entradas.push(registro.hora);
          // Verificar retardos
          if (registro.estado === 'retardo' || registro.hora > '08:15') {
            registrosPorDia[fecha].retardo = true;
          }
        } else if (registro.tipoEvento === 'salida' || registro.tipo === 'salida') {
          registrosPorDia[fecha].salidas.push(registro.hora);
        }
      });

      Object.entries(registrosPorDia).forEach(([fecha, reg]) => {
        let horasDia = 0;
        let estado = 'Sin registro';

        if (reg.retardo) {
          retardos++;
        }

        // Tomar la primera entrada y √∫ltima salida del d√≠a
        const primeraEntrada = reg.entradas.length > 0 ? reg.entradas.sort()[0] : null;
        const ultimaSalida = reg.salidas.length > 0 ? reg.salidas.sort().pop() : null;

        if (primeraEntrada && ultimaSalida) {
          const [hEntrada, mEntrada] = primeraEntrada.split(':').map(Number);
          const [hSalida, mSalida] = ultimaSalida.split(':').map(Number);
          
          const minutosEntrada = hEntrada * 60 + mEntrada;
          const minutosSalida = hSalida * 60 + mSalida;
          
          if (minutosSalida > minutosEntrada) {
            const minutosTrabajados = minutosSalida - minutosEntrada;
            horasDia = Math.min(minutosTrabajados / 60, horasDiarias);
            horasReales += horasDia;
            estado = 'Completo';
          }
        } else if (primeraEntrada) {
          // Solo entrada, asumir jornada completa
          horasDia = horasDiarias;
          horasReales += horasDia;
          estado = 'Sin salida';
        }

        detalle.push({
          fecha: fecha,
          entrada: primeraEntrada,
          salida: ultimaSalida,
          horas: horasDia,
          estado: estado,
          retardo: reg.retardo
        });
      });

      const diasTrabajados = detalle.filter(d => d.horas > 0).length;

      return { 
        horasInfo: { horasReales, detalle, diasTrabajados },
        retardos 
      };
    }

    function calcularSalarioPorHoraCorregido(empleado, tipoPeriodo, horasDiarias, diasLaborales) {
      if (empleado.salarioHora && empleado.salarioHora > 0) {
        return empleado.salarioHora;
      }
      
      if (!empleado.salarioMensual || empleado.salarioMensual <= 0) {
        console.warn(`‚ö†Ô∏è Empleado ${empleado.nombre} sin salario configurado`);
        return 0;
      }

      let salarioPorHora = 0;
      
      if (tipoPeriodo === 'quincenal') {
        // Pago quincenal: salario mensual / 2
        const pagoQuincenal = empleado.salarioMensual / 2;
        const horasQuincenales = diasLaborales * horasDiarias;
        salarioPorHora = horasQuincenales > 0 ? pagoQuincenal / horasQuincenales : 0;
      } else if (tipoPeriodo === 'semanal') {
        // Pago semanal: salario mensual / 4.33
        const pagoSemanal = empleado.salarioMensual / 4.33;
        const horasPorSemana = 5 * horasDiarias; // 5 d√≠as laborales
        salarioPorHora = pagoSemanal / horasPorSemana;
      } else {
        // Mensual
        const horasPorMes = horasDiarias * 22; // 22 d√≠as laborales promedio
        salarioPorHora = empleado.salarioMensual / horasPorMes;
      }
      
      console.log(`üí∞ ${empleado.nombre}: $${salarioPorHora.toFixed(2)}/hr (${tipoPeriodo}, ${diasLaborales} d√≠as)`);
      return salarioPorHora;
    }

    function calcularProgresoDiarioCorregido(registros, empleado, fechaInicio, fechaFin, salarioPorHora) {
      const progreso = [];
      let acumuladoHoras = 0;
      let acumuladoPago = 0;
      
      const diasLaborales = [];
      const inicio = new Date(fechaInicio + 'T00:00:00');
      const fin = new Date(fechaFin + 'T23:59:59');
      
      for (let d = new Date(inicio); d <= fin; d.setDate(d.getDate() + 1)) {
        const diaSemana = d.getDay();
        if (diaSemana !== 0 && diaSemana !== 6) {
          diasLaborales.push(d.toISOString().split('T')[0]);
        }
      }

      const horasDiarias = HORARIOS_BASE[empleado.tipo]?.horasDiarias || 8;

      diasLaborales.forEach(dia => {
        const registrosDia = registros.filter(r => r.fecha === dia);
        let horasDia = 0;

        if (registrosDia.length > 0) {
          const entradas = registrosDia.filter(r => r.tipoEvento === 'entrada' || r.tipo === 'entrada');
          const salidas = registrosDia.filter(r => r.tipoEvento === 'salida' || r.tipo === 'salida');

          if (entradas.length > 0 && salidas.length > 0) {
            const primeraEntrada = entradas.sort((a, b) => a.hora.localeCompare(b.hora))[0];
            const ultimaSalida = salidas.sort((a, b) => b.hora.localeCompare(a.hora))[0];

            const [hEntrada, mEntrada] = primeraEntrada.hora.split(':').map(Number);
            const [hSalida, mSalida] = ultimaSalida.hora.split(':').map(Number);
            
            const minutosEntrada = hEntrada * 60 + mEntrada;
            const minutosSalida = hSalida * 60 + mSalida;
            
            if (minutosSalida > minutosEntrada) {
              horasDia = Math.min((minutosSalida - minutosEntrada) / 60, horasDiarias);
            }
          } else if (entradas.length > 0) {
            horasDia = horasDiarias;
          }
        }

        acumuladoHoras += horasDia;
        acumuladoPago += horasDia * salarioPorHora;

        progreso.push({
          fecha: dia,
          horasDia: horasDia,
          acumuladoHoras: acumuladoHoras,
          acumuladoPago: acumuladoPago,
          trabajoHoy: horasDia > 0
        });
      });

      return progreso;
    }

    // **MOSTRAR RESULTADOS (sin cambios)**
    function mostrarResultadosNomina(resultados) {
      const container = document.getElementById('listaEmpleados');
      container.innerHTML = '';

      let totalEmpleados = resultados.length;
      let totalHoras = 0;
      let totalPago = 0;

      resultados.forEach(resultado => {
        totalHoras += resultado.horasTrabajadas;
        totalPago += resultado.totalPago;

        const ultimoProgreso = resultado.progresoDiario[resultado.progresoDiario.length - 1] || 
          { acumuladoPago: 0, acumuladoHoras: 0 };

        const card = document.createElement('div');
        card.className = 'col-md-6 col-lg-4 mb-4 fade-in';
        card.innerHTML = `
          <div class="employee-card" onclick="verDetalleEmpleado('${resultado.empleado.id}')">
            <div class="employee-card-body">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                  <h6 class="employee-name">${resultado.empleado.nombre}</h6>
                  <small class="employee-type">${resultado.empleado.tipo} - $${resultado.salarioPorHora.toFixed(2)}/hr</small>
                </div>
                <span class="delay-badge ${resultado.retardos > 0 ? 'bg-warning text-dark' : 'bg-success text-white'}">
                  ${resultado.retardos} retardo${resultado.retardos !== 1 ? 's' : ''}
                </span>
              </div>
              
              <div class="progress-section">
                <div class="text-center">
                  <div class="accumulated-amount">$${ultimoProgreso.acumuladoPago.toFixed(2)}</div>
                  <small class="text-muted">Acumulado hasta hoy</small>
                </div>
                <div class="progress-custom mt-2">
                  <div class="progress-bar" style="width: ${Math.min(100, (resultado.horasTrabajadas / resultado.horasEsperadas) * 100)}%"></div>
                </div>
                <small class="text-muted d-block mt-1">
                  ${resultado.horasTrabajadas.toFixed(1)} / ${resultado.horasEsperadas} horas esperadas
                </small>
              </div>

              <div class="stats-grid">
                <div class="row text-center small">
                  <div class="col-4">
                    <div class="stat-number">${resultado.diasEfectivos}</div>
                    <small class="text-muted">D√≠as trabajados</small>
                  </div>
                  <div class="col-4">
                    <div class="stat-number">${resultado.diasAusencia}</div>
                    <small class="text-muted">Ausencias</small>
                  </div>
                  <div class="col-4">
                    <div class="stat-number">${resultado.diasPenalizacion}</div>
                    <small class="text-muted">Penalizaciones</small>
                  </div>
                </div>
              </div>

              <div class="text-center mt-3">
                <div class="final-amount">$${resultado.totalPago.toFixed(2)}</div>
                <small class="text-muted">Total a pagar</small>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });

      document.getElementById('totalEmpleados').textContent = totalEmpleados;
      document.getElementById('totalHoras').textContent = totalHoras.toFixed(1);
      document.getElementById('totalPago').textContent = `$${totalPago.toFixed(2)}`;
      document.getElementById('resumenNomina').classList.remove('d-none');

      window.ultimosResultados = resultados;
      
      console.log(`‚úÖ N√≥mina calculada: ${totalEmpleados} empleados, ${totalHoras.toFixed(1)} horas, $${totalPago.toFixed(2)} total`);
    }

    // **DETALLE EMPLEADO (corregido)**
    window.verDetalleEmpleado = function(empleadoId) {
      const resultado = window.ultimosResultados?.find(r => r.empleado.id === empleadoId);
      if (!resultado) return;
      
      const content = document.getElementById('detalleEmpleadoContent');
      
      let detalleHtml = `
        <div class="row mb-3">
          <div class="col-md-6">
            <h6>${resultado.empleado.nombre}</h6>
            <p class="text-muted">${resultado.empleado.email}</p>
            <p class="small">Tipo: ${resultado.empleado.tipo}</p>
            <p class="small">Salario/hora: $${resultado.salarioPorHora.toFixed(2)}</p>
          </div>
          <div class="col-md-6">
            <div class="alert alert-info">
              <strong>Total a pagar: $${resultado.totalPago.toFixed(2)}</strong><br>
              <small>
                ${resultado.horasAPagar.toFixed(1)} horas √ó $${resultado.salarioPorHora.toFixed(2)}/hr
                ${resultado.diasPenalizacion > 0 ? `<br>(${resultado.retardos} retardos ‚Üí ${resultado.diasPenalizacion} d√≠as penalizados)` : ''}
              </small>
            </div>
          </div>
        </div>
        
        <h6 class="mb-3">Detalle de asistencia:</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Entrada</th>
                <th>Salida</th>
                <th>Horas</th>
                <th>Estado</th>
                <th>Retardo</th>
              </tr>
            </thead>
            <tbody>
      `;

      resultado.detalleHoras.forEach(dia => {
        detalleHtml += `
          <tr>
            <td>${dia.fecha}</td>
            <td>${dia.entrada || '-'}</td>
            <td>${dia.salida || '-'}</td>
            <td>${dia.horas.toFixed(1)}</td>
            <td><span class="badge ${dia.estado === 'Completo' ? 'bg-success' : 'bg-warning text-dark'}">${dia.estado}</span></td>
            <td>${dia.retardo ? '<i class="bi bi-exclamation-triangle text-warning"></i>' : '-'}</td>
          </tr>
        `;
      });

      detalleHtml += `
            </tbody>
          </table>
        </div>
        
        <div class="mt-3">
          <strong>Resumen:</strong>
          <ul>
            <li>D√≠as laborales en el per√≠odo: ${resultado.diasLaborales}</li>
            <li>D√≠as trabajados: ${resultado.diasEfectivos}</li>
            <li>Ausencias: ${resultado.diasAusencia}</li>
            <li>Retardos: ${resultado.retardos} (${resultado.diasPenalizacion} d√≠as penalizados)</li>
            <li>Horas esperadas: ${resultado.horasEsperadas}</li>
            <li>Horas trabajadas: ${resultado.horasTrabajadas.toFixed(1)}</li>
            <li>Horas a pagar: ${resultado.horasAPagar.toFixed(1)}</li>
          </ul>
        </div>
      `;

      content.innerHTML = detalleHtml;
      new bootstrap.Modal(document.getElementById('modalDetalleEmpleado')).show();
    };

    // **FUNCIONES DE UTILIDAD Y DEBUG**
    function actualizarInfoCache() {
      const claves = Object.keys(localStorage).filter(k => k.startsWith('asistencia_'));
      const totalCaches = claves.length;
      
      let totalRegistros = 0;
      claves.forEach(key => {
        try {
          const cache = JSON.parse(localStorage.getItem(key));
          totalRegistros += cache.data?.length || 0;
        } catch (e) {}
      });
      
      const cacheInfo = document.getElementById('cacheInfo');
      if (cacheInfo) {
        cacheInfo.textContent = `${totalCaches} caches, ${totalRegistros} registros, ${consultasRealizadas} consultas realizadas`;
      }
    }

    window.limpiarCacheCompleto = function() {
      if (confirm('¬øSeguro que quieres limpiar todo el cache? Esto forzar√° nuevas consultas a Firebase.')) {
        const claves = Object.keys(localStorage);
        let eliminados = 0;
        
        claves.forEach(key => {
          if (key.startsWith('asistencia_')) {
            localStorage.removeItem(key);
            eliminados++;
          }
        });
        
        mostrarNotificacion(`Cache limpiado: ${eliminados} elementos eliminados`, 'success');
        actualizarInfoCache();
      }
    };

    window.toggleDebugInfo = function() {
      const debugDiv = document.getElementById('debugInfo');
      const debugContent = document.getElementById('debugContent');
      
      if (debugDiv.classList.contains('d-none')) {
        debugContent.innerHTML = `
          <div class="small">
            <strong>Consultas Firebase:</strong> ${consultasRealizadas} realizadas<br>
            <strong>√öltima consulta:</strong> ${ultimaConsulta > 0 ? new Date(ultimaConsulta).toLocaleTimeString() : 'Ninguna'}<br>
            <strong>Empleados locales:</strong> ${empleadosLocales.length}<br>
            <strong>Registros en memoria:</strong> ${registrosAsistencia.length}<br>
            <strong>Cache duration:</strong> ${CACHE_DURACION / 1000 / 60 / 60} horas<br>
            <strong>Estado:</strong> ${calculandoNomina ? 'Calculando...' : 'Listo'}
          </div>
        `;
        debugDiv.classList.remove('d-none');
      } else {
        debugDiv.classList.add('d-none');
      }
    };

    window.generarReporteNomina = function() {
      mostrarNotificacion('Funci√≥n de generaci√≥n de PDF en desarrollo', 'info');
    };

    function mostrarNotificacion(mensaje, tipo) {
      const notificacion = document.createElement('div');
      notificacion.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
      notificacion.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
      notificacion.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(notificacion);
      
      setTimeout(() => {
        if (notificacion.parentNode) {
          notificacion.remove();
        }
      }, 5000);
    }

    // **INICIALIZAR INFO CACHE AL CARGAR**
    setTimeout(actualizarInfoCache, 1000);
  </script>
</body>
</html>