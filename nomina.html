<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de N√≥mina Quincenal | Cielito Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="nomina.css">
  <link rel="icon" href="img/cielitohome.png" type="image/png">
</head>
<body>
  <!-- Navbar Mejorado -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="admin.html">
        <div class="brand-icon me-2">
          <i class="bi bi-calculator-fill"></i>
        </div>
        <div class="brand-text">
          <div class="brand-title">Sistema de N√≥mina</div>
          <div class="brand-subtitle">Cielito Home</div>
        </div>
      </a>
      
      <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <i class="bi bi-list"></i>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <div class="navbar-nav ms-auto">
          <button onclick="toggleSalaryManager()" class="btn btn-nav me-2">
            <i class="bi bi-person-gear me-2"></i>
            <span class="btn-text">Gestionar Salarios</span>
          </button>
          <a href="admin.html" class="btn btn-nav">
            <i class="bi bi-arrow-left me-2"></i>
            <span class="btn-text">Panel Admin</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container main-container">
    <!-- Gesti√≥n de Salarios Individuales -->
    <div id="salaryManager" class="salary-config" style="display: none;">
      <h4><i class="bi bi-person-gear me-2"></i>Gesti√≥n de Salarios Individuales</h4>
      <div class="row mb-3">
        <div class="col-md-6">
          <select id="employeeSelect" class="form-select">
            <option value="">Seleccionar empleado...</option>
          </select>
        </div>
        <div class="col-md-6">
          <button onclick="loadEmployeeSalary()" class="btn btn-info">
            <i class="bi bi-person-check me-2"></i>Cargar Datos
          </button>
        </div>
      </div>
      
      <div id="employeeSalaryForm" style="display: none;">
        <div class="row">
          <div class="col-md-4">
            <label class="form-label">Salario por Per√≠odo (10 d√≠as)</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" id="individualSalary" class="form-control" min="0" placeholder="2,000">
              <span class="input-group-text">.00</span>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Horas por Per√≠odo (referencia)</label>
            <input type="number" id="individualHours" class="form-control" min="1" max="80" placeholder="40">
            <small class="text-muted">Solo para referencia, el pago es por d√≠a</small>
          </div>
          <div class="col-md-4">
            <label class="form-label">Pago por D√≠a</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" id="dailyRate" class="form-control" readonly>
            </div>
          </div>
        </div>
        
        <!-- Nuevas opciones: IMSS y Caja de Ahorro -->
        <div class="row mt-3">
          <div class="col-md-6">
            <div class="card p-3">
              <h6 class="card-title mb-3">üè• Seguro Social (IMSS)</h6>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tieneIMSS">
                <label class="form-check-label" for="tieneIMSS">
                  <strong>Empleado asegurado</strong>
                </label>
              </div>
              <small class="text-muted mt-1 d-block">Se descuentan $300 fijos por quincena</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3">
              <h6 class="card-title mb-3">üè¶ Caja de Ahorro</h6>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="tieneCajaAhorro" onchange="toggleCajaAhorro()">
                <label class="form-check-label" for="tieneCajaAhorro">
                  <strong>Participa en caja de ahorro</strong>
                </label>
              </div>
              <div id="cajaAhorroOptions" style="display: none;">
                <label class="form-label">Descuento quincenal:</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" id="montoCajaAhorro" class="form-control" min="0" placeholder="200">
                  <span class="input-group-text">.00</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-3">
          <div class="col-md-12">
            <button onclick="saveEmployeeSalary()" class="btn btn-success me-2">
              <i class="bi bi-floppy me-2"></i>Guardar Configuraci√≥n
            </button>
            <button onclick="clearEmployeeSalary()" class="btn btn-warning me-2">
              <i class="bi bi-trash me-2"></i>Eliminar Configuraci√≥n
            </button>
            <button onclick="toggleSalaryManager()" class="btn btn-secondary">
              <i class="bi bi-x me-2"></i>Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard Caja de Ahorro -->
    <div id="cajaAhorroDashboard" class="row mt-3" style="display: none;">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-piggy-bank me-2"></i>Dashboard Caja de Ahorro
            </h5>
          </div>
          <div class="card-body">
            <div class="row" id="cajaAhorroStats">
              <!-- Se llena din√°micamente -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Selector de Per√≠odo -->
    <div class="period-selector">
      <div class="row align-items-end">
        <div class="col-md-3">
          <label class="form-label">Mes y A√±o</label>
          <input type="month" id="monthSelect" class="form-control" value="">
        </div>
        <div class="col-md-3">
          <label class="form-label">Per√≠odo</label>
          <select id="quinceSelect" class="form-select">
            <option value="primera">Per√≠odo 1 (Primeros 10 d√≠as laborales)</option>
            <option value="segunda">Per√≠odo 2 (Siguientes 10 d√≠as laborales)</option>
          </select>
        </div>
        <div class="col-md-6">
  <div class="d-flex flex-column flex-md-row gap-2">
    <button onclick="calcularNomina()" class="btn btn-primary btn-lg flex-fill">
      <i class="bi bi-calculator me-2"></i>Calcular N√≥mina
    </button>
    <button onclick="guardarNominaCompleta()" class="btn btn-info flex-fill" id="saveBtn" style="display: none;">
      <i class="bi bi-save me-2"></i>Guardar N√≥mina
    </button>
    <button onclick="exportarExcel()" class="btn btn-success flex-fill" id="exportBtn" style="display: none;">
      <i class="bi bi-file-earmark-excel me-2"></i>Exportar Excel
    </button>
  </div>
</div>
      </div>
    </div>

    <!-- Resumen General -->
    <div id="summaryCard" class="summary-card" style="display: none;">
      <div class="summary-stats">
        <div class="summary-stat">
          <span id="totalEmployees" class="summary-number">0</span>
          <div class="summary-label">Empleados</div>
        </div>
        <div class="summary-stat">
          <span id="totalRetards" class="summary-number">0</span>
          <div class="summary-label">Retardos Totales</div>
        </div>
        <div class="summary-stat">
          <span id="employeesWithPenalty" class="summary-number">0</span>
          <div class="summary-label">Con Descuento</div>
        </div>
        <div class="summary-stat">
          <span id="totalPayout" class="summary-number">$0</span>
          <div class="summary-label">Total a Pagar</div>
        </div>
        <div class="summary-stat">
          <h4 class="mb-0"><i class="bi bi-graph-up me-2"></i>Resumen General</h4>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div id="loadingSpinner" class="loading-spinner text-center" style="display: none;">
      <div class="spinner-border text-primary" role="status"></div>
      <span class="ms-3">Calculando n√≥mina...</span>
    </div>

<!-- Controles de Vista -->
<div id="viewControls" class="view-controls" style="display: none;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Resultados de N√≥mina</h5>
    <div class="btn-group" role="group">
      <button type="button" class="btn btn-outline-primary active" id="btnVistaCompacta" onclick="cambiarVista('compacta')">
        <i class="bi bi-grid-3x2 me-1"></i>Compacta
      </button>
      <button type="button" class="btn btn-outline-primary" id="btnVistaTabla" onclick="cambiarVista('tabla')">
        <i class="bi bi-table me-1"></i>Tabla
      </button>
    </div>
  </div>
</div>

<!-- Vista Compacta (Default) -->
<div id="resultsContainer" class="employee-grid-compact"></div>

<!-- Vista de Tabla -->
<div id="tableContainer" class="table-responsive" style="display: none;">
  <table class="table table-hover nomina-table">
    <thead>
  <tr>
    <th>Empleado</th>
    <th>Tipo</th>
    <th>D√≠as</th>
    <th>Retardos</th>
    <th>Faltas</th>
    <th>Descuento</th>
    <th>Pago Final</th>
    <th>Estado</th>
    <th>Acci√≥n</th>
  </tr>
</thead>
    <tbody id="tableBody">
      <!-- Se llena din√°micamente -->
    </tbody>
  </table>
</div>
    <!-- Modal para Editar N√≥mina Manual -->
    <div class="modal fade" id="modalEditarNomina" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-pencil-square me-2"></i>Editar N√≥mina Manual
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Edici√≥n Manual:</strong> Los cambios aqu√≠ tienen prioridad sobre el sistema autom√°tico.
            </div>
            
            <form id="formEditarNomina">
              <input type="hidden" id="editEmpleadoId">
              
              <!-- Informaci√≥n del empleado -->
              <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                  <h6 class="mb-0" id="editEmpleadoNombre">Empleado</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <span class="badge bg-secondary" id="editEmpleadoTipo">Tipo</span>
                      <span class="badge bg-success ms-2" id="editSalarioBase">$0</span>
                    </div>
                    <div class="col-md-6 text-end">
                      <small class="text-muted">Per√≠odo: <span id="editPeriodo"></span></small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Ajustes de asistencia -->
              <div class="card mb-3">
                <div class="card-header">
                  <h6 class="mb-0"><i class="bi bi-calendar-check me-2"></i>Ajustes de Asistencia</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3">
                      <label class="form-label">D√≠as Trabajados</label>
                      <input type="number" id="editDiasTrabajados" class="form-control" min="0" max="10">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Retardos</label>
                      <input type="number" id="editRetardos" class="form-control" min="0" max="20">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">D√≠as Extra (S√°bados)</label>
                      <input type="number" id="editDiasExtra" class="form-control" min="0" max="5">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Bono Extra ($)</label>
                      <input type="number" id="editBonoExtra" class="form-control" min="0" step="50">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Justificaciones -->
              <div class="card mb-3">
                <div class="card-header">
                  <h6 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Ausencias y Justificaciones</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="tieneVacaciones">
                        <label class="form-check-label" for="tieneVacaciones">
                          <strong>Vacaciones</strong>
                        </label>
                      </div>
                      <input type="number" id="diasVacaciones" class="form-control mt-2" min="0" max="10" placeholder="D√≠as" disabled>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="tieneIncapacidad">
                        <label class="form-check-label" for="tieneIncapacidad">
                          <strong>Incapacidad</strong>
                        </label>
                      </div>
                      <input type="number" id="diasIncapacidad" class="form-control mt-2" min="0" max="10" placeholder="D√≠as" disabled>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="tieneViaje">
                        <label class="form-check-label" for="tieneViaje">
                          <strong>Viaje de Negocios</strong>
                        </label>
                      </div>
                      <input type="number" id="diasViaje" class="form-control mt-2" min="0" max="10" placeholder="D√≠as" disabled>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Comentarios -->
              <div class="mb-3">
                <label class="form-label">Comentarios/Observaciones</label>
                <textarea id="editComentarios" class="form-control" rows="3" placeholder="Ejemplo: Paulina estuvo en viaje de negocios en Alemania del 1 al 6 de septiembre"></textarea>
              </div>

              <!-- Vista previa del c√°lculo -->
              <div class="card bg-light">
                <div class="card-header">
                  <h6 class="mb-0"><i class="bi bi-calculator me-2"></i>Vista Previa del C√°lculo</h6>
                </div>
                <div class="card-body">
                  <div class="row" id="previaC√°lculo">
                    <!-- Se llena din√°micamente -->
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnGuardarEdicion">
              <i class="bi bi-save me-2"></i>Guardar Cambios
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Firebase Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, setDoc, getDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD2o2FyUwVZafKIv-qtM6fmA663ldB_1Uo",
      authDomain: "qr-acceso-cielito-home.firebaseapp.com",
      projectId: "qr-acceso-cielito-home",
      storageBucket: "qr-acceso-cielito-home.appspot.com",
      messagingSenderId: "229634415256",
      appId: "1:229634415256:web:c576ba8879e58e441c4eed"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let empleadosGlobales = [];
    let resultadosNomina = [];

    let cambiosManuales = {}; // Para guardar ediciones manuales
    let historialCambios = [];

    // Configurar fecha actual por defecto
    const hoy = new Date();
    document.getElementById('monthSelect').value = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;

    // Funci√≥n para formatear n√∫meros con comas
    function formatearNumero(numero) {
      return numero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // Sistema de notificaciones
    function mostrarNotificacion(mensaje, tipo = 'info', duracion = 4000) {
      const existingNotifications = document.querySelectorAll('.custom-notification');
      existingNotifications.forEach(notif => notif.remove());

      const notification = document.createElement('div');
      notification.className = `custom-notification notification-${tipo}`;
      
      const iconos = {
        'success': 'bi-check-circle-fill',
        'error': 'bi-x-circle-fill',
        'warning': 'bi-exclamation-triangle-fill',
        'info': 'bi-info-circle-fill'
      };

      notification.innerHTML = `
        <div class="notification-content">
          <div class="notification-icon">
            <i class="bi ${iconos[tipo] || iconos.info}"></i>
          </div>
          <div class="notification-message">${mensaje}</div>
          <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="notification-progress"></div>
      `;

      document.body.appendChild(notification);
      setTimeout(() => notification.classList.add('show'), 100);

      if (duracion > 0) {
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 300);
        }, duracion);
      }
    }

    // Verificar autenticaci√≥n
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      const adminEmails = [
        'sistemas16ch@gmail.com',
        'sistemas16cielitohome@gmail.com',
        'leticia@cielitohome.com',
        'sistemas@cielitohome.com',
        'direcciongeneral@cielitohome.com'
      ];
      
      if (!adminEmails.includes(user.email)) {
        mostrarNotificacion('No tienes permisos para acceder a esta secci√≥n', 'error');
        setTimeout(() => window.location.href = 'admin.html', 2000);
        return;
      }

      cargarEmpleados();
    });

    // Funci√≥n para manejar caja de ahorro
    window.toggleCajaAhorro = function() {
      const checkbox = document.getElementById('tieneCajaAhorro');
      const options = document.getElementById('cajaAhorroOptions');
      options.style.display = checkbox.checked ? 'block' : 'none';
      
      if (!checkbox.checked) {
        document.getElementById('montoCajaAhorro').value = '';
      }
    };

    // Funci√≥n para cargar empleados
    async function cargarEmpleados() {
      try {
        const usuariosQuery = query(collection(db, "usuarios"));
        const usuariosSnapshot = await getDocs(usuariosQuery);
        
        empleadosGlobales = [];
        const select = document.getElementById('employeeSelect');
        select.innerHTML = '<option value="">Seleccionar empleado...</option>';
        
        usuariosSnapshot.forEach(doc => {
          const userData = doc.data();
          empleadosGlobales.push({
            uid: doc.id,
            ...userData
          });
          
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = `${userData.nombre} (${userData.tipo || 'Sin tipo'})`;
          select.appendChild(option);
        });
        
        await actualizarDashboardCajaAhorro();
        
      } catch (error) {
        console.error('Error cargando empleados:', error);
        mostrarNotificacion('Error al cargar empleados', 'error');
      }
    }

    // Gesti√≥n de salarios individuales
    window.toggleSalaryManager = function() {
      const manager = document.getElementById('salaryManager');
      manager.style.display = manager.style.display === 'none' ? 'block' : 'none';
    };

    window.loadEmployeeSalary = function() {
      const employeeId = document.getElementById('employeeSelect').value;
      if (!employeeId) return;

      const empleado = empleadosGlobales.find(emp => emp.uid === employeeId);
      if (!empleado) return;

      document.getElementById('employeeSalaryForm').style.display = 'block';
      document.getElementById('individualSalary').value = empleado.salarioQuincenal || '';
      document.getElementById('individualHours').value = empleado.horasQuincenal || '';
      
      document.getElementById('tieneIMSS').checked = empleado.tieneIMSS || false;
      document.getElementById('tieneCajaAhorro').checked = empleado.tieneCajaAhorro || false;
      document.getElementById('montoCajaAhorro').value = empleado.montoCajaAhorro || '';
      
      toggleCajaAhorro();
      calcularPagoPorDia();
    };

    // Calcular pago por d√≠a autom√°ticamente
    document.getElementById('individualSalary').addEventListener('input', calcularPagoPorDia);
    document.getElementById('individualHours').addEventListener('input', calcularPagoPorDia);

    function calcularPagoPorDia() {
      const salary = parseFloat(document.getElementById('individualSalary').value) || 0;
      const dailyRate = salary / 10;
      document.getElementById('dailyRate').value = dailyRate.toFixed(2);
    }

    window.saveEmployeeSalary = async function() {
      const employeeId = document.getElementById('employeeSelect').value;
      const salary = parseFloat(document.getElementById('individualSalary').value);
      const hours = parseInt(document.getElementById('individualHours').value);
      const tieneIMSS = document.getElementById('tieneIMSS').checked;
      const tieneCajaAhorro = document.getElementById('tieneCajaAhorro').checked;
      const montoCajaAhorro = parseFloat(document.getElementById('montoCajaAhorro').value) || 0;

      if (!employeeId || !salary || !hours) {
        mostrarNotificacion('Complete todos los campos obligatorios', 'warning');
        return;
      }

      if (tieneCajaAhorro && montoCajaAhorro <= 0) {
        mostrarNotificacion('Si participa en caja de ahorro, debe especificar el monto', 'warning');
        return;
      }

      try {
        const empleadoRef = doc(db, 'usuarios', employeeId);
        await updateDoc(empleadoRef, {
          salarioQuincenal: salary,
          horasQuincenal: hours,
          pagoPorHora: salary / hours,
          pagoPorDia: salary / 10,
          tieneIMSS: tieneIMSS,
          tieneCajaAhorro: tieneCajaAhorro,
          montoCajaAhorro: tieneCajaAhorro ? montoCajaAhorro : 0
        });

        mostrarNotificacion('Configuraci√≥n guardada correctamente', 'success');
        await cargarEmpleados();
        await actualizarDashboardCajaAhorro();
        document.getElementById('employeeSalaryForm').style.display = 'none';
        document.getElementById('employeeSelect').value = '';
      } catch (error) {
        console.error('Error guardando configuraci√≥n:', error);
        mostrarNotificacion('Error al guardar la configuraci√≥n', 'error');
      }
    };

    window.clearEmployeeSalary = async function() {
      const employeeId = document.getElementById('employeeSelect').value;
      if (!employeeId) return;

      if (!confirm('¬øEliminar configuraci√≥n de salario para este empleado?')) return;

      try {
        const empleadoRef = doc(db, 'usuarios', employeeId);
        await updateDoc(empleadoRef, {
          salarioQuincenal: null,
          horasQuincenal: null,
          pagoPorHora: null,
          pagoPorDia: null,
          tieneIMSS: false,
          tieneCajaAhorro: false,
          montoCajaAhorro: 0
        });

        mostrarNotificacion('Configuraci√≥n eliminada correctamente', 'success');
        await cargarEmpleados();
        await actualizarDashboardCajaAhorro();
        document.getElementById('employeeSalaryForm').style.display = 'none';
        document.getElementById('employeeSelect').value = '';
      } catch (error) {
        console.error('Error eliminando configuraci√≥n:', error);
        mostrarNotificacion('Error al eliminar la configuraci√≥n', 'error');
      }
    };

    // Dashboard caja de ahorro
    async function actualizarDashboardCajaAhorro() {
      try {
        const empleadosConCaja = empleadosGlobales.filter(emp => emp.tieneCajaAhorro);
        
        if (empleadosConCaja.length === 0) {
          document.getElementById('cajaAhorroDashboard').style.display = 'none';
          return;
        }
        
        document.getElementById('cajaAhorroDashboard').style.display = 'block';
        
        let totalParticipantes = empleadosConCaja.length;
        let ahorroQuincenalTotal = empleadosConCaja.reduce((sum, emp) => sum + (emp.montoCajaAhorro || 0), 0);
        let ahorroMensualTotal = ahorroQuincenalTotal * 2;
        let ahorroAnualTotal = ahorroMensualTotal * 12;
        
        const statsContainer = document.getElementById('cajaAhorroStats');
        statsContainer.innerHTML = `
          <div class="col-md-3">
            <div class="stat-card text-center p-3">
              <h4 class="text-success">${totalParticipantes}</h4>
              <small class="text-muted">Participantes</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card text-center p-3">
              <h4 class="text-success">$${formatearNumero(ahorroQuincenalTotal)}</h4>
              <small class="text-muted">Por Quincena</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card text-center p-3">
              <h4 class="text-success">$${formatearNumero(ahorroMensualTotal)}</h4>
              <small class="text-muted">Por Mes</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card text-center p-3">
              <h4 class="text-success">$${formatearNumero(ahorroAnualTotal)}</h4>
              <small class="text-muted">Por A√±o</small>
            </div>
          </div>
        `;
        
        if (totalParticipantes > 0) {
          const detalleHTML = empleadosConCaja.map(emp => `
            <div class="col-md-6 mb-2">
              <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                <span><strong>${emp.nombre}</strong></span>
                <span class="badge bg-success">$${formatearNumero(emp.montoCajaAhorro || 0)}/quincena</span>
              </div>
            </div>
          `).join('');
          
          statsContainer.innerHTML += `
            <div class="col-md-12 mt-3">
              <h6><i class="bi bi-people me-2"></i>Detalle por Empleado:</h6>
              <div class="row">
                ${detalleHTML}
              </div>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Error actualizando dashboard caja de ahorro:', error);
      }
    }

    // Funci√≥n para calcular d√≠as laborales en per√≠odos
    function calcularDiasLaboralesPeriodo(a√±o, mes, periodo) {
      const diasLaborales = [];
      const ultimoDia = new Date(a√±o, mes, 0).getDate();
      
      for (let dia = 1; dia <= ultimoDia; dia++) {
        const fecha = new Date(a√±o, mes - 1, dia);
        const diaSemana = fecha.getDay();
        
        if (diaSemana >= 1 && diaSemana <= 5) {
          diasLaborales.push(dia);
        }
      }
      
      if (periodo === 'primera') {
        return diasLaborales.slice(0, 10);
      } else {
        return diasLaborales.slice(10, 20);
      }
    }

    // Variables globales para edici√≥n
    let quinceActual = '';
    let mesActual = '';
    let mesActualNum = 0;
    let a√±oActualNum = 0;

    function getTipoNombre(tipo) {
      switch(tipo) {
        case 'tiempo_completo': return 'T.Completo';
        case 'becario': return 'Becario';
        case 'horario_especial': return 'H.Especial';
        default: return tipo;
      }
    }

    // Funci√≥n principal para calcular n√≥mina OPTIMIZADA
window.calcularNomina = async function() {
  const monthSelect = document.getElementById('monthSelect').value;
  const quinceSelect = document.getElementById('quinceSelect').value;
  
  if (!monthSelect) {
    mostrarNotificacion('Selecciona un mes', 'warning');
    return;
  }

  mesActualNum = parseInt(monthSelect.split('-')[1]);
  a√±oActualNum = parseInt(monthSelect.split('-')[0]);
  quinceActual = quinceSelect === 'primera' ? 'Per√≠odo 1' : 'Per√≠odo 2';
  
  const existeNomina = await verificarNominaExistente();
  if (existeNomina) return;
  
  document.getElementById('loadingSpinner').style.display = 'block';
  document.getElementById('summaryCard').style.display = 'none';
  document.getElementById('resultsContainer').innerHTML = '';
  document.getElementById('exportBtn').style.display = 'none';

  try {
    const [a√±o, mes] = monthSelect.split('-');
    const mesNum = parseInt(mes);
    const a√±oNum = parseInt(a√±o);

    console.log(`üìÖ Calculando per√≠odo: ${quinceSelect} de ${mesNum}/${a√±oNum}`);

    const diasLaborales = calcularDiasLaboralesPeriodo(a√±oNum, mesNum, quinceSelect);
    
    console.log(`üìä D√≠as laborales del per√≠odo:`, diasLaborales);
    console.log(`üìä Total d√≠as laborales esperados: ${diasLaborales.length}`);

    // ‚úÖ CONSULTA OPTIMIZADA DE EMPLEADOS
    const usuariosQuery = query(collection(db, "usuarios"));
    const usuariosSnapshot = await getDocs(usuariosQuery);
    
    const empleados = [];
    usuariosSnapshot.forEach(doc => {
      const userData = doc.data();
      
      if (!userData || !userData.nombre) {
        console.warn('‚ö†Ô∏è Usuario sin datos v√°lidos:', doc.id);
        return;
      }
      
      if (userData.salarioQuincenal && userData.horasQuincenal) {
        empleados.push({
          uid: doc.id,
          nombre: userData.nombre,
          email: userData.email || 'sin-email@cielitohome.com',
          tipo: userData.tipo || 'tiempo_completo',
          salarioQuincenal: userData.salarioQuincenal,
          horasQuincenal: userData.horasQuincenal,
          pagoPorDia: userData.salarioQuincenal / 10,
          tieneIMSS: userData.tieneIMSS || false,
          tieneCajaAhorro: userData.tieneCajaAhorro || false,
          montoCajaAhorro: userData.montoCajaAhorro || 0,
          esIndividual: true
        });
      } else {
        console.warn('‚ö†Ô∏è Usuario sin configuraci√≥n salarial:', userData.nombre);
      }
    });

    if (empleados.length === 0) {
      mostrarNotificacion('‚ùå No hay empleados con salarios configurados.\n\nUse "Gestionar Salarios" para configurar los salarios de cada empleado.', 'error', 6000);
      document.getElementById('loadingSpinner').style.display = 'none';
      return;
    }

    console.log('üîç Consultando registros FILTRADOS POR FECHA...');
    
    // ‚úÖ CONSULTA ULTRA OPTIMIZADA: FILTRAR POR FECHAS EN FIRESTORE
    const fechaInicio = `${a√±oNum}-${String(mesNum).padStart(2, '0')}-${String(Math.min(...diasLaborales)).padStart(2, '0')}`;
    const fechaFin = `${a√±oNum}-${String(mesNum).padStart(2, '0')}-${String(Math.max(...diasLaborales)).padStart(2, '0')}`;
    

const registrosQuery = query(
  collection(db, "registros"),
  where("tipoEvento", "==", "entrada"),   // ‚úÖ Campo correcto
  where("fecha", ">=", fechaInicio),
  where("fecha", "<=", fechaFin)
);

    const registrosSnapshot = await getDocs(registrosQuery);
    console.log(`üìä Registros obtenidos (filtrados): ${registrosSnapshot.size}`);
    
    // ‚úÖ FILTRADO FINAL EN MEMORIA SOLO POR D√çAS LABORALES
    const registrosPorEmpleado = {};
    let registrosProcesados = 0;
    
    registrosSnapshot.forEach(doc => {
  const registro = doc.data();
  const uid = registro.uid;
  
  const fechaRegistro = registro.fecha;
  if (!fechaRegistro) return;
  
  const [regA√±o, regMes, regDia] = fechaRegistro.split('-').map(Number);
  
  // ‚úÖ FILTRO RESTRICTIVO EN MEMORIA (M√ÅS EFICIENTE)
  if (regA√±o === a√±oNum && regMes === mesNum && diasLaborales.includes(regDia)) {
    if (!registrosPorEmpleado[uid]) {
      registrosPorEmpleado[uid] = [];
    }
    registrosPorEmpleado[uid].push(registro);
    registrosProcesados++;
  }
});
  

    console.log(`üìä Registros procesados para el per√≠odo: ${registrosProcesados}`);

    // ‚úÖ C√ÅLCULO DE N√ìMINA SIN AUSENCIAS
    const resultados = [];
    let totalRetardos = 0;
    let empleadosConDescuento = 0;
    let totalNominaFinal = 0;

    for (const empleado of empleados) {
      try {
        const registros = registrosPorEmpleado[empleado.uid] || [];
        
        const salarioQuincenal = empleado.salarioQuincenal;
        const pagoPorDia = empleado.pagoPorDia;

        let retardos = 0;
        let diasTrabajados = registros.length;
        const detalleRetardos = [];
        const diasAsistidos = [];

        registros.forEach(registro => {
          const [regA√±o, regMes, regDia] = registro.fecha.split('-').map(Number);
          diasAsistidos.push(regDia);
          
          if (registro.estado === 'retardo') {
            retardos++;
            detalleRetardos.push({
              fecha: registro.fecha,
              hora: registro.hora
            });
          }
        });

        const diasFaltantes = diasLaborales.filter(dia => !diasAsistidos.includes(dia));
        const diasDescuento = Math.floor(retardos / 4);
        const diasEfectivos = diasTrabajados - diasDescuento;
        const pagoTotal = Math.max(0, diasEfectivos * pagoPorDia);

        // Aplicar descuentos IMSS y Caja
        let descuentoIMSS = 0;
        let descuentoCaja = 0;
        
        if (empleado.tieneIMSS) {
          descuentoIMSS = 300;
        }
        
        if (empleado.tieneCajaAhorro && empleado.montoCajaAhorro) {
          descuentoCaja = empleado.montoCajaAhorro;
        }
        
        const totalDescuentos = descuentoIMSS + descuentoCaja;
        const pagoFinal = Math.max(0, pagoTotal - totalDescuentos);
        
        if (diasDescuento > 0 || totalDescuentos > 0) empleadosConDescuento++;
        totalRetardos += retardos;

        // Determinar estado
        let status, statusClass;
        if (diasFaltantes.length > 0) {
          status = `${diasFaltantes.length} falta${diasFaltantes.length > 1 ? 's' : ''} ‚Ä¢ ${retardos} retardo${retardos !== 1 ? 's' : ''}`;
          statusClass = 'status-penalty';
        } else if (diasDescuento > 0) {
          status = `Descuento: ${diasDescuento} d√≠a${diasDescuento > 1 ? 's' : ''}`;
          statusClass = 'status-penalty';
        } else if (retardos >= 3) {
          status = 'En l√≠mite de retardos';
          statusClass = 'status-warning';
        } else {
          status = 'Sin penalizaciones';
          statusClass = 'status-ok';
        }

        // ‚úÖ RESULTADO FINAL LIMPIO (SIN AUSENCIAS)
        const resultado = {
          empleado,
          salarioQuincenal,
          diasLaboralesEsperados: diasLaborales.length,
          diasTrabajados,
          diasFaltantes: diasFaltantes.length,
          retardos,
          diasDescuento,
          diasEfectivos,
          pagoPorDia: Math.round(pagoPorDia),
          pagoTotal: Math.round(pagoTotal),
          descuentoIMSS,
          descuentoCaja,
          totalDescuentos,
          pagoFinal: Math.round(pagoFinal),
          status,
          statusClass,
          detalleRetardos,
          diasAsistidos,
          diasFaltantesDetalle: diasFaltantes
        };
        
        resultados.push(resultado);
        totalNominaFinal += Math.round(resultado.pagoFinal);
        
      } catch (error) {
        console.error(`‚ùå Error procesando empleado ${empleado.nombre}:`, error);
        mostrarNotificacion(`Error procesando ${empleado.nombre}, se omitir√°`, 'warning');
      }
    }

    // Actualizar variables globales
    quinceActual = quinceSelect === 'primera' ? 'Per√≠odo 1' : 'Per√≠odo 2';
    mesActual = `${mesNum}/${a√±oNum}`;
    mesActualNum = mesNum;
    a√±oActualNum = a√±oNum;

    resultadosNomina = resultados;

    mostrarResultados(resultados, empleados.length, totalRetardos, empleadosConDescuento, totalNominaFinal, quinceSelect, monthSelect);

  } catch (error) {
    console.error('Error calculando n√≥mina:', error);
    mostrarNotificacion('Error al calcular la n√≥mina: ' + error.message, 'error');
  } finally {
    document.getElementById('loadingSpinner').style.display = 'none';
  }
};



    // Funci√≥n para mostrar resultados
function mostrarResultados(resultados, totalEmpleados, totalRetardos, empleadosConDescuento, totalPago, periodo, mes) {
  // Actualizar resumen
  document.getElementById('totalEmployees').textContent = totalEmpleados;
  document.getElementById('totalRetards').textContent = totalRetardos;
  document.getElementById('employeesWithPenalty').textContent = empleadosConDescuento;
  document.getElementById('totalPayout').textContent = `$${formatearNumero(totalPago)}`;
  document.getElementById('summaryCard').style.display = 'block';
  document.getElementById('viewControls').style.display = 'block';
  document.getElementById('saveBtn').style.display = 'inline-block';
  document.getElementById('exportBtn').style.display = 'inline-block';

  // Limpiar contenedores
  document.getElementById('resultsContainer').innerHTML = '';
  document.getElementById('tableBody').innerHTML = '';

  // Mostrar vista compacta por defecto
  mostrarVistaCompacta(resultados);
  llenarTabla(resultados);

  document.getElementById('exportBtn').style.display = 'inline-block';
}

// Funci√≥n para cambiar vista
window.cambiarVista = function(tipo) {
  const compactaBtn = document.getElementById('btnVistaCompacta');
  const tablaBtn = document.getElementById('btnVistaTabla');
  const container = document.getElementById('resultsContainer');
  const tableContainer = document.getElementById('tableContainer');

  // Remover clase active
  [compactaBtn, tablaBtn].forEach(btn => btn.classList.remove('active'));

  if (tipo === 'compacta') {
    compactaBtn.classList.add('active');
    container.style.display = 'grid';
    tableContainer.style.display = 'none';
    container.className = 'employee-grid-compact';
    mostrarVistaCompacta(resultadosNomina);
  } else if (tipo === 'tabla') {
    tablaBtn.classList.add('active');
    container.style.display = 'none';
    tableContainer.style.display = 'block';
  }
};

// Vista compacta (nueva)
function mostrarVistaCompacta(resultados) {
  const container = document.getElementById('resultsContainer');
  container.innerHTML = '';

  resultados.forEach(resultado => {
    const empleadoCard = document.createElement('div');
    empleadoCard.className = 'employee-card-compact';
    empleadoCard.setAttribute('data-empleado-id', resultado.empleado.uid);

    const tipoNombre = getTipoNombre(resultado.empleado.tipo);
    const pagoFinalMostrar = resultado.pagoFinalConJustificaciones || resultado.pagoFinal;
    
    empleadoCard.innerHTML = `
      <div class="compact-header">
        <div class="compact-name">
          <strong>${resultado.empleado.nombre}</strong>
          <span class="badge bg-secondary ms-2">${tipoNombre}</span>
          ${resultado.editadoManualmente ? '<span class="badge bg-purple ms-1">E</span>' : ''}
        </div>
        <button class="btn btn-sm btn-outline-primary" onclick="abrirEdicionNomina('${resultado.empleado.uid}')">
          <i class="bi bi-pencil"></i>
        </button>
      </div>
      
      <div class="compact-stats">
        <div class="compact-stat">
          <span class="stat-value ${resultado.diasTrabajados < resultado.diasLaboralesEsperados ? 'text-warning' : 'text-success'}">${resultado.diasTrabajados}</span>
          <small>D√≠as</small>
        </div>
        <div class="compact-stat">
          <span class="stat-value ${resultado.retardos > 0 ? 'text-warning' : 'text-success'}">${resultado.retardos}</span>
          <small>Retardos</small>
        </div>
        <div class="compact-stat">
          <span class="stat-value ${resultado.diasFaltantes > 0 ? 'text-danger' : 'text-success'}">${resultado.diasFaltantes}</span>
          <small>Faltas</small>
        </div>
        <div class="compact-stat highlight">
          <span class="stat-value text-success">$${formatearNumero(pagoFinalMostrar)}</span>
          <small>Final</small>
        </div>
      </div>
      
      ${resultado.diasDescuento > 0 ? `
        <div class="descuento-badge">
          <div class="alert alert-warning py-2 mb-2">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Descuento: ${resultado.diasDescuento} d√≠a${resultado.diasDescuento > 1 ? 's' : ''}</strong>
            <small class="d-block">Por ${resultado.retardos} retardos (4 retardos = 1 d√≠a)</small>
          </div>
        </div>
      ` : ''}
      
      <div class="compact-details">
        <div class="compact-detail-row">
          <span class="detail-label">Subtotal:</span>
          <span class="detail-value">$${formatearNumero(resultado.pagoTotal)}</span>
        </div>
        
        ${resultado.descuentoIMSS > 0 ? `
          <div class="compact-detail-row discount">
            <span class="detail-label">IMSS:</span>
            <span class="detail-value text-danger">-$${resultado.descuentoIMSS}</span>
          </div>
        ` : ''}
        
        ${resultado.descuentoCaja > 0 ? `
          <div class="compact-detail-row discount">
            <span class="detail-label">Caja de ahorro:</span>
            <span class="detail-value text-danger">-$${formatearNumero(resultado.descuentoCaja)}</span>
          </div>
        ` : ''}
        
        ${resultado.diasDescuento > 0 ? `
          <div class="compact-detail-row discount">
            <span class="detail-label">Descuento por retardos:</span>
            <span class="detail-value text-warning">-${resultado.diasDescuento} d√≠a${resultado.diasDescuento > 1 ? 's' : ''}</span>
          </div>
          <div class="compact-detail-row discount">
            <span class="detail-label">Valor del descuento:</span>
            <span class="detail-value text-danger">-$${formatearNumero(resultado.diasDescuento * resultado.pagoPorDia)}</span>
          </div>
        ` : ''}

        ${resultado.diasFaltantes > 0 ? `
          <div class="compact-detail-row discount">
            <span class="detail-label">Faltas:</span>
            <span class="detail-value text-warning">-${resultado.diasFaltantes} d√≠a${resultado.diasFaltantes > 1 ? 's' : ''}</span>
          </div>
          <div class="compact-detail-row discount">
            <span class="detail-label">Valor de las faltas:</span>
            <span class="detail-value text-danger">-$${formatearNumero(resultado.diasFaltantes * resultado.pagoPorDia)}</span>
          </div>
        ` : ''}
        
      
        
        ${resultado.editadoManualmente ? `
          <div class="compact-detail-row bonus">
            <span class="detail-label">Editado manualmente:</span>
            <span class="detail-value text-purple">S√≠</span>
          </div>
          ${resultado.comentariosEdicion ? `
            <div class="compact-detail-row">
              <span class="detail-label">Comentarios:</span>
              <span class="detail-value text-muted">${resultado.comentariosEdicion}</span>
            </div>
          ` : ''}
        ` : ''}
        
        <div class="compact-detail-row final">
          <span class="detail-label"><strong>PAGO FINAL:</strong></span>
          <span class="detail-value text-success"><strong>$${formatearNumero(pagoFinalMostrar)}</strong></span>
        </div>
      </div>
      
      <div class="compact-status ${resultado.statusClass}">
  ${resultado.diasDescuento > 0 ? 
    resultado.diasFaltantes > 0 ? 
      `${resultado.diasFaltantes} falta${resultado.diasFaltantes > 1 ? 's' : ''} ‚Ä¢ Sin penalizaciones adicionales` :
      `Sin penalizaciones adicionales` :
    resultado.status
  }
</div>
    `;

    container.appendChild(empleadoCard);
  });
}

// ‚úÖ FUNCI√ìN PARA LLENAR LA VISTA DE TABLA
function llenarTabla(resultados) {
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = '';

  resultados.forEach(resultado => {
    const row = document.createElement('tr');
    const tipoNombre = getTipoNombre(resultado.empleado.tipo);
    const pagoFinalMostrar = resultado.pagoFinalConJustificaciones || resultado.pagoFinal;

    // Crear tooltip para descuentos
    let descuentosTooltip = [];
    if (resultado.descuentoIMSS > 0) descuentosTooltip.push(`IMSS: $${formatearNumero(resultado.descuentoIMSS)}`);
    if (resultado.descuentoCaja > 0) descuentosTooltip.push(`Caja: $${formatearNumero(resultado.descuentoCaja)}`);
    if (resultado.diasDescuento > 0) descuentosTooltip.push(`${resultado.diasDescuento} d√≠a(s) por retardos`);

    const descuentosTexto = descuentosTooltip.length > 0 ? descuentosTooltip.join(' ‚Ä¢ ') : 'Sin descuentos';

    row.innerHTML = `
      <td>
        <div class="fw-bold">${resultado.empleado.nombre}</div>
        <small class="text-muted">${resultado.empleado.email || ''}</small>
        ${resultado.editadoManualmente ? '<span class="badge bg-purple ms-1">Editado</span>' : ''}
      </td>
      <td>
        <span class="badge ${resultado.empleado.tipo === 'becario' ? 'bg-info' : 'bg-secondary'}">
          ${tipoNombre}
        </span>
      </td>
      <td class="text-center">
        <div class="pago-detalle">
          <strong>${resultado.diasTrabajados}/${resultado.diasLaboralesEsperados}</strong>
          ${resultado.diasTrabajados < resultado.diasLaboralesEsperados ? 
            `<small class="text-danger d-block">-${resultado.diasLaboralesEsperados - resultado.diasTrabajados} d√≠a(s)</small>` : 
            '<small class="text-success d-block">Completo</small>'
          }
        </div>
      </td>
      <td class="text-center">
        <span class="badge ${resultado.retardos > 0 ? 'bg-warning text-dark' : 'bg-success'}">
          ${resultado.retardos}
        </span>
        ${resultado.retardos > 0 && resultado.detalleRetardos && resultado.detalleRetardos.length > 0 ? 
          `<small class="d-block text-muted">${resultado.detalleRetardos.length} registro(s)</small>` : ''
        }
      </td>
      <td class="text-center">
        <span class="badge ${resultado.diasFaltantes > 0 ? 'bg-danger' : 'bg-success'}">
          ${resultado.diasFaltantes}
        </span>
        ${resultado.diasFaltantes > 0 ? 
          `<small class="text-danger d-block">-$${formatearNumero(resultado.diasFaltantes * resultado.pagoPorDia)}</small>` : 
          '<small class="text-success d-block">Sin faltas</small>'
        }
      </td>
      <td class="descuentos-detalle" title="${descuentosTexto}">
        ${resultado.totalDescuentos > 0 ? `
          <div>
            <span class="badge bg-warning text-dark">$${formatearNumero(resultado.totalDescuentos)}</span>
            ${resultado.descuentoIMSS > 0 ? '<span class="badge bg-info ms-1">IMSS</span>' : ''}
            ${resultado.descuentoCaja > 0 ? '<span class="badge bg-success ms-1">Caja</span>' : ''}
            ${resultado.diasDescuento > 0 ? `<span class="badge bg-warning ms-1">${resultado.diasDescuento}d</span>` : ''}
          </div>
        ` : `
          <span class="text-success">Sin descuentos</span>
        `}
      </td>
      <td class="text-end">
        <div class="pago-detalle">
          <strong class="text-success">$${formatearNumero(pagoFinalMostrar)}</strong>
          <small class="text-muted d-block">Base: $${formatearNumero(resultado.pagoTotal)}</small>
        </div>
      </td>
      <td class="text-center">
        <span class="badge bg-${resultado.statusClass === 'status-ok' ? 'success' : 
                                 resultado.statusClass === 'status-warning' ? 'warning text-dark' : 'danger'}">
          ${resultado.statusClass === 'status-ok' ? 'OK' : 
            resultado.statusClass === 'status-warning' ? 'Alerta' : 'Penalizaci√≥n'}
        </span>
        <small class="d-block text-muted mt-1" style="font-size: 0.7rem;">
          ${resultado.status}
        </small>
      </td>
      <td class="text-center">
        <button class="btn btn-sm btn-outline-primary" onclick="abrirEdicionNomina('${resultado.empleado.uid}')" title="Editar n√≥mina">
          <i class="bi bi-pencil"></i>
        </button>
      </td>
    `;

    // A√±adir clase de estado para la fila completa
    if (resultado.statusClass === 'status-penalty') {
      row.classList.add('bg-status-penalty');
    } else if (resultado.statusClass === 'status-warning') {
      row.classList.add('bg-status-warning');
    } else {
      row.classList.add('bg-status-ok');
    }

    tbody.appendChild(row);
  });
}



    // Configurar checkboxes de justificaciones
    function configurarCheckboxesJustificaciones() {
      const checkboxes = [
        { check: 'tieneVacaciones', input: 'diasVacaciones' },
        { check: 'tieneIncapacidad', input: 'diasIncapacidad' },
        { check: 'tieneViaje', input: 'diasViaje' }
      ];
      
      checkboxes.forEach(({ check, input }) => {
        document.getElementById(check).addEventListener('change', function() {
          document.getElementById(input).disabled = !this.checked;
          if (!this.checked) document.getElementById(input).value = '';
          calcularPreviaEdicion();
        });
      });

      ['editDiasTrabajados', 'editRetardos', 'editDiasExtra', 'editBonoExtra', 
       'diasVacaciones', 'diasIncapacidad', 'diasViaje'].forEach(id => {
        document.getElementById(id).addEventListener('input', calcularPreviaEdicion);
      });
    }

   // Funci√≥n para abrir modal de edici√≥n
window.abrirEdicionNomina = function(empleadoId) {
  // Buscar el resultado en la variable global
  const resultado = resultadosNomina.find(r => r.empleado.uid === empleadoId);
  if (!resultado) {
    mostrarNotificacion('No se encontraron datos del empleado', 'error');
    return;
  }
  
  document.getElementById('editEmpleadoId').value = empleadoId;
  document.getElementById('editEmpleadoNombre').textContent = resultado.empleado.nombre;
  document.getElementById('editEmpleadoTipo').textContent = getTipoNombre(resultado.empleado.tipo);
  document.getElementById('editSalarioBase').textContent = `$${formatearNumero(resultado.salarioQuincenal)}`;
  document.getElementById('editPeriodo').textContent = `${quinceActual} - ${mesActual}`;
  
  document.getElementById('editDiasTrabajados').value = resultado.diasTrabajados;
  document.getElementById('editRetardos').value = resultado.retardos;
  document.getElementById('editDiasExtra').value = 0;
  document.getElementById('editBonoExtra').value = 0;
  
  ['tieneVacaciones', 'tieneIncapacidad', 'tieneViaje'].forEach(id => {
    document.getElementById(id).checked = false;
    document.getElementById(id.replace('tiene', 'dias')).disabled = true;
    document.getElementById(id.replace('tiene', 'dias')).value = '';
  });
  
  document.getElementById('editComentarios').value = '';
  window.datosOriginales = { ...resultado };
  
  calcularPreviaEdicion();
  new bootstrap.Modal(document.getElementById('modalEditarNomina')).show();
};

  
    // Funci√≥n para calcular vista previa
    function calcularPreviaEdicion() {
      if (!window.datosOriginales) return;
      
      const original = window.datosOriginales;
      const diasTrabajados = parseInt(document.getElementById('editDiasTrabajados').value) || 0;
      const retardos = parseInt(document.getElementById('editRetardos').value) || 0;
      const diasExtra = parseInt(document.getElementById('editDiasExtra').value) || 0;
      const bonoExtra = parseFloat(document.getElementById('editBonoExtra').value) || 0;
      
      let diasJustificados = 0;
      if (document.getElementById('tieneVacaciones').checked) {
        diasJustificados += parseInt(document.getElementById('diasVacaciones').value) || 0;
      }
      if (document.getElementById('tieneIncapacidad').checked) {
        diasJustificados += parseInt(document.getElementById('diasIncapacidad').value) || 0;
      }
      if (document.getElementById('tieneViaje').checked) {
        diasJustificados += parseInt(document.getElementById('diasViaje').value) || 0;
      }

      const diasDescuentoPorRetardos = Math.floor(retardos / 4);
      const diasEfectivos = Math.max(0, diasTrabajados - diasDescuentoPorRetardos);
      const diasTotalesAPagar = diasEfectivos + diasJustificados + diasExtra;
      
      const pagoBase = diasTotalesAPagar * original.pagoPorDia;
      const pagoConBono = pagoBase + bonoExtra;
      
      const descuentoIMSS = original.empleado.tieneIMSS ? 300 : 0;
      const descuentoCaja = original.empleado.tieneCajaAhorro ? (original.empleado.montoCajaAhorro || 0) : 0;
      const pagoFinal = Math.max(0, pagoConBono - descuentoIMSS - descuentoCaja);
      
      document.getElementById('previaC√°lculo').innerHTML = `
        <div class="col-md-6">
          <h6>C√°lculo Detallado:</h6>
          <ul class="list-unstyled">
            <li>‚Ä¢ D√≠as efectivos trabajados: <strong>${diasEfectivos}</strong></li>
            <li>‚Ä¢ D√≠as justificados (pagados): <strong>${diasJustificados}</strong></li>
            <li>‚Ä¢ D√≠as extra (s√°bados): <strong>${diasExtra}</strong></li>
            <li>‚Ä¢ Pago por d√≠a: <strong>$${formatearNumero(original.pagoPorDia)}</strong></li>
            <li>‚Ä¢ Descuento por ${diasDescuentoPorRetardos} d√≠a(s): <strong>-$${formatearNumero(diasDescuentoPorRetardos * original.pagoPorDia)}</strong></li>
          </ul>
        </div>
        <div class="col-md-6">
          <h6>Totales:</h6>
          <ul class="list-unstyled">
            <li>‚Ä¢ Subtotal: <strong>$${formatearNumero(Math.round(pagoBase))}</strong></li>
            ${bonoExtra > 0 ? `<li>‚Ä¢ Bono extra: <strong>+$${formatearNumero(bonoExtra)}</strong></li>` : ''}
            ${descuentoIMSS > 0 ? `<li>‚Ä¢ IMSS: <strong>-$${descuentoIMSS}</strong></li>` : ''}
            ${descuentoCaja > 0 ? `<li>‚Ä¢ Caja de ahorro: <strong>-$${formatearNumero(descuentoCaja)}</strong></li>` : ''}
            <li class="border-top pt-2 mt-2"><strong>PAGO FINAL: $${formatearNumero(Math.round(pagoFinal))}</strong></li>
          </ul>
        </div>
      `;
    }

    // Funci√≥n para guardar edici√≥n manual
window.guardarEdicionManual = async function() {
  try {
    const empleadoId = document.getElementById('editEmpleadoId').value;
    const diasTrabajados = parseInt(document.getElementById('editDiasTrabajados').value) || 0;
    const retardos = parseInt(document.getElementById('editRetardos').value) || 0;
    const diasExtra = parseInt(document.getElementById('editDiasExtra').value) || 0;
    const bonoExtra = parseFloat(document.getElementById('editBonoExtra').value) || 0;
    
    // Obtener justificaciones
    let diasJustificados = 0;
    let justificacionesDetalle = [];
    
    if (document.getElementById('tieneVacaciones').checked) {
      const dias = parseInt(document.getElementById('diasVacaciones').value) || 0;
      diasJustificados += dias;
      justificacionesDetalle.push(`Vacaciones: ${dias} d√≠as`);
    }
    if (document.getElementById('tieneIncapacidad').checked) {
      const dias = parseInt(document.getElementById('diasIncapacidad').value) || 0;
      diasJustificados += dias;
      justificacionesDetalle.push(`Incapacidad: ${dias} d√≠as`);
    }
    if (document.getElementById('tieneViaje').checked) {
      const dias = parseInt(document.getElementById('diasViaje').value) || 0;
      diasJustificados += dias;
      justificacionesDetalle.push(`Viaje de negocios: ${dias} d√≠as`);
    }
    
    const comentarios = document.getElementById('editComentarios').value;
    
    // Guardar cambios manuales
    cambiosManuales[empleadoId] = {
      diasTrabajados,
      retardos,
      diasExtra,
      bonoExtra,
      diasJustificados,
      justificacionesDetalle,
      comentarios,
      editadoManualmente: true,
      fechaEdicion: new Date().toISOString()
    };
    
    // Agregar al historial
    historialCambios.push({
      empleadoId,
      tipo: 'edicion_manual',
      cambios: cambiosManuales[empleadoId],
      timestamp: new Date().toISOString()
    });
    
    // Recalcular y actualizar la tarjeta espec√≠fica
    actualizarTarjetaEmpleado(empleadoId);
    
    mostrarNotificacion(`‚úÖ Cambios guardados para ${window.datosOriginales.empleado.nombre}\n${comentarios ? 'Comentario: ' + comentarios : 'Sin comentarios'}`, 'success');
    
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarNomina'));
    modal.hide();
    
    // Actualizar resumen general
    recalcularResumenGeneral();
    
  } catch (error) {
    console.error('Error guardando edici√≥n manual:', error);
    mostrarNotificacion('Error al guardar los cambios', 'error');
  }
};

// Funci√≥n para actualizar una tarjeta espec√≠fica
function actualizarTarjetaEmpleado(empleadoId) {
  const resultadoIndex = resultadosNomina.findIndex(r => r.empleado.uid === empleadoId);
  if (resultadoIndex === -1) return;
  
  let resultado = { ...resultadosNomina[resultadoIndex] };
  const cambiosManual = cambiosManuales[empleadoId];
  
  if (cambiosManual) {
    // Aplicar cambios manuales
    const original = window.datosOriginales;
    const diasDescuentoPorRetardos = Math.floor(cambiosManual.retardos / 4);
    const diasEfectivos = Math.max(0, cambiosManual.diasTrabajados - diasDescuentoPorRetardos);
    const diasTotalesAPagar = diasEfectivos + cambiosManual.diasJustificados + cambiosManual.diasExtra;
    
    const pagoBase = diasTotalesAPagar * resultado.pagoPorDia;
    const pagoConBono = pagoBase + cambiosManual.bonoExtra;
    const pagoFinal = Math.max(0, pagoConBono - resultado.totalDescuentos);
    
    // Actualizar resultado
    resultado.diasTrabajados = cambiosManual.diasTrabajados;
    resultado.retardos = cambiosManual.retardos;
    resultado.diasDescuento = diasDescuentoPorRetardos;
    resultado.diasEfectivos = diasEfectivos;
    resultado.diasExtra = cambiosManual.diasExtra;
    resultado.bonoExtra = cambiosManual.bonoExtra;
    resultado.diasJustificados = cambiosManual.diasJustificados;
    resultado.pagoTotal = Math.round(pagoBase);
    resultado.pagoFinal = Math.round(pagoFinal);
    resultado.editadoManualmente = true;
    resultado.comentariosEdicion = cambiosManual.comentarios;
    resultado.justificacionesDetalle = cambiosManual.justificacionesDetalle;
    
    // Actualizar status
    if (resultado.diasFaltantes > 0 || diasDescuentoPorRetardos > 0) {
      resultado.status = `${resultado.diasFaltantes} falta${resultado.diasFaltantes > 1 ? 's' : ''} ‚Ä¢ ${resultado.retardos} retardo${resultado.retardos !== 1 ? 's' : ''}`;
      resultado.statusClass = 'status-penalty';
    } else if (resultado.retardos >= 3) {
      resultado.status = 'En l√≠mite de retardos';
      resultado.statusClass = 'status-warning';
    } else {
      resultado.status = 'Sin penalizaciones';
      resultado.statusClass = 'status-ok';
    }
    
    // Actualizar array principal
    resultadosNomina[resultadoIndex] = resultado;
  }
  
  // Regenerar solo esta tarjeta
  regenerarTarjetaEmpleado(empleadoId, resultado);
}

// Funci√≥n para regenerar tarjeta espec√≠fica
function regenerarTarjetaEmpleado(empleadoId, resultado) {
  // Simplemente regenerar la vista actual
  const vistaActual = document.getElementById('btnVistaCompacta').classList.contains('active') ? 'compacta' : 'tabla';
  
  if (vistaActual === 'compacta') {
    mostrarVistaCompacta(resultadosNomina);
  } else {
    llenarTabla(resultadosNomina);
  }
}

// Funci√≥n para recalcular resumen general
function recalcularResumenGeneral() {
  const totalEmpleados = resultadosNomina.length;
  const totalRetardos = resultadosNomina.reduce((sum, r) => sum + r.retardos, 0);
  const empleadosConDescuento = resultadosNomina.filter(r => r.diasDescuento > 0 || r.totalDescuentos > 0).length;
  const totalPago = resultadosNomina.reduce((sum, r) => sum + r.pagoFinal, 0);
  
  document.getElementById('totalEmployees').textContent = totalEmpleados;
  document.getElementById('totalRetards').textContent = totalRetardos;
  document.getElementById('employeesWithPenalty').textContent = empleadosConDescuento;
  document.getElementById('totalPayout').textContent = `$${formatearNumero(totalPago)}`;
}


    // Funci√≥n para exportar a Excel
    window.exportarExcel = function() {
      if (!resultadosNomina || resultadosNomina.length === 0) {
        mostrarNotificacion('No hay datos para exportar', 'warning');
        return;
      }

      try {
        const datosExcel = resultadosNomina.map(resultado => {
          const pagoFinal = resultado.pagoFinalConJustificaciones || resultado.pagoFinal;
          return {
            'Empleado': resultado.empleado.nombre,
            'Tipo': getTipoNombre(resultado.empleado.tipo),
            'Salario Base': resultado.salarioQuincenal,
            'D√≠as Esperados': resultado.diasLaboralesEsperados,
            'D√≠as Trabajados': resultado.diasTrabajados,
            'Retardos': resultado.retardos,
            'D√≠as de Descuento': resultado.diasDescuento,
            'D√≠as Efectivos': resultado.diasEfectivos,
            'Pago por D√≠a': resultado.pagoPorDia,
            'Subtotal': resultado.pagoTotal,
            'Descuento IMSS': resultado.descuentoIMSS,
            'Descuento Caja': resultado.descuentoCaja,
            'Total Descuentos': resultado.totalDescuentos,
            'Pago Final': pagoFinal,
            'Estado': resultado.status,
            'Ausencias Aprobadas': resultado.tieneAusenciasAprobadas ? 'S√≠' : 'No',
            'Comentarios Ausencias': resultado.comentariosAusencias || ''
          };
        });

        const ws = XLSX.utils.json_to_sheet(datosExcel);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "N√≥mina");

        const fecha = new Date().toISOString().split('T')[0];
        const nombreArchivo = `Nomina_${quinceActual.replace(' ', '_')}_${mesActual.replace('/', '-')}_${fecha}.xlsx`;
        
        XLSX.writeFile(wb, nombreArchivo);
        mostrarNotificacion('Archivo Excel exportado correctamente', 'success');
      } catch (error) {
        console.error('Error exportando Excel:', error);
        mostrarNotificacion('Error al exportar Excel', 'error');
      }
    };

    // ‚úÖ FUNCIONES PARA MANEJO DE COLECCI√ìN "nominas"

// Funci√≥n para crear ID √∫nico de n√≥mina
function generarIdNomina(a√±o, mes, periodo) {
  return `${a√±o}-${String(mes).padStart(2, '0')}-${periodo}`;
}

// Funci√≥n para guardar n√≥mina completa
window.guardarNominaCompleta = async function() {
  if (!resultadosNomina || resultadosNomina.length === 0) {
    mostrarNotificacion('No hay datos de n√≥mina para guardar', 'warning');
    return;
  }

  try {
    const nominaId = generarIdNomina(a√±oActualNum, mesActualNum, quinceActual.includes('1') ? 'primera' : 'segunda');
    

    // ‚úÖ CALCULAR RESUMEN CON VALIDACIONES
const resumen = {
  totalEmpleados: Number(resultadosNomina.length) || 0,
  totalRetardos: Number(resultadosNomina.reduce((sum, r) => sum + (Number(r.retardos) || 0), 0)) || 0,
  empleadosConDescuento: Number(resultadosNomina.filter(r => (Number(r.diasDescuento) || 0) > 0 || (Number(r.totalDescuentos) || 0) > 0).length) || 0,
  totalBruto: Number(resultadosNomina.reduce((sum, r) => sum + (Number(r.pagoTotalConJustificaciones || r.pagoTotal) || 0), 0)) || 0,
  totalDescuentos: Number(resultadosNomina.reduce((sum, r) => sum + (Number(r.totalDescuentos) || 0), 0)) || 0,
  totalNeto: Number(resultadosNomina.reduce((sum, r) => sum + (Number(r.pagoFinalConJustificaciones || r.pagoFinal) || 0), 0)) || 0
};
    // Preparar datos de empleados
  const empleados = {};
  resultadosNomina.forEach(resultado => {
  const cambiosManual = cambiosManuales[resultado.empleado.uid];
  
  // ‚úÖ VALIDAR DATOS DEL EMPLEADO ANTES DE GUARDAR
  const empleadoLimpio = {
    // Datos del empleado (con validaciones)
    nombre: resultado.empleado.nombre || 'Sin nombre',
    email: resultado.empleado.email || 'sin-email@cielitohome.com',
    tipo: resultado.empleado.tipo || 'tiempo_completo',
    
    // Configuraci√≥n salarial
    salarioQuincenal: resultado.salarioQuincenal || 0,
    pagoPorDia: resultado.pagoPorDia || 0,
    tieneIMSS: Boolean(resultado.empleado.tieneIMSS),
    tieneCajaAhorro: Boolean(resultado.empleado.tieneCajaAhorro),
    montoCajaAhorro: Number(resultado.empleado.montoCajaAhorro) || 0,
    
    // Asistencia autom√°tica
    diasLaboralesEsperados: Number(resultado.diasLaboralesEsperados) || 0,
    diasTrabajados: Number(resultado.diasTrabajados) || 0,
    retardos: Number(resultado.retardos) || 0,
    diasFaltantes: Number(resultado.diasFaltantes) || 0,
    diasEfectivos: Number(resultado.diasEfectivos) || 0,
    diasAsistidos: Array.isArray(resultado.diasAsistidos) ? resultado.diasAsistidos : [],
    detalleRetardos: Array.isArray(resultado.detalleRetardos) ? resultado.detalleRetardos : [],
    
    // Descuentos autom√°ticos
    descuentoIMSS: Number(resultado.descuentoIMSS) || 0,
    descuentoCaja: Number(resultado.descuentoCaja) || 0,
    diasDescuentoPorRetardos: Number(resultado.diasDescuento) || 0,
    
    // Ausencias autom√°ticas
    tieneAusenciasAprobadas: Boolean(resultado.tieneAusenciasAprobadas),
    diasJustificadosAuto: Number(resultado.diasJustificados) || 0,
    comentariosAusencias: String(resultado.comentariosAusencias || ''),
    
    // Ediciones manuales
    editadoManualmente: Boolean(cambiosManual),
    diasExtra: Number(cambiosManual?.diasExtra) || 0,
    bonoExtra: Number(cambiosManual?.bonoExtra) || 0,
    diasJustificadosManual: Number(cambiosManual?.diasJustificados) || 0,
    comentariosEdicion: String(cambiosManual?.comentarios || ''),
    justificacionesDetalle: Array.isArray(cambiosManual?.justificacionesDetalle) ? cambiosManual.justificacionesDetalle : [],
    fechaEdicion: cambiosManual?.fechaEdicion || null,
    
    // C√°lculos finales
    pagoBase: Number(resultado.pagoTotal) || 0,
    pagoConJustificaciones: Number(resultado.pagoTotalConJustificaciones || resultado.pagoTotal) || 0,
    totalDescuentos: Number(resultado.totalDescuentos) || 0,
    pagoFinal: Number(resultado.pagoFinalConJustificaciones || resultado.pagoFinal) || 0,
    
    // Status
    status: String(resultado.status || 'Sin estado'),
    statusClass: String(resultado.statusClass || 'status-ok')
  };
  
  empleados[resultado.empleado.uid] = empleadoLimpio;
  });
    

  // ‚úÖ DOCUMENTO COMPLETO PARA GUARDAR CON VALIDACIONES
const nominaDocument = {
  id: String(nominaId),
  a√±o: Number(a√±oActualNum) || new Date().getFullYear(),
  mes: Number(mesActualNum) || new Date().getMonth() + 1,
  periodo: String(quinceActual.includes('1') ? 'primera' : 'segunda'),
  fechaCreacion: new Date(),
  fechaModificacion: new Date(),
  estado: "draft",
  
  // Configuraci√≥n del per√≠odo
  diasLaborales: Array.isArray(calcularDiasLaboralesPeriodo(a√±oActualNum, mesActualNum, quinceActual.includes('1') ? 'primera' : 'segunda')) ? 
                 calcularDiasLaboralesPeriodo(a√±oActualNum, mesActualNum, quinceActual.includes('1') ? 'primera' : 'segunda') : [],
  
  // Resumen y empleados
  resumen,
  empleados,
  
  // Metadatos
  calculadoPor: String(auth.currentUser?.email || 'sistema'),
  version: Number(1)
};

    // Guardar en Firestore
    const nominaRef = doc(db, 'nominas', nominaId);
    await setDoc(nominaRef, nominaDocument);
    
    console.log('‚úÖ N√≥mina guardada:', nominaId);
    mostrarNotificacion(`‚úÖ N√≥mina guardada exitosamente\nID: ${nominaId}`, 'success');
    
    return nominaId;
    
  } catch (error) {
    console.error('Error guardando n√≥mina:', error);
    mostrarNotificacion('Error al guardar la n√≥mina en la base de datos', 'error');
    return null;
  }
}

// Funci√≥n para cargar n√≥mina existente
async function cargarNominaExistente(a√±o, mes, periodo) {
  try {
    const nominaId = generarIdNomina(a√±o, mes, periodo);
    const nominaRef = doc(db, 'nominas', nominaId);
    const nominaDoc = await getDoc(nominaRef);
    
    if (nominaDoc.exists()) {
      const nominaData = nominaDoc.data();
      console.log('üìã N√≥mina encontrada:', nominaData);
      return nominaData;
    } else {
      console.log('üìã No se encontr√≥ n√≥mina guardada para:', nominaId);
      return null;
    }
    
  } catch (error) {
    console.error('Error cargando n√≥mina:', error);
    return null;
  }
}

// Funci√≥n para verificar si existe n√≥mina
async function verificarNominaExistente() {
  if (!mesActualNum || !a√±oActualNum || !quinceActual) return;
  
  const nominaExistente = await cargarNominaExistente(
    a√±oActualNum, 
    mesActualNum, 
    quinceActual.includes('1') ? 'primera' : 'segunda'
  );
  
  if (nominaExistente) {
    const confirmar = confirm(
      `¬øSe encontr√≥ una n√≥mina guardada para ${quinceActual} de ${mesActualNum}/${a√±oActualNum}.\n\n` +
      `¬øDesea cargar la n√≥mina existente o recalcular desde cero?\n\n` +
      `- Aceptar: Cargar n√≥mina guardada\n` +
      `- Cancelar: Recalcular desde cero`
    );
    
    if (confirmar) {
      cargarNominaDesdeDocumento(nominaExistente);
      return true;
    }
  }
  
  return false;
}

// Funci√≥n para cargar n√≥mina desde documento guardado
function cargarNominaDesdeDocumento(nominaData) {
  try {
    console.log('üìã Cargando n√≥mina desde documento guardado...');
    
    // Reconstruir resultadosNomina
    resultadosNomina = [];
    cambiosManuales = {};
    
    Object.entries(nominaData.empleados).forEach(([uid, empleadoData]) => {
      // Reconstruir resultado
      const resultado = {
        empleado: {
          uid: uid,
          nombre: empleadoData.nombre,
          email: empleadoData.email,
          tipo: empleadoData.tipo,
          tieneIMSS: empleadoData.tieneIMSS,
          tieneCajaAhorro: empleadoData.tieneCajaAhorro,
          montoCajaAhorro: empleadoData.montoCajaAhorro
        },
        salarioQuincenal: empleadoData.salarioQuincenal,
        pagoPorDia: empleadoData.pagoPorDia,
        diasLaboralesEsperados: empleadoData.diasLaboralesEsperados,
        diasTrabajados: empleadoData.diasTrabajados,
        retardos: empleadoData.retardos,
        diasFaltantes: empleadoData.diasFaltantes,
        diasEfectivos: empleadoData.diasEfectivos,
        diasAsistidos: empleadoData.diasAsistidos,
        detalleRetardos: empleadoData.detalleRetardos,
        diasDescuento: empleadoData.diasDescuentoPorRetardos,
        descuentoIMSS: empleadoData.descuentoIMSS,
        descuentoCaja: empleadoData.descuentoCaja,
        totalDescuentos: empleadoData.totalDescuentos,
        pagoTotal: empleadoData.pagoBase,
        pagoTotalConJustificaciones: empleadoData.pagoConJustificaciones,
        pagoFinal: empleadoData.pagoFinal,
        pagoFinalConJustificaciones: empleadoData.pagoFinal,
        tieneAusenciasAprobadas: empleadoData.tieneAusenciasAprobadas,
        diasJustificados: empleadoData.diasJustificadosAuto + empleadoData.diasJustificadosManual,
        comentariosAusencias: empleadoData.comentariosAusencias,
        editadoManualmente: empleadoData.editadoManualmente,
        comentariosEdicion: empleadoData.comentariosEdicion,
        status: empleadoData.status,
        statusClass: empleadoData.statusClass,
        diasFaltantesDetalle: nominaData.diasLaborales.filter(dia => !empleadoData.diasAsistidos.includes(dia))
      };
      
      resultadosNomina.push(resultado);
      
      // Reconstruir cambios manuales si existen
      if (empleadoData.editadoManualmente) {
        cambiosManuales[uid] = {
          diasTrabajados: empleadoData.diasTrabajados,
          retardos: empleadoData.retardos,
          diasExtra: empleadoData.diasExtra,
          bonoExtra: empleadoData.bonoExtra,
          diasJustificados: empleadoData.diasJustificadosManual,
          justificacionesDetalle: empleadoData.justificacionesDetalle,
          comentarios: empleadoData.comentariosEdicion,
          editadoManualmente: true,
          fechaEdicion: empleadoData.fechaEdicion
        };
      }
    });
    
    // Actualizar variables globales
    quinceActual = nominaData.periodo === 'primera' ? 'Per√≠odo 1' : 'Per√≠odo 2';
    mesActual = `${nominaData.mes}/${nominaData.a√±o}`;
    mesActualNum = nominaData.mes;
    a√±oActualNum = nominaData.a√±o;
    
    // Mostrar resultados
    mostrarResultados(
      resultadosNomina, 
      nominaData.resumen.totalEmpleados,
      nominaData.resumen.totalRetardos,
      nominaData.resumen.empleadosConDescuento,
      nominaData.resumen.totalNeto,
      nominaData.periodo,
      `${nominaData.a√±o}-${String(nominaData.mes).padStart(2, '0')}`
    );
    
    mostrarNotificacion(`üìã N√≥mina cargada: ${quinceActual} de ${mesActual}\nüíæ Estado: ${nominaData.estado}`, 'success');
    
  } catch (error) {
    console.error('Error cargando n√≥mina desde documento:', error);
    mostrarNotificacion('Error al cargar la n√≥mina guardada', 'error');
  }
}

    // Configurar event listeners al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      configurarCheckboxesJustificaciones();

      // ‚úÖ AGREGAR ESTA L√çNEA:
    document.getElementById('btnGuardarEdicion')?.addEventListener('click', guardarEdicionManual);

    });

  </script>
</body>
</html>