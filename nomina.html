<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Nómina Quincenal | Cielito Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="nomina.css">
  <link rel="icon" href="img/cielitohome.png" type="image/png">
  
  <!-- EmailJS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="admin.html">
        <div class="brand-icon me-2">
          <i class="bi bi-calculator-fill"></i>
        </div>
        <div class="brand-text">
          <div class="brand-title">Sistema de Nómina</div>
          <div class="brand-subtitle">Cielito Home</div>
        </div>
      </a>
      
      <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <i class="bi bi-list"></i>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <div class="navbar-nav ms-auto">
          <button onclick="toggleSalaryManager()" class="btn btn-nav me-2">
            <i class="bi bi-person-gear me-2"></i>
            <span class="btn-text">Gestionar Salarios</span>
          </button>
          <a href="admin.html" class="btn btn-nav">
            <i class="bi bi-arrow-left me-2"></i>
            <span class="btn-text">Panel Admin</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Modal de Validación de Acceso -->
  <div class="modal fade" id="modalValidacionAcceso" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-warning">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title">
            <i class="bi bi-shield-lock me-2"></i>Acceso Restringido - Sistema de Nómina
          </h5>
        </div>
        <div class="modal-body text-center">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Área de Alta Seguridad</strong>
          </div>
          <p class="mb-4">Esta sección contiene información financiera confidencial de empleados.</p>
          
          <div class="mb-3">
            <label class="form-label">Contraseña de Acceso:</label>
            <input type="password" id="passwordNomina" class="form-control text-center" placeholder=" " maxlength="20" autocomplete="off">
          </div>
          
          <div class="text-muted small">
            <i class="bi bi-info-circle me-1"></i>
            Solo personal autorizado de Recursos Humanos y Dirección General
          </div>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-success" onclick="validarAccesoNomina()">
            <i class="bi bi-unlock me-2"></i>Validar Acceso
          </button>
          <button type="button" class="btn btn-secondary" onclick="regresarAdmin()">
            <i class="bi bi-arrow-left me-2"></i>Regresar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenedor Principal -->
  <div class="container main-container">
    
    <!-- Gestión de Salarios Individuales -->
    <div id="salaryManager" class="salary-config" style="display: none;">
      <h4><i class="bi bi-person-gear me-2"></i>Gestión de Salarios Individuales</h4>
      
      <div class="row mb-3">
        <div class="col-md-8">
          <label class="form-label">Seleccionar Empleado</label>
          <select id="employeeSelect" class="form-select">
            <option value="">Seleccionar empleado...</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">&nbsp;</label>
          <button onclick="loadEmployeeSalary()" class="btn btn-info w-100">
            <i class="bi bi-person-check me-2"></i>Cargar Datos
          </button>
        </div>
      </div>

      <!-- Formulario de empleado (oculto inicialmente) -->
      <div id="employeeSalaryForm" style="display: none;">
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">Tipo de Nómina</label>
            <select id="tipoNominaEmpleado" class="form-select">
              <option value="quincenal">📅 Quincenal (cada 15 días)</option>
              <option value="semanal">📆 Semanal (L-V)</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label" for="individualSalary">Salario por Período</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" id="individualSalary" class="form-control" min="0" step="100" placeholder="3000">
              <span class="input-group-text">.00</span>
            </div>
          </div>
          <div class="col-md-3">
            <label class="form-label" for="individualHours">Horas por Período</label>
            <input type="number" id="individualHours" class="form-control" min="1" max="80" placeholder="40">
          </div>
          <div class="col-md-3">
            <label class="form-label" for="dailyRate">Pago por Día</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" id="dailyRate" class="form-control" readonly>
              <span class="input-group-text">.00</span>
            </div>
          </div>
        </div>

        <!-- Beneficios -->
        <div class="row mb-3">
          <div class="col-md-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="tieneIMSS">
              <label class="form-check-label" for="tieneIMSS">
                <strong>Tiene IMSS</strong> <small class="text-muted">(-$300)</small>
              </label>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="tieneCajaAhorro" onchange="toggleCajaAhorro()">
              <label class="form-check-label" for="tieneCajaAhorro">
                <strong>Caja de Ahorro</strong>
              </label>
            </div>
          </div>
          <div class="col-md-3" id="cajaAhorroOptions" style="display: none;">
            <label class="form-label">Monto Quincenal</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" id="montoCajaAhorro" class="form-control" min="0" step="50">
              <span class="input-group-text">.00</span>
            </div>
          </div>
        </div>

        <!-- Datos Bancarios -->
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Cuenta Bancaria</label>
            <input type="text" id="cuentaBancaria" class="form-control" placeholder="1234567890">
          </div>
          <div class="col-md-6">
            <label class="form-label">Banco</label>
            <select id="nombreBanco" class="form-select">
              <option value="">Seleccionar banco...</option>
              <option value="BBVA">BBVA</option>
              <option value="Santander">Santander</option>
              <option value="Banamex">Banamex</option>
              <option value="Banorte">Banorte</option>
              <option value="HSBC">HSBC</option>
              <option value="Scotiabank">Scotiabank</option>
              <option value="Azteca">Banco Azteca</option>
              <option value="Inbursa">Inbursa</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
        </div>

        <div class="d-flex gap-2">
          <button onclick="saveEmployeeSalary()" class="btn btn-success">
            <i class="bi bi-floppy me-2"></i>Guardar Configuración
          </button>
          <button onclick="clearEmployeeSalary()" class="btn btn-outline-danger">
            <i class="bi bi-trash me-2"></i>Limpiar
          </button>
        </div>
      </div>
    </div>

    <!-- Dashboard Caja de Ahorro -->
    <div id="cajaAhorroDashboard" class="row mt-3" style="display: none;">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-piggy-bank me-2"></i>Dashboard Caja de Ahorro
            </h5>
          </div>
          <div class="card-body">
            <div class="row" id="cajaAhorroStats"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Selector de Período Principal -->
    <div class="period-selector">
      <h4><i class="bi bi-calendar3 me-2"></i>Configuración de Nómina</h4>
      <div class="row">
        <div class="col-md-3">
          <label class="form-label">Mes y Año</label>
          <input type="month" id="monthSelect" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Tipo de Nómina</label>
          <select id="tipoNominaCalculo" class="form-select">
            <option value="quincenal">📅 Nómina Quincenal</option>
            <option value="semanal">📆 Nómina Semanal</option>
          </select>
        </div>
        <div class="col-md-3" id="selectorPeriodo">
          <label class="form-label">Quincena</label>
          <select id="quinceSelect" class="form-select">
            <option value="primera">Primera Quincena (1-15)</option>
            <option value="segunda">Segunda Quincena (16-fin de mes)</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">&nbsp;</label>
          <button onclick="calcularNomina()" class="btn btn-success btn-lg w-100">
            <i class="bi bi-calculator me-2"></i>Calcular Nómina
          </button>
        </div>
      </div>
    </div>

    <!-- Resumen General -->
    <div id="summaryCard" class="summary-card" style="display: none;">
      <div class="summary-stats">
        <div class="summary-stat">
          <h4 class="mb-0"><i class="bi bi-graph-up me-2"></i>Resumen General</h4>
        </div>
        <div class="summary-stat">
          <span id="totalEmployees" class="summary-number">0</span>
          <div class="summary-label">Empleados</div>
        </div>
        <div class="summary-stat">
          <span id="totalRetards" class="summary-number">0</span>
          <div class="summary-label">Retardos Totales</div>
        </div>
        <div class="summary-stat">
          <span id="employeesWithPenalty" class="summary-number">0</span>
          <div class="summary-label">Con Descuento</div>
        </div>
        <div class="summary-stat">
          <span id="totalPayout" class="summary-number">$0</span>
          <div class="summary-label">Total a Pagar</div>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div id="loadingSpinner" class="loading-spinner text-center" style="display: none;">
      <div class="spinner-border text-primary" role="status"></div>
      <span class="ms-3">Calculando nómina...</span>
    </div>

    <!-- Controles de Vista -->
    <div id="viewControls" class="view-controls" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Resultados de Nómina</h5>
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-outline-primary active" id="btnVistaCompacta" onclick="cambiarVista('compacta')">
            <i class="bi bi-grid-3x2 me-1"></i>Compacta
          </button>
          <button type="button" class="btn btn-outline-primary" id="btnVistaTabla" onclick="cambiarVista('tabla')">
            <i class="bi bi-table me-1"></i>Tabla
          </button>
        </div>
      </div>
    </div>

    <!-- Vista Compacta -->
    <div id="resultsContainer" class="employee-grid-compact"></div>

    <!-- Vista de Tabla -->
    <div id="tableContainer" class="table-responsive" style="display: none;">
      <table class="table table-hover nomina-table">
        <thead>
          <tr>
            <th>Empleado</th>
            <th>Tipo</th>
            <th>Días</th>
            <th>Retardos</th>
            <th>Faltas</th>
            <th>Descuento</th>
            <th>Pago Final</th>
            <th>Estado</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Botones de Acción MODIFICADOS -->
    <div id="actionButtons" class="d-flex gap-2 mt-3 flex-wrap" style="display: none;">
      <button id="saveBtn" class="btn btn-success" onclick="guardarNominaCompleta()">
        <i class="bi bi-floppy me-2"></i>Guardar Nómina
      </button>
      <button id="exportBtn" class="btn btn-primary" onclick="exportarExcel()">
        <i class="bi bi-file-earmark-spreadsheet me-2"></i>Exportar Excel
      </button>
      <button class="btn btn-info" onclick="generarTodosLosPDFs()">
        <i class="bi bi-file-earmark-pdf me-2"></i>Generar Todos los PDFs
      </button>
      <!-- NUEVOS BOTONES DE EMAIL -->
      <button class="btn btn-warning" onclick="mostrarModalEnvioEmail()">
        <i class="bi bi-envelope me-2"></i>Enviar Tickets por Email
      </button>
      <button class="btn btn-outline-success" onclick="enviarTodosLosEmails()">
        <i class="bi bi-send me-2"></i>Envío Masivo
      </button>
    </div>

    <!-- Modal para Editar Nómina Manual -->
    <div class="modal fade" id="modalEditarNomina" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="bi bi-pencil-square me-2"></i>Editar Nómina Manual
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Edición Manual:</strong> Los cambios aquí tienen prioridad sobre el sistema automático.
            </div>
            
            <form id="formEditarNomina">
              <input type="hidden" id="editEmpleadoId">
              
              <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                  <h6 class="mb-0" id="editEmpleadoNombre">Empleado</h6>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-6">
                      <span class="badge bg-secondary" id="editEmpleadoTipo">Tipo</span>
                      <span class="badge bg-success ms-2" id="editSalarioBase">$0</span>
                    </div>
                    <div class="col-md-6 text-end">
                      <small class="text-muted">Período: <span id="editPeriodo"></span></small>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-3">
                  <label class="form-label">Días Trabajados</label>
                  <input type="number" id="editDiasTrabajados" class="form-control" min="0" max="15">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Retardos</label>
                  <input type="number" id="editRetardos" class="form-control" min="0" max="20">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Días Extra</label>
                  <input type="number" id="editDiasExtra" class="form-control" min="0" max="5">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Bono Extra ($)</label>
                  <input type="number" id="editBonoExtra" class="form-control" min="0" step="50">
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="tieneVacaciones">
                    <label class="form-check-label" for="tieneVacaciones">Vacaciones</label>
                  </div>
                  <input type="number" id="diasVacaciones" class="form-control mt-2" min="0" max="10" placeholder="Días" disabled>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="tieneIncapacidad">
                    <label class="form-check-label" for="tieneIncapacidad">Incapacidad</label>
                  </div>
                  <input type="number" id="diasIncapacidad" class="form-control mt-2" min="0" max="10" placeholder="Días" disabled>
                </div>
                <div class="col-md-4">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="tieneViaje">
                    <label class="form-check-label" for="tieneViaje">Viaje de Negocios</label>
                  </div>
                  <input type="number" id="diasViaje" class="form-control mt-2" min="0" max="10" placeholder="Días" disabled>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Comentarios/Observaciones</label>
                <textarea id="editComentarios" class="form-control" rows="3" placeholder="Comentarios adicionales"></textarea>
              </div>

              <div class="card bg-light">
                <div class="card-header">
                  <h6 class="mb-0"><i class="bi bi-calculator me-2"></i>Vista Previa del Cálculo</h6>
                </div>
                <div class="card-body">
                  <div class="row" id="previaCalculo"></div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnGuardarEdicion">
              <i class="bi bi-save me-2"></i>Guardar Cambios
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- NUEVO: Modal para configuración de envío de emails -->
    <div class="modal fade" id="modalEnvioEmail" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title">
              <i class="bi bi-envelope me-2"></i>Envío de Tickets por Email
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Información:</strong> Se enviarán los tickets de nómina a los correos institucionales de cada empleado.
            </div>
            
            <div class="row mb-3">
              <div class="col-md-12">
                <label class="form-label">Asunto del correo:</label>
                <input type="text" id="emailSubject" class="form-control" 
                       value="Ticket de Nómina - Cielito Home" placeholder="Asunto personalizado">
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-12">
                <label class="form-label">Mensaje personalizado (opcional):</label>
                <textarea id="emailMessage" class="form-control" rows="4" 
                          placeholder="Agregar mensaje personalizado para los empleados..."></textarea>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="incluirPDF" checked>
                  <label class="form-check-label" for="incluirPDF">
                    Incluir PDF como adjunto
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="enviarHTML" checked>
                  <label class="form-check-label" for="enviarHTML">
                    Incluir ticket en formato HTML dentro del email
                  </label>
                </div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">Vista previa de empleados</h6>
              </div>
              <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                <div id="listaEmpleadosEmail"></div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-success" onclick="confirmarEnvioEmails()">
              <i class="bi bi-send me-2"></i>Enviar Emails
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  
  <!-- NUEVO: EmailJS Configuration -->
  <script src="emailConfig.js"></script>
  
  <!-- JavaScript Principal -->
  <script type="module" src="nomina.js"></script>
</body>
</html>