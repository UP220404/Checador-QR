<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de N√≥mina Quincenal | Cielito Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="nomina.css">
  <link rel="icon" href="img/cielitohome.png" type="image/png">

  <style>
    /* Estilos compactos para menos scroll */
    .main-container { padding: 1rem 0; }
    .period-selector, .salary-config { padding: 1rem; margin-bottom: 1rem; }
    .summary-card { padding: 1.5rem; margin-bottom: 1rem; background: linear-gradient(135deg, #28a745, #20c997); color: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3); }
    .summary-stats { display: flex; justify-content: space-between; align-items: center; gap: 2rem; }
    .summary-stat { text-align: center; }
    .summary-number { font-size: 2.5rem; font-weight: 800; display: block; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .summary-label { font-size: 0.9rem; font-weight: 500; opacity: 0.9; margin-top: 0.5rem; }
    .employee-card { margin-bottom: 1rem; padding: 1rem; }
    .stats-grid { gap: 0.5rem; }
    .stat-item { padding: 0.5rem; }
    .payment-details { padding: 0.75rem; margin-top: 0.75rem; }
    .retard-details { padding: 0.75rem; margin-top: 0.75rem; }
    .employee-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1rem; }
    .stat-card { background: rgba(255,255,255,0.1); border-radius: 10px; border: 1px solid rgba(255,255,255,0.2); }
  </style>
</head>
<body>
  <!-- Navbar Mejorado -->
  <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="admin.html">
        <div class="brand-icon me-2">
          <i class="bi bi-calculator-fill"></i>
        </div>
        <div class="brand-text">
          <div class="brand-title">Sistema de N√≥mina</div>
          <div class="brand-subtitle">Cielito Home</div>
        </div>
      </a>
      
      <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <i class="bi bi-list"></i>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <div class="navbar-nav ms-auto">
          <button onclick="toggleSalaryManager()" class="btn btn-nav me-2">
            <i class="bi bi-person-gear me-2"></i>
            <span class="btn-text">Gestionar Salarios</span>
          </button>
          <a href="admin.html" class="btn btn-nav">
            <i class="bi bi-arrow-left me-2"></i>
            <span class="btn-text">Panel Admin</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container main-container">
    <!-- Gesti√≥n de Salarios Individuales -->
    <div id="salaryManager" class="salary-config" style="display: none;">
      <h4><i class="bi bi-person-gear me-2"></i>Gesti√≥n de Salarios Individuales</h4>
      <div class="row mb-3">
        <div class="col-md-6">
          <select id="employeeSelect" class="form-select">
            <option value="">Seleccionar empleado...</option>
          </select>
        </div>
        <div class="col-md-6">
          <button onclick="loadEmployeeSalary()" class="btn btn-info">
            <i class="bi bi-person-check me-2"></i>Cargar Datos
          </button>
        </div>
      </div>
      
      <div id="employeeSalaryForm" style="display: none;">
        <div class="row">
          <div class="col-md-4">
            <label class="form-label">Salario por Per√≠odo (10 d√≠as)</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" id="individualSalary" class="form-control" min="0" placeholder="2,000">
              <span class="input-group-text">.00</span>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Horas por Per√≠odo (referencia)</label>
            <input type="number" id="individualHours" class="form-control" min="1" max="80" placeholder="40">
            <small class="text-muted">Solo para referencia, el pago es por d√≠a</small>
          </div>
          <div class="col-md-4">
            <label class="form-label">Pago por D√≠a</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" id="dailyRate" class="form-control" readonly>
            </div>
          </div>
        </div>
        
        <!-- ‚úÖ NUEVAS OPCIONES: IMSS Y CAJA DE AHORRO -->
        <div class="row mt-3">
          <div class="col-md-6">
            <div class="card p-3">
              <h6 class="card-title mb-3">üè• Seguro Social (IMSS)</h6>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tieneIMSS">
                <label class="form-check-label" for="tieneIMSS">
                  <strong>Empleado asegurado</strong>
                </label>
              </div>
              <small class="text-muted mt-1 d-block">Se descuentan $300 fijos por quincena</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card p-3">
              <h6 class="card-title mb-3">üè¶ Caja de Ahorro</h6>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="tieneCajaAhorro" onchange="toggleCajaAhorro()">
                <label class="form-check-label" for="tieneCajaAhorro">
                  <strong>Participa en caja de ahorro</strong>
                </label>
              </div>
              <div id="cajaAhorroOptions" style="display: none;">
                <label class="form-label">Descuento quincenal:</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" id="montoCajaAhorro" class="form-control" min="0" placeholder="200">
                  <span class="input-group-text">.00</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-3">
          <div class="col-md-12">
            <button onclick="saveEmployeeSalary()" class="btn btn-success me-2">
              <i class="bi bi-floppy me-2"></i>Guardar Configuraci√≥n
            </button>
            <button onclick="clearEmployeeSalary()" class="btn btn-warning me-2">
              <i class="bi bi-trash me-2"></i>Eliminar Configuraci√≥n
            </button>
            <button onclick="toggleSalaryManager()" class="btn btn-secondary">
              <i class="bi bi-x me-2"></i>Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard Caja de Ahorro -->
    <div id="cajaAhorroDashboard" class="row mt-3" style="display: none;">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-piggy-bank me-2"></i>Dashboard Caja de Ahorro
            </h5>
          </div>
          <div class="card-body">
            <div class="row" id="cajaAhorroStats">
              <!-- Se llena din√°micamente -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Selector de Per√≠odo (Compacto) -->
    <div class="period-selector">
      <div class="row align-items-end">
        <div class="col-md-3">
          <label class="form-label">Mes y A√±o</label>
          <input type="month" id="monthSelect" class="form-control" value="">
        </div>
        <div class="col-md-3">
          <label class="form-label">Per√≠odo</label>
          <select id="quinceSelect" class="form-select">
            <option value="primera">Per√≠odo 1 (Primeros 10 d√≠as laborales)</option>
            <option value="segunda">Per√≠odo 2 (Siguientes 10 d√≠as laborales)</option>
          </select>
        </div>
        <div class="col-md-6">
          <button onclick="calcularNomina()" class="btn btn-primary btn-lg">
            <i class="bi bi-calculator me-2"></i>Calcular N√≥mina
          </button>
          <button onclick="exportarExcel()" class="btn btn-success ms-2" id="exportBtn" style="display: none;">
            <i class="bi bi-file-earmark-excel me-2"></i>Exportar Excel
          </button>
        </div>
      </div>
    </div>

    <!-- Resumen General (Mejorado) -->
    <div id="summaryCard" class="summary-card" style="display: none;">
      <div class="summary-stats">
        <div class="summary-stat">
          <span id="totalEmployees" class="summary-number">0</span>
          <div class="summary-label">Empleados</div>
        </div>
        <div class="summary-stat">
          <span id="totalRetards" class="summary-number">0</span>
          <div class="summary-label">Retardos Totales</div>
        </div>
        <div class="summary-stat">
          <span id="employeesWithPenalty" class="summary-number">0</span>
          <div class="summary-label">Con Descuento</div>
        </div>
        <div class="summary-stat">
          <span id="totalPayout" class="summary-number">$0</span>
          <div class="summary-label">Total a Pagar</div>
        </div>
        <div class="summary-stat">
          <h4 class="mb-0"><i class="bi bi-graph-up me-2"></i>Resumen General</h4>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div id="loadingSpinner" class="loading-spinner text-center" style="display: none;">
      <div class="spinner-border text-primary" role="status"></div>
      <span class="ms-3">Calculando n√≥mina...</span>
    </div>

    <!-- Resultados en Grid -->
    <div id="resultsContainer" class="employee-grid"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Firebase Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD2o2FyUwVZafKIv-qtM6fmA663ldB_1Uo",
      authDomain: "qr-acceso-cielito-home.firebaseapp.com",
      projectId: "qr-acceso-cielito-home",
      storageBucket: "qr-acceso-cielito-home.appspot.com",
      messagingSenderId: "229634415256",
      appId: "1:229634415256:web:c576ba8879e58e441c4eed"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let empleadosGlobales = []; // Para usar en gesti√≥n de salarios

    // Configurar fecha actual por defecto
    const hoy = new Date();
    document.getElementById('monthSelect').value = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;

    // ‚úÖ FUNCI√ìN PARA FORMATEAR N√öMEROS CON COMAS
    function formatearNumero(numero) {
      return numero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    // ‚úÖ SISTEMA DE NOTIFICACIONES MEJORADO
    function mostrarNotificacion(mensaje, tipo = 'info', duracion = 4000) {
      // Remover notificaciones anteriores
      const existingNotifications = document.querySelectorAll('.custom-notification');
      existingNotifications.forEach(notif => notif.remove());

      // Crear nueva notificaci√≥n
      const notification = document.createElement('div');
      notification.className = `custom-notification notification-${tipo}`;
      
      // Iconos seg√∫n tipo
      const iconos = {
        'success': 'bi-check-circle-fill',
        'error': 'bi-x-circle-fill',
        'warning': 'bi-exclamation-triangle-fill',
        'info': 'bi-info-circle-fill'
      };

      notification.innerHTML = `
        <div class="notification-content">
          <div class="notification-icon">
            <i class="bi ${iconos[tipo] || iconos.info}"></i>
          </div>
          <div class="notification-message">${mensaje}</div>
          <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
            <i class="bi bi-x"></i>
          </button>
        </div>
        <div class="notification-progress"></div>
      `;

      document.body.appendChild(notification);

      // Animar entrada
      setTimeout(() => notification.classList.add('show'), 100);

      // Auto-remover
      if (duracion > 0) {
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 300);
        }, duracion);
      }
    }

    // Reemplazar todas las llamadas a alert() con notificaciones
    const originalAlert = window.alert;
    window.alert = function(mensaje) {
      if (mensaje.includes('Error') || mensaje.includes('‚ùå')) {
        mostrarNotificacion(mensaje, 'error');
      } else if (mensaje.includes('correctamente') || mensaje.includes('‚úÖ')) {
        mostrarNotificacion(mensaje, 'success');
      } else if (mensaje.includes('configurados') || mensaje.includes('‚ö†Ô∏è')) {
        mostrarNotificacion(mensaje, 'warning', 6000);
      } else {
        mostrarNotificacion(mensaje, 'info');
      }
    };

    // Verificar autenticaci√≥n
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      const adminEmails = [
        'sistemas16ch@gmail.com',
        'sistemas16cielitohome@gmail.com',
        'leticia@cielitohome.com',
        'sistemas@cielitohome.com',
        'direcciongeneral@cielitohome.com'
      ];
      
      if (!adminEmails.includes(user.email)) {
        mostrarNotificacion('No tienes permisos para acceder a esta secci√≥n', 'error');
        setTimeout(() => window.location.href = 'admin.html', 2000);
        return;
      }

      // Cargar empleados para gesti√≥n de salarios
      cargarEmpleados();
    });

    // ‚úÖ FUNCI√ìN PARA MANEJAR CAJA DE AHORRO
    window.toggleCajaAhorro = function() {
      const checkbox = document.getElementById('tieneCajaAhorro');
      const options = document.getElementById('cajaAhorroOptions');
      options.style.display = checkbox.checked ? 'block' : 'none';
      
      if (!checkbox.checked) {
        document.getElementById('montoCajaAhorro').value = '';
      }
    };

    // Funci√≥n para cargar empleados
    async function cargarEmpleados() {
      try {
        const usuariosQuery = query(collection(db, "usuarios"));
        const usuariosSnapshot = await getDocs(usuariosQuery);
        
        empleadosGlobales = [];
        const select = document.getElementById('employeeSelect');
        select.innerHTML = '<option value="">Seleccionar empleado...</option>';
        
        usuariosSnapshot.forEach(doc => {
          const userData = doc.data();
          empleadosGlobales.push({
            uid: doc.id,
            ...userData
          });
          
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = `${userData.nombre} (${userData.tipo || 'Sin tipo'})`;
          select.appendChild(option);
        });
        
        // ‚úÖ ACTUALIZAR DASHBOARD AUTOM√ÅTICAMENTE
        await actualizarDashboardCajaAhorro();
        
      } catch (error) {
        console.error('Error cargando empleados:', error);
        mostrarNotificacion('Error al cargar empleados', 'error');
      }
    }

    // Gesti√≥n de salarios individuales
    window.toggleSalaryManager = function() {
      const manager = document.getElementById('salaryManager');
      manager.style.display = manager.style.display === 'none' ? 'block' : 'none';
    };

    window.loadEmployeeSalary = function() {
      const employeeId = document.getElementById('employeeSelect').value;
      if (!employeeId) return;

      const empleado = empleadosGlobales.find(emp => emp.uid === employeeId);
      if (!empleado) return;

      document.getElementById('employeeSalaryForm').style.display = 'block';
      document.getElementById('individualSalary').value = empleado.salarioQuincenal || '';
      document.getElementById('individualHours').value = empleado.horasQuincenal || '';
      
      // ‚úÖ CARGAR NUEVOS CAMPOS
      document.getElementById('tieneIMSS').checked = empleado.tieneIMSS || false;
      document.getElementById('tieneCajaAhorro').checked = empleado.tieneCajaAhorro || false;
      document.getElementById('montoCajaAhorro').value = empleado.montoCajaAhorro || '';
      
      toggleCajaAhorro(); // Mostrar/ocultar opciones de caja de ahorro
      calcularPagoPorDia();
    };

    // Calcular pago por d√≠a autom√°ticamente
    document.getElementById('individualSalary').addEventListener('input', calcularPagoPorDia);
    document.getElementById('individualHours').addEventListener('input', calcularPagoPorDia);

    function calcularPagoPorDia() {
      const salary = parseFloat(document.getElementById('individualSalary').value) || 0;
      const dailyRate = salary / 10; // 10 d√≠as laborales por per√≠odo
      document.getElementById('dailyRate').value = dailyRate.toFixed(2);
    }

    window.saveEmployeeSalary = async function() {
      const employeeId = document.getElementById('employeeSelect').value;
      const salary = parseFloat(document.getElementById('individualSalary').value);
      const hours = parseInt(document.getElementById('individualHours').value);
      const tieneIMSS = document.getElementById('tieneIMSS').checked;
      const tieneCajaAhorro = document.getElementById('tieneCajaAhorro').checked;
      const montoCajaAhorro = parseFloat(document.getElementById('montoCajaAhorro').value) || 0;

      if (!employeeId || !salary || !hours) {
        mostrarNotificacion('Complete todos los campos obligatorios', 'warning');
        return;
      }

      if (tieneCajaAhorro && montoCajaAhorro <= 0) {
        mostrarNotificacion('Si participa en caja de ahorro, debe especificar el monto', 'warning');
        return;
      }

      try {
        const empleadoRef = doc(db, 'usuarios', employeeId);
        await updateDoc(empleadoRef, {
          salarioQuincenal: salary,
          horasQuincenal: hours,
          pagoPorHora: salary / hours,
          pagoPorDia: salary / 10,
          // ‚úÖ NUEVOS CAMPOS
          tieneIMSS: tieneIMSS,
          tieneCajaAhorro: tieneCajaAhorro,
          montoCajaAhorro: tieneCajaAhorro ? montoCajaAhorro : 0
        });

        mostrarNotificacion('Configuraci√≥n guardada correctamente', 'success');
        await cargarEmpleados();
        await actualizarDashboardCajaAhorro(); // ‚úÖ ACTUALIZAR DASHBOARD
        document.getElementById('employeeSalaryForm').style.display = 'none';
        document.getElementById('employeeSelect').value = '';
      } catch (error) {
        console.error('Error guardando configuraci√≥n:', error);
        mostrarNotificacion('Error al guardar la configuraci√≥n', 'error');
      }
    };

    window.clearEmployeeSalary = async function() {
      const employeeId = document.getElementById('employeeSelect').value;
      if (!employeeId) return;

      if (!confirm('¬øEliminar configuraci√≥n de salario para este empleado?')) return;

      try {
        const empleadoRef = doc(db, 'usuarios', employeeId);
        await updateDoc(empleadoRef, {
          salarioQuincenal: null,
          horasQuincenal: null,
          pagoPorHora: null,
          pagoPorDia: null,
          // ‚úÖ LIMPIAR NUEVOS CAMPOS
          tieneIMSS: false,
          tieneCajaAhorro: false,
          montoCajaAhorro: 0
        });

        mostrarNotificacion('Configuraci√≥n eliminada correctamente', 'success');
        await cargarEmpleados();
        await actualizarDashboardCajaAhorro();
        document.getElementById('employeeSalaryForm').style.display = 'none';
        document.getElementById('employeeSelect').value = '';
      } catch (error) {
        console.error('Error eliminando configuraci√≥n:', error);
        mostrarNotificacion('Error al eliminar la configuraci√≥n', 'error');
      }
    };

    // ‚úÖ NUEVA FUNCI√ìN: DASHBOARD CAJA DE AHORRO
    async function actualizarDashboardCajaAhorro() {
      try {
        console.log('üìä Actualizando dashboard caja de ahorro...');
        
        // Filtrar empleados con caja de ahorro (SIN NUEVA CONSULTA - usar datos ya cargados)
        const empleadosConCaja = empleadosGlobales.filter(emp => emp.tieneCajaAhorro);
        
        if (empleadosConCaja.length === 0) {
          document.getElementById('cajaAhorroDashboard').style.display = 'none';
          return;
        }
        
        document.getElementById('cajaAhorroDashboard').style.display = 'block';
        
        // Calcular estad√≠sticas
        let totalParticipantes = empleadosConCaja.length;
        let ahorroQuincenalTotal = empleadosConCaja.reduce((sum, emp) => sum + (emp.montoCajaAhorro || 0), 0);
        let ahorroMensualTotal = ahorroQuincenalTotal * 2; // 2 quincenas por mes
        let ahorroAnualTotal = ahorroMensualTotal * 12;
        
        const statsContainer = document.getElementById('cajaAhorroStats');
        statsContainer.innerHTML = `
          <div class="col-md-3">
            <div class="stat-card text-center p-3">
              <h4 class="text-success">${totalParticipantes}</h4>
              <small class="text-muted">Participantes</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card text-center p-3">
              <h4 class="text-success">$${formatearNumero(ahorroQuincenalTotal)}</h4>
              <small class="text-muted">Por Quincena</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card text-center p-3">
              <h4 class="text-success">$${formatearNumero(ahorroMensualTotal)}</h4>
              <small class="text-muted">Por Mes</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card text-center p-3">
              <h4 class="text-success">$${formatearNumero(ahorroAnualTotal)}</h4>
              <small class="text-muted">Por A√±o</small>
            </div>
          </div>
        `;
        
        // Mostrar detalle por empleado
        if (totalParticipantes > 0) {
          const detalleHTML = empleadosConCaja.map(emp => `
            <div class="col-md-6 mb-2">
              <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                <span><strong>${emp.nombre}</strong></span>
                <span class="badge bg-success">$${formatearNumero(emp.montoCajaAhorro || 0)}/quincena</span>
              </div>
            </div>
          `).join('');
          
          statsContainer.innerHTML += `
            <div class="col-md-12 mt-3">
              <h6><i class="bi bi-people me-2"></i>Detalle por Empleado:</h6>
              <div class="row">
                ${detalleHTML}
              </div>
            </div>
          `;
        }
        
        console.log('‚úÖ Dashboard caja de ahorro actualizado');
        
      } catch (error) {
        console.error('Error actualizando dashboard caja de ahorro:', error);
      }
    }

    // ‚úÖ FUNCI√ìN CORREGIDA PARA CALCULAR D√çAS LABORALES EN PER√çODOS
    function calcularDiasLaboralesPeriodo(a√±o, mes, periodo) {
      const diasLaborales = [];
      const fechaInicio = new Date(a√±o, mes - 1, 1); // Primer d√≠a del mes
      
      // Obtener todos los d√≠as laborales del mes
      const ultimoDia = new Date(a√±o, mes, 0).getDate(); // √öltimo d√≠a del mes
      
      for (let dia = 1; dia <= ultimoDia; dia++) {
        const fecha = new Date(a√±o, mes - 1, dia);
        const diaSemana = fecha.getDay();
        
        // Solo d√≠as laborales (Lunes=1 a Viernes=5)
        if (diaSemana >= 1 && diaSemana <= 5) {
          diasLaborales.push(dia);
        }
      }
      
      // Dividir en 2 per√≠odos de 10 d√≠as laborales cada uno
      if (periodo === 'primera') {
        return diasLaborales.slice(0, 10); // Primeros 10 d√≠as laborales
      } else {
        return diasLaborales.slice(10, 20); // Siguientes 10 d√≠as laborales
      }
    }

    // ‚úÖ FUNCI√ìN OPTIMIZADA SIN √çNDICES - CON FALLBACK AUTOM√ÅTICO
    window.calcularNomina = async function() {
      const monthSelect = document.getElementById('monthSelect').value;
      const quinceSelect = document.getElementById('quinceSelect').value;
      
      if (!monthSelect) {
        mostrarNotificacion('Selecciona un mes', 'warning');
        return;
      }

      document.getElementById('loadingSpinner').style.display = 'block';
      document.getElementById('summaryCard').style.display = 'none';
      document.getElementById('resultsContainer').innerHTML = '';
      document.getElementById('exportBtn').style.display = 'none';

      try {
        const [a√±o, mes] = monthSelect.split('-');
        const mesNum = parseInt(mes);
        const a√±oNum = parseInt(a√±o);

        console.log(`üìÖ Calculando per√≠odo: ${quinceSelect} de ${mesNum}/${a√±oNum}`);

        // ‚úÖ OBTENER D√çAS LABORALES DEL PER√çODO
        const diasLaborales = calcularDiasLaboralesPeriodo(a√±oNum, mesNum, quinceSelect);
        
        console.log(`üìä D√≠as laborales del per√≠odo:`, diasLaborales);
        console.log(`üìä Total d√≠as laborales esperados: ${diasLaborales.length}`);

        // ‚úÖ OBTENER EMPLEADOS CON CONFIGURACI√ìN INCLUYENDO NUEVOS CAMPOS
        const usuariosQuery = query(collection(db, "usuarios"));
        const usuariosSnapshot = await getDocs(usuariosQuery);
        
        const empleados = [];
        usuariosSnapshot.forEach(doc => {
          const userData = doc.data();
          
          if (userData.salarioQuincenal && userData.horasQuincenal) {
            empleados.push({
              uid: doc.id,
              nombre: userData.nombre,
              email: userData.email,
              tipo: userData.tipo,
              salarioQuincenal: userData.salarioQuincenal,
              horasQuincenal: userData.horasQuincenal,
              pagoPorDia: userData.salarioQuincenal / 10,
              // ‚úÖ NUEVOS CAMPOS PARA DESCUENTOS
              tieneIMSS: userData.tieneIMSS || false,
              tieneCajaAhorro: userData.tieneCajaAhorro || false,
              montoCajaAhorro: userData.montoCajaAhorro || 0,
              esIndividual: true
            });
          }
        });

        if (empleados.length === 0) {
          mostrarNotificacion('‚ùå No hay empleados con salarios configurados.\n\nUse "Gestionar Salarios" para configurar los salarios de cada empleado.', 'error', 6000);
          document.getElementById('loadingSpinner').style.display = 'none';
          return;
        }

        // ‚úÖ CONSULTA SIN √çNDICES - SOLO POR TIPO DE EVENTO
        console.log('üîç Consultando TODOS los registros de entrada (filtraremos en memoria)...');
        
        const registrosQuery = query(
          collection(db, "registros"),
          where("tipoEvento", "==", "entrada")
        );

        const registrosSnapshot = await getDocs(registrosQuery);
        console.log(`üìä Registros obtenidos de Firestore: ${registrosSnapshot.size}`);
        
        // ‚úÖ FILTRAR EN MEMORIA POR FECHA Y D√çAS LABORALES DEL PER√çODO
        const registrosPorEmpleado = {};
        let registrosProcesados = 0;
        
        registrosSnapshot.forEach(doc => {
          const registro = doc.data();
          const uid = registro.uid;
          
          // Extraer d√≠a de la fecha del registro
          const fechaRegistro = registro.fecha; // formato "YYYY-MM-DD"
          if (!fechaRegistro) return; // Skip si no tiene fecha
          
          const [regA√±o, regMes, regDia] = fechaRegistro.split('-').map(Number);
          
          // Filtrar por a√±o, mes y d√≠as laborales del per√≠odo espec√≠fico
          if (regA√±o === a√±oNum && regMes === mesNum && diasLaborales.includes(regDia)) {
            if (!registrosPorEmpleado[uid]) {
              registrosPorEmpleado[uid] = [];
            }
            registrosPorEmpleado[uid].push(registro);
            registrosProcesados++;
          }
        });

        console.log(`üìä Registros filtrados por per√≠odo: ${registrosProcesados}`);

        // ‚úÖ CALCULAR ESTAD√çSTICAS CON DESCUENTOS
        const resultados = [];
        let totalRetardos = 0;
        let empleadosConDescuento = 0;
        let totalNominaPagada = 0;
        let totalDescuentosIMSS = 0;
        let totalDescuentosCaja = 0;
        let totalNominaFinal = 0;

        for (const empleado of empleados) {
          const registros = registrosPorEmpleado[empleado.uid] || [];
          
          const salarioQuincenal = empleado.salarioQuincenal;
          const pagoPorDia = empleado.pagoPorDia;

          let retardos = 0;
          let diasTrabajados = registros.length;
          const detalleRetardos = [];
          const diasAsistidos = [];

          registros.forEach(registro => {
            const [regA√±o, regMes, regDia] = registro.fecha.split('-').map(Number);
            diasAsistidos.push(regDia);
            
            if (registro.estado === 'retardo') {
              retardos++;
              detalleRetardos.push({
                fecha: registro.fecha,
                hora: registro.hora
              });
            }
          });

          const diasFaltantes = diasLaborales.filter(dia => !diasAsistidos.includes(dia));
          const diasDescuento = Math.floor(retardos / 4);
          const diasEfectivos = diasTrabajados - diasDescuento;
          const pagoTotal = Math.max(0, diasEfectivos * pagoPorDia);

          // ‚úÖ APLICAR DESCUENTOS
          let descuentoIMSS = 0;
          let descuentoCaja = 0;
          
          if (empleado.tieneIMSS) {
            descuentoIMSS = 300; // $300 fijos por quincena
            totalDescuentosIMSS += descuentoIMSS;
          }
          
          if (empleado.tieneCajaAhorro && empleado.montoCajaAhorro) {
            descuentoCaja = empleado.montoCajaAhorro;
            totalDescuentosCaja += descuentoCaja;
          }
          
          // Calcular pago final
          const pagoConDescuentos = pagoTotal - descuentoIMSS - descuentoCaja;
          const pagoFinal = Math.max(0, pagoConDescuentos);
          
          if (diasDescuento > 0 || descuentoIMSS > 0 || descuentoCaja > 0) empleadosConDescuento++;
          totalRetardos += retardos;
          totalNominaPagada += pagoTotal;
          totalNominaFinal += pagoFinal;

          let status, statusClass;
          if (diasFaltantes.length > 0) {
            status = `${diasFaltantes.length} falta${diasFaltantes.length > 1 ? 's' : ''} ‚Ä¢ ${retardos} retardo${retardos !== 1 ? 's' : ''}`;
            statusClass = 'status-penalty';
          } else if (diasDescuento > 0) {
            status = `Descuento: ${diasDescuento} d√≠a${diasDescuento > 1 ? 's' : ''}`;
            statusClass = 'status-penalty';
          } else if (retardos >= 3) {
            status = 'En l√≠mite de retardos';
            statusClass = 'status-warning';
          } else {
            status = 'Sin penalizaciones';
            statusClass = 'status-ok';
          }

          resultados.push({
            empleado,
            salarioQuincenal,
            diasLaboralesEsperados: diasLaborales.length,
            diasTrabajados,
            diasFaltantes: diasFaltantes.length,
            retardos,
            diasDescuento,
            diasEfectivos,
            pagoPorDia: Math.round(pagoPorDia),
            pagoTotal: Math.round(pagoTotal),
            // ‚úÖ NUEVOS CAMPOS CON DESCUENTOS
            descuentoIMSS,
            descuentoCaja,
            totalDescuentos: descuentoIMSS + descuentoCaja,
            pagoFinal: Math.round(pagoFinal),
            status,
            statusClass,
            detalleRetardos,
            diasAsistidos,
            diasFaltantesDetalle: diasFaltantes
          });
        }

        mostrarResultados(resultados, empleados.length, totalRetardos, empleadosConDescuento, totalNominaFinal, quinceSelect, monthSelect);

      } catch (error) {
        console.error('Error calculando n√≥mina:', error);
        mostrarNotificacion('Error al calcular la n√≥mina: ' + error.message, 'error');
      } finally {
        document.getElementById('loadingSpinner').style.display = 'none';
      }
    };

    // ‚úÖ FUNCI√ìN MOSTRAR RESULTADOS CON DESCUENTOS
    function mostrarResultados(resultados, totalEmpleados, totalRetardos, empleadosConDescuento, totalNominaFinal, quincena, mes) {
      // Actualizar resumen
      document.getElementById('totalEmployees').textContent = formatearNumero(totalEmpleados);
      document.getElementById('totalRetards').textContent = formatearNumero(totalRetardos);
      document.getElementById('employeesWithPenalty').textContent = formatearNumero(empleadosConDescuento);
      document.getElementById('totalPayout').textContent = `$${formatearNumero(Math.round(totalNominaFinal))}`;
      document.getElementById('summaryCard').style.display = 'block';
      document.getElementById('exportBtn').style.display = 'inline-block';

      // Mostrar tarjetas de empleados
      const container = document.getElementById('resultsContainer');
      container.innerHTML = '';

      resultados.forEach(resultado => {
        const card = document.createElement('div');
        card.className = 'employee-card';
        
        function getTipoNombre(tipo) {
          switch(tipo) {
            case 'tiempo_completo': return 'T.Completo';
            case 'becario': return 'Becario';
            case 'horario_especial': return 'H.Especial';
            default: return tipo;
          }
        }
        
        card.innerHTML = `
          <div class="employee-header">
            <div class="employee-name">
              <i class="bi bi-person-fill me-2"></i>
              ${resultado.empleado.nombre}
              <span class="badge bg-secondary ms-2">${getTipoNombre(resultado.empleado.tipo)}</span>
              <span class="badge bg-success ms-1">Pago x D√≠a</span>
              ${resultado.empleado.tieneIMSS ? '<span class="badge bg-info ms-1">IMSS</span>' : ''}
              ${resultado.empleado.tieneCajaAhorro ? '<span class="badge bg-warning text-dark ms-1">Caja</span>' : ''}
            </div>
            <div class="status-badge ${resultado.statusClass}">
              ${resultado.status}
            </div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-number text-primary">${resultado.diasTrabajados}/${resultado.diasLaboralesEsperados}</div>
              <div class="stat-label">Asistencias</div>
            </div>
            <div class="stat-item">
              <div class="stat-number text-danger">${resultado.diasFaltantes}</div>
              <div class="stat-label">Faltas</div>
            </div>
            <div class="stat-item">
              <div class="stat-number text-warning">${resultado.retardos}</div>
              <div class="stat-label">Retardos</div>
            </div>
            <div class="stat-item">
              <div class="stat-number text-success">$${formatearNumero(Math.round(resultado.pagoFinal))}</div>
              <div class="stat-label">Pago Final</div>
            </div>
          </div>
          
          <div class="payment-details">
            <div class="row">
              <div class="col-6">
                <small>üí∞ <strong>$${formatearNumero(resultado.pagoPorDia)}/d√≠a</strong></small><br>
                <small>üìä <strong>${resultado.diasEfectivos} d√≠as efectivos</strong></small><br>
                <small>üí∏ <strong>$${formatearNumero(resultado.pagoTotal)} bruto</strong></small>
              </div>
              <div class="col-6">
                ${resultado.totalDescuentos > 0 ? `
                  <small class="text-warning">üìâ <strong>Descuentos:</strong></small><br>
                  ${resultado.descuentoIMSS > 0 ? `<small>üè• IMSS: $${resultado.descuentoIMSS}</small><br>` : ''}
                  ${resultado.descuentoCaja > 0 ? `<small>üè¶ Caja: $${resultado.descuentoCaja}</small><br>` : ''}
                  <small class="text-success">üí∞ <strong>Final: $${formatearNumero(Math.round(resultado.pagoFinal))}</strong></small>
                ` : `
                  <small>‚úÖ <strong>Sin descuentos</strong></small><br>
                  <small>üí∞ <strong>Total: $${formatearNumero(Math.round(resultado.pagoFinal))}</strong></small>
                `}
              </div>
            </div>
            
            ${resultado.diasFaltantesDetalle.length > 0 ? `
              <div class="mt-2">
                <small class="text-danger"><strong>D√≠as faltantes:</strong> ${resultado.diasFaltantesDetalle.join(', ')}</small>
              </div>
            ` : ''}
            
            ${resultado.detalleRetardos.length > 0 ? `
              <div class="mt-2">
                <small class="text-warning"><strong>Retardos:</strong> ${resultado.detalleRetardos.map(r => `${r.fecha.split('-')[2]} (${r.hora})`).join(', ')}</small>
              </div>
            ` : ''}
          </div>
        `;
        
        container.appendChild(card);
      });

      console.log(`‚úÖ N√≥mina calculada: ${resultados.length} empleados`);
      console.log(`üí∞ Total final: $${formatearNumero(Math.round(totalNominaFinal))}`);
    }

    // Funci√≥n para exportar a Excel (placeholder)
    window.exportarExcel = function() {
      mostrarNotificacion('Funci√≥n de exportar a Excel pr√≥ximamente', 'info');
    };
  </script>
</body>
</html>