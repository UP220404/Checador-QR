<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Checador - Cielito Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- ‚úÖ LIBRER√çA QRCode CORREGIDA -->
  <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    /* ... todos los estilos existentes ... */
  </style>
</head>
<body>
  <!-- ... todo el HTML existente ... -->

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ‚úÖ VERIFICAR QUE QRCODE EST√â DISPONIBLE
    if (typeof QRCode === 'undefined') {
      console.error('‚ùå QRCode library not loaded');
      document.getElementById('qr-loading').innerHTML = `
        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
        <p class="text-danger mt-3 mb-0">Error cargando librer√≠a QR</p>
        <small class="text-muted">Recarga la p√°gina</small>
      `;
    }

    // Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyD2o2FyUwVZafKIv-qtM6fmA663ldB_1Uo",
      authDomain: "qr-acceso-cielito-home.firebaseapp.com",
      projectId: "qr-acceso-cielito-home",
      storageBucket: "qr-acceso-cielito-home.appspot.com",
      messagingSenderId: "229634415256",
      appId: "1:229634415256:web:c576ba8879e58e441c4eed"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Variables globales
    let tokenActual = null;
    let tiempoExpiracion = null;
    let intervaloCuenta = null;

    // Elementos DOM
    const elements = {
      qrCanvas: document.getElementById('qr-canvas'),
      qrLoading: document.getElementById('qr-loading'),
      currentToken: document.getElementById('current-token'),
      countdown: document.getElementById('countdown'),
      statusBadge: document.getElementById('status-badge'),
      statusText: document.getElementById('status-text'),
      refreshBtn: document.getElementById('refresh-btn'),
      tokensCount: document.getElementById('tokens-count'),
      successCount: document.getElementById('success-count'),
      blockedCount: document.getElementById('blocked-count')
    };

    // Generar token √∫nico
    function generarTokenSeguro() {
      const timestamp = Date.now();
      const random = Math.random().toString(36).substring(2, 15);
      const extra = Math.random().toString(36).substring(2, 8);
      return `CH_${timestamp}_${random}_${extra}`.toUpperCase();
    }

    // ‚úÖ FUNCI√ìN GENERARQR MEJORADA CON VERIFICACI√ìN
    async function generarQR() {
      try {
        console.log('üîÑ Iniciando generaci√≥n de QR...');
        
        // ‚úÖ VERIFICAR QUE QRCODE EST√â DISPONIBLE
        if (typeof QRCode === 'undefined') {
          throw new Error('QRCode library not available');
        }
        
        elements.qrLoading.style.display = 'block';
        elements.qrCanvas.style.display = 'none';
        actualizarEstado('generando');

        // Generar nuevo token
        tokenActual = generarTokenSeguro();
        tiempoExpiracion = Date.now() + (30 * 60 * 1000); // 30 minutos

        console.log('üìù Token generado:', tokenActual);

        // Guardar en Firebase
        await setDoc(doc(db, "qr_tokens", "current"), {
          token: tokenActual,
          expiracion: new Date(tiempoExpiracion),
          creado: new Date(),
          usado: false,
          activo: true
        });

        console.log('üíæ Token guardado en Firebase');

        // Crear URL del checador con token
        const baseUrl = window.location.origin + window.location.pathname.replace('qr-simple.html', 'index.html');
        const urlCompleta = `${baseUrl}?qr=OFICINA2025&token=${tokenActual}&t=${Date.now()}`;

        console.log('üîó URL generada:', urlCompleta);

        // ‚úÖ GENERAR C√ìDIGO QR CON VERIFICACI√ìN ADICIONAL
        await new Promise((resolve, reject) => {
          QRCode.toCanvas(elements.qrCanvas, urlCompleta, {
            width: 300,
            height: 300,
            color: {
              dark: '#155d27',
              light: '#ffffff'
            },
            errorCorrectionLevel: 'M',
            margin: 2
          }, (error) => {
            if (error) reject(error);
            else resolve();
          });
        });

        // Actualizar UI
        elements.currentToken.textContent = tokenActual;
        elements.qrLoading.style.display = 'none';
        elements.qrCanvas.style.display = 'block';
        
        actualizarEstado('activo');
        iniciarCuentaRegresiva();
        await actualizarEstadisticas();

        console.log('‚úÖ QR generado exitosamente');

      } catch (error) {
        console.error('‚ùå Error generando QR:', error);
        
        elements.qrLoading.innerHTML = `
          <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
          <p class="text-danger mt-3 mb-0">Error al generar QR</p>
          <small class="text-muted">${error.message}</small>
          <br>
          <button class="btn btn-sm btn-outline-primary mt-2" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise me-1"></i>Recargar p√°gina
          </button>
        `;
        
        actualizarEstado('error');
      }
    }

    // Resto de funciones sin cambios...
    function iniciarCuentaRegresiva() {
      if (intervaloCuenta) clearInterval(intervaloCuenta);
      
      intervaloCuenta = setInterval(() => {
        const ahora = Date.now();
        const tiempoRestante = tiempoExpiracion - ahora;
        
        if (tiempoRestante <= 0) {
          clearInterval(intervaloCuenta);
          actualizarEstado('expirado');
          elements.countdown.textContent = 'Expirado';
          return;
        }
        
        const minutos = Math.floor(tiempoRestante / 60000);
        const segundos = Math.floor((tiempoRestante % 60000) / 1000);
        elements.countdown.textContent = `${minutos}:${segundos.toString().padStart(2, '0')}`;
      }, 1000);
    }

    // Actualizar estado
    function actualizarEstado(estado) {
      elements.statusBadge.className = 'status-badge';
      
      switch(estado) {
        case 'activo':
          elements.statusBadge.classList.add('status-success');
          elements.statusText.innerHTML = '<i class="bi bi-shield-check me-1"></i>Activo';
          break;
        case 'expirado':
          elements.statusBadge.classList.add('status-warning');
          elements.statusText.innerHTML = '<i class="bi bi-clock me-1"></i>Expirado';
          break;
        case 'error':
          elements.statusBadge.classList.add('status-danger');
          elements.statusText.innerHTML = '<i class="bi bi-x-circle me-1"></i>Error';
          break;
        case 'generando':
          elements.statusBadge.classList.add('status-warning');
          elements.statusText.innerHTML = '<i class="bi bi-hourglass me-1"></i>Generando';
          break;
      }
    }

    async function actualizarEstadisticas() {
      try {
        const hoy = new Date().toISOString().split('T')[0];
        const statsRef = doc(db, "qr_stats", hoy);
        
        try {
          await updateDoc(statsRef, {
            generados: increment(1),
            ultimaActualizacion: new Date()
          });
        } catch (updateError) {
          await setDoc(statsRef, {
            generados: 1,
            exitosos: 0,
            bloqueados: 0,
            fecha: hoy,
            ultimaActualizacion: new Date()
          });
        }

        const statsDoc = await getDoc(statsRef);
        if (statsDoc.exists()) {
          const data = statsDoc.data();
          elements.tokensCount.textContent = data.generados || 0;
          elements.successCount.textContent = data.exitosos || 0;
          elements.blockedCount.textContent = data.bloqueados || 0;
        }

      } catch (error) {
        console.error('Error actualizando estad√≠sticas:', error);
      }
    }

    // ‚úÖ FUNCI√ìN VERIFICARTOKEN MEJORADA
    async function verificarToken() {
      try {
        console.log('üîç Verificando token existente...');
        
        // ‚úÖ VERIFICAR QUE QRCODE EST√â DISPONIBLE
        if (typeof QRCode === 'undefined') {
          console.error('‚ùå QRCode library not available');
          return;
        }
        
        const tokenDoc = await getDoc(doc(db, "qr_tokens", "current"));
        
        if (tokenDoc.exists()) {
          const data = tokenDoc.data();
          const ahora = new Date();
          const expiracion = data.expiracion.toDate();
          
          console.log('üìÑ Token encontrado:', data.token);
          console.log('‚è∞ Expira:', expiracion);
          console.log('üîµ Usado:', data.usado);
          
          if (data.usado || ahora > expiracion) {
            console.log('üîÑ Token expirado o usado, generando nuevo...');
            await generarQR();
          } else {
            console.log('‚úÖ Token v√°lido, reutilizando...');
            tokenActual = data.token;
            tiempoExpiracion = expiracion.getTime();
            elements.currentToken.textContent = tokenActual;
            
            // Recrear QR con token existente
            const baseUrl = window.location.origin + window.location.pathname.replace('qr-simple.html', 'index.html');
            const urlCompleta = `${baseUrl}?qr=OFICINA2025&token=${tokenActual}&t=${Date.now()}`;
            
            // ‚úÖ USAR PROMESA PARA GENERAR QR
            await new Promise((resolve, reject) => {
              QRCode.toCanvas(elements.qrCanvas, urlCompleta, {
                width: 300,
                height: 300,
                color: { dark: '#155d27', light: '#ffffff' },
                errorCorrectionLevel: 'M',
                margin: 2
              }, (error) => {
                if (error) reject(error);
                else resolve();
              });
            });
            
            elements.qrLoading.style.display = 'none';
            elements.qrCanvas.style.display = 'block';
            
            if (ahora < expiracion) {
              actualizarEstado('activo');
              iniciarCuentaRegresiva();
            } else {
              actualizarEstado('expirado');
            }
          }
        } else {
          console.log('üìù No hay token, generando nuevo...');
          await generarQR();
        }

        await actualizarEstadisticas();

      } catch (error) {
        console.error('‚ùå Error verificando token:', error);
        console.log('üîÑ Intentando generar nuevo QR...');
        await generarQR();
      }
    }

    // Event listeners
    elements.refreshBtn.addEventListener('click', generarQR);

    // ‚úÖ INICIALIZACI√ìN MEJORADA CON VERIFICACI√ìN DE LIBRER√çAS
    async function inicializar() {
      console.log('üöÄ Iniciando aplicaci√≥n QR...');
      
      // Verificar que todas las librer√≠as est√©n cargadas
      if (typeof QRCode === 'undefined') {
        console.error('‚ùå QRCode library not loaded, waiting...');
        
        // Esperar un poco y verificar de nuevo
        setTimeout(async () => {
          if (typeof QRCode !== 'undefined') {
            console.log('‚úÖ QRCode library loaded successfully');
            await verificarToken();
          } else {
            console.error('‚ùå QRCode library failed to load');
            elements.qrLoading.innerHTML = `
              <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
              <p class="text-danger mt-3 mb-0">Error cargando librer√≠a QR</p>
              <button class="btn btn-primary mt-2" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise me-1"></i>Recargar p√°gina
              </button>
            `;
          }
        }, 1000);
      } else {
        console.log('‚úÖ QRCode library ready');
        await verificarToken();
      }
    }

    // Inicializaci√≥n
    await inicializar();
    
    // Verificar cada 30 segundos
    setInterval(verificarToken, 30000);
    
    // Auto-refresh cada 25 minutos (5 min antes de expirar)
    setInterval(generarQR, 25 * 60 * 1000);
  </script>
</body>
</html>