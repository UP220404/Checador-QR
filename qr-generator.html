<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador QR - Cielito Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root {
      --verde: #155d27;
      --verde-claro: #e6f0e9;
      --dorado: #c1a35f;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      min-height: 100vh;
      padding: 2rem;
    }

    .qr-container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, var(--verde), var(--dorado));
      color: white;
      padding: 2rem;
      text-align: center;
    }

    .logo-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .qr-content {
      padding: 2rem;
      text-align: center;
    }

    .qr-code-container {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 2rem;
      margin: 2rem 0;
      border: 3px dashed var(--verde);
    }

    .token-info {
      background: linear-gradient(135deg, var(--verde-claro), #f0f8f0);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      border-left: 4px solid var(--verde);
    }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .status-active {
      background: #d1e7dd;
      color: #0f5132;
    }

    .status-expired {
      background: #f8d7da;
      color: #842029;
    }

    .refresh-btn {
      background: linear-gradient(135deg, var(--verde), var(--dorado));
      border: none;
      border-radius: 12px;
      padding: 0.8rem 2rem;
      color: white;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(21, 93, 39, 0.3);
      color: white;
    }

    .countdown {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--verde);
    }

    .usage-counter {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      border-radius: 10px;
      padding: 1rem;
      margin-top: 1rem;
    }

    .admin-controls {
      background: #e9ecef;
      padding: 1.5rem;
      border-top: 1px solid #dee2e6;
    }

    .loading {
      color: #6c757d;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .pulse {
      animation: pulse 1.5s infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="qr-container">
      <!-- Header -->
      <div class="header">
        <div class="logo-icon">
          <i class="bi bi-building"></i>
        </div>
        <h1 class="h3 mb-0">Cielito Home</h1>
        <p class="mb-0 mt-2">Generador de QR Seguro</p>
      </div>

      <!-- Contenido principal -->
      <div class="qr-content">
        <!-- Estado del token -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">QR de Acceso</h5>
          <span id="status-indicator" class="status-indicator status-active">
            <i class="bi bi-shield-check"></i>
            Activo
          </span>
        </div>

        <!-- Información del token -->
        <div class="token-info">
          <div class="row g-3">
            <div class="col-md-6">
              <small class="text-muted d-block">Token Actual:</small>
              <code id="current-token" class="text-success">Generando...</code>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Válido por:</small>
              <span id="countdown" class="countdown">--:--</span>
            </div>
          </div>
        </div>

        <!-- Código QR -->
        <div class="qr-code-container">
          <div id="qr-loading" class="loading pulse">
            <i class="bi bi-hourglass-split" style="font-size: 2rem;"></i>
            <p class="mt-2 mb-0">Generando QR seguro...</p>
          </div>
          <canvas id="qr-code" style="display: none;"></canvas>
        </div>

        <!-- Contador de usos -->
        <div class="usage-counter">
          <div class="row text-center">
            <div class="col-4">
              <strong id="tokens-generados">0</strong>
              <small class="d-block text-muted">Tokens generados hoy</small>
            </div>
            <div class="col-4">
              <strong id="registros-exitosos">0</strong>
              <small class="d-block text-muted">Registros exitosos</small>
            </div>
            <div class="col-4">
              <strong id="intentos-bloqueados">0</strong>
              <small class="d-block text-muted">Intentos bloqueados</small>
            </div>
          </div>
        </div>

        <!-- Botón de regenerar -->
        <button id="refresh-btn" class="btn refresh-btn mt-3">
          <i class="bi bi-arrow-clockwise me-2"></i>
          Generar Nuevo QR
        </button>

        <p class="text-muted small mt-3">
          <i class="bi bi-info-circle me-1"></i>
          El QR se regenera automáticamente después de cada registro exitoso
        </p>
      </div>

      <!-- Controles de administrador -->
      <div class="admin-controls">
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted">
            <i class="bi bi-shield-lock me-1"></i>
            Panel de Control
          </span>
          <div class="btn-group btn-group-sm">
            <button id="stats-btn" class="btn btn-outline-primary" onclick="mostrarEstadisticas()">
              <i class="bi bi-graph-up"></i>
            </button>
            <button id="admin-btn" class="btn btn-outline-success" onclick="irAdmin()">
              <i class="bi bi-speedometer2"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Información adicional -->
    <div class="text-center mt-4">
      <p class="text-muted small">
        Sistema de seguridad activo • Tokens únicos • Anti-reutilización
      </p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyD2o2FyUwVZafKIv-qtM6fmA663ldB_1Uo",
      authDomain: "qr-acceso-cielito-home.firebaseapp.com",
      projectId: "qr-acceso-cielito-home",
      storageBucket: "qr-acceso-cielito-home.appspot.com",
      messagingSenderId: "229634415256",
      appId: "1:229634415256:web:c576ba8879e58e441c4eed"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Variables globales
    let tokenActual = null;
    let tiempoExpiracion = null;
    let intervaloCuenta = null;
    let contadorestadisticas = { generados: 0, exitosos: 0, bloqueados: 0 };

    // Elementos DOM
    const elements = {
      qrCode: document.getElementById('qr-code'),
      qrLoading: document.getElementById('qr-loading'),
      currentToken: document.getElementById('current-token'),
      countdown: document.getElementById('countdown'),
      statusIndicator: document.getElementById('status-indicator'),
      refreshBtn: document.getElementById('refresh-btn'),
      tokensGenerados: document.getElementById('tokens-generados'),
      registrosExitosos: document.getElementById('registros-exitosos'),
      intentosBloqueados: document.getElementById('intentos-bloqueados')
    };

    // Generar token único
    function generarTokenSeguro() {
      const timestamp = Date.now();
      const random = Math.random().toString(36).substring(2, 15);
      const extra = Math.random().toString(36).substring(2, 8);
      return `CH_${timestamp}_${random}_${extra}`.toUpperCase();
    }

    // Generar QR
    async function generarQR() {
      try {
        elements.qrLoading.style.display = 'block';
        elements.qrCode.style.display = 'none';

        // Generar nuevo token
        tokenActual = generarTokenSeguro();
        tiempoExpiracion = Date.now() + (30 * 60 * 1000); // 30 minutos

        // Guardar en Firebase
        await setDoc(doc(db, "qr_tokens", "current"), {
          token: tokenActual,
          expiracion: new Date(tiempoExpiracion),
          creado: new Date(),
          usado: false,
          activo: true
        });

        // Crear URL del checador con token
        const baseUrl = window.location.origin + window.location.pathname.replace('qr-generator.html', 'index.html');
        const urlCompleta = `${baseUrl}?qr=OFICINA2025&token=${tokenActual}&t=${Date.now()}`;

        // Generar código QR
        await QRCode.toCanvas(elements.qrCode, urlCompleta, {
          width: 280,
          height: 280,
          color: {
            dark: '#155d27',
            light: '#ffffff'
          },
          errorCorrectionLevel: 'M',
          margin: 2
        });

        // Actualizar UI
        elements.currentToken.textContent = tokenActual;
        elements.qrLoading.style.display = 'none';
        elements.qrCode.style.display = 'block';
        
        actualizarEstado('activo');
        iniciarCuentaRegresiva();
        await actualizarEstadisticas();

        console.log('✅ QR generado con token:', tokenActual);

      } catch (error) {
        console.error('Error generando QR:', error);
        elements.qrLoading.innerHTML = '<i class="bi bi-exclamation-circle text-danger"></i><p class="text-danger mt-2">Error al generar QR</p>';
      }
    }

    // Cuenta regresiva
    function iniciarCuentaRegresiva() {
      if (intervaloCuenta) clearInterval(intervaloCuenta);
      
      intervaloCuenta = setInterval(() => {
        const ahora = Date.now();
        const tiempoRestante = tiempoExpiracion - ahora;
        
        if (tiempoRestante <= 0) {
          clearInterval(intervaloCuenta);
          actualizarEstado('expirado');
          return;
        }
        
        const minutos = Math.floor(tiempoRestante / 60000);
        const segundos = Math.floor((tiempoRestante % 60000) / 1000);
        elements.countdown.textContent = `${minutos}:${segundos.toString().padStart(2, '0')}`;
      }, 1000);
    }

    // Actualizar estado visual
    function actualizarEstado(estado) {
      elements.statusIndicator.className = 'status-indicator';
      
      if (estado === 'activo') {
        elements.statusIndicator.classList.add('status-active');
        elements.statusIndicator.innerHTML = '<i class="bi bi-shield-check"></i> Activo';
      } else if (estado === 'expirado') {
        elements.statusIndicator.classList.add('status-expired');
        elements.statusIndicator.innerHTML = '<i class="bi bi-shield-x"></i> Expirado';
        elements.countdown.textContent = 'Expirado';
      }
    }

    // Actualizar estadísticas
    async function actualizarEstadisticas() {
      try {
        const hoy = new Date().toISOString().split('T')[0];
        const statsRef = doc(db, "qr_stats", hoy);
        const statsDoc = await getDoc(statsRef);
        
        if (statsDoc.exists()) {
          const data = statsDoc.data();
          contadorestadisticas = {
            generados: data.generados || 0,
            exitosos: data.exitosos || 0,
            bloqueados: data.bloqueados || 0
          };
        }

        // Incrementar contador de generados
        await updateDoc(statsRef, {
          generados: increment(1),
          ultimaActualizacion: new Date()
        }).catch(async () => {
          // Si no existe el documento, crearlo
          await setDoc(statsRef, {
            generados: 1,
            exitosos: 0,
            bloqueados: 0,
            fecha: hoy,
            ultimaActualizacion: new Date()
          });
        });

        contadorestadisticas.generados++;
        
        // Actualizar UI
        elements.tokensGenerados.textContent = contadorestadisticas.generados;
        elements.registrosExitosos.textContent = contadorestadisticas.exitosos;
        elements.intentosBloqueados.textContent = contadorestadisticas.bloqueados;

      } catch (error) {
        console.error('Error actualizando estadísticas:', error);
      }
    }

    // Verificar estado del token actual
    async function verificarToken() {
      try {
        const tokenDoc = await getDoc(doc(db, "qr_tokens", "current"));
        
        if (tokenDoc.exists()) {
          const data = tokenDoc.data();
          const ahora = new Date();
          const expiracion = data.expiracion.toDate();
          
          if (data.usado || ahora > expiracion) {
            console.log('🔄 Token expirado o usado, generando nuevo...');
            await generarQR();
          } else {
            tokenActual = data.token;
            tiempoExpiracion = expiracion.getTime();
            elements.currentToken.textContent = tokenActual;
            
            if (ahora < expiracion) {
              actualizarEstado('activo');
              iniciarCuentaRegresiva();
            } else {
              actualizarEstado('expirado');
            }
          }
        } else {
          await generarQR();
        }
      } catch (error) {
        console.error('Error verificando token:', error);
        await generarQR();
      }
    }

    // Event listeners
    elements.refreshBtn.addEventListener('click', generarQR);

    // Funciones globales
    window.mostrarEstadisticas = () => {
      alert(`📊 Estadísticas del día:\n\n• Tokens generados: ${contadorestadisticas.generados}\n• Registros exitosos: ${contadorestadisticas.exitosos}\n• Intentos bloqueados: ${contadorestadisticas.bloqueados}`);
    };

    window.irAdmin = () => {
      window.open('admin.html', '_blank');
    };

    // Inicialización
    await verificarToken();
    setInterval(verificarToken, 60000); // Verificar cada minuto

    // Auto-refresh cada 30 minutos
    setInterval(generarQR, 30 * 60 * 1000);
  </script>
</body>
</html>