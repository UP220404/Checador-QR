<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Test - Cielito Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #155d27 0%, #c1a35f 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .container-qr {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      text-align: center;
      color: #333;
      max-width: 400px;
    }
    .qr-area {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 2rem;
      margin: 1rem 0;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #qr-canvas {
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <div class="container-qr">
    <h1 class="h3 mb-3">üè¢ Cielito Home</h1>
    <p class="text-muted">Generador QR de Prueba</p>
    
    <div class="qr-area">
      <div id="loading">
        <i class="bi bi-hourglass-split text-primary" style="font-size: 2rem;"></i>
        <p class="mt-2 mb-0">Generando QR...</p>
      </div>
      <canvas id="qr-canvas" style="display: none;"></canvas>
    </div>
    
    <div class="mt-3">
      <p><strong>Token:</strong> <span id="token-display">Generando...</span></p>
      <p><strong>Estado:</strong> <span id="status" class="badge bg-success">Activo</span></p>
    </div>
    
    <button id="regenerar" class="btn btn-primary mt-3">
      <i class="bi bi-arrow-clockwise"></i> Regenerar QR
    </button>
    
    <div class="mt-3">
      <small class="text-muted">
        Si ves el QR, el sistema funciona correctamente
      </small>
    </div>
  </div>

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyD2o2FyUwVZafKIv-qtM6fmA663ldB_1Uo",
      authDomain: "qr-acceso-cielito-home.firebaseapp.com",
      projectId: "qr-acceso-cielito-home",
      storageBucket: "qr-acceso-cielito-home.appspot.com",
      messagingSenderId: "229634415256",
      appId: "1:229634415256:web:c576ba8879e58e441c4eed"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let tokenActual = null;

    // Elementos
    const loading = document.getElementById('loading');
    const canvas = document.getElementById('qr-canvas');
    const tokenDisplay = document.getElementById('token-display');
    const statusDisplay = document.getElementById('status');
    const btnRegenerar = document.getElementById('regenerar');

    // Generar token
    function generarToken() {
      const timestamp = Date.now();
      const random = Math.random().toString(36).substring(2, 10);
      return `CH_${timestamp}_${random}`.toUpperCase();
    }

    // Generar QR con librer√≠a alternativa
    async function generarQRTest() {
      try {
        console.log('üîÑ Iniciando generaci√≥n de QR de prueba...');
        
        loading.style.display = 'block';
        canvas.style.display = 'none';
        statusDisplay.textContent = 'Generando...';
        statusDisplay.className = 'badge bg-warning';

        // Generar token
        tokenActual = generarToken();
        console.log('üìù Token:', tokenActual);
        
        // Guardar en Firebase
        await setDoc(doc(db, "qr_tokens", "test"), {
          token: tokenActual,
          expiracion: new Date(Date.now() + 30 * 60 * 1000),
          creado: new Date(),
          usado: false,
          test: true
        });
        
        console.log('üíæ Token guardado en Firebase');

        // URL para el QR
        const baseUrl = window.location.origin + window.location.pathname.replace('qr-test.html', 'index.html');
        const url = `${baseUrl}?qr=OFICINA2025&token=${tokenActual}&test=1`;
        
        console.log('üîó URL:', url);

        // Generar QR con QRious (librer√≠a alternativa)
        const qr = new QRious({
          element: canvas,
          value: url,
          size: 250,
          foreground: '#155d27',
          background: '#ffffff'
        });

        // Actualizar UI
        tokenDisplay.textContent = tokenActual;
        loading.style.display = 'none';
        canvas.style.display = 'block';
        statusDisplay.textContent = 'Activo';
        statusDisplay.className = 'badge bg-success';

        console.log('‚úÖ QR generado exitosamente');

      } catch (error) {
        console.error('‚ùå Error:', error);
        
        loading.innerHTML = `
          <i class="bi bi-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
          <p class="text-danger mt-2">Error: ${error.message}</p>
        `;
        
        statusDisplay.textContent = 'Error';
        statusDisplay.className = 'badge bg-danger';
      }
    }

    // Verificar token existente
    async function verificarToken() {
      try {
        const tokenDoc = await getDoc(doc(db, "qr_tokens", "test"));
        
        if (tokenDoc.exists()) {
          const data = tokenDoc.data();
          console.log('Token existente encontrado:', data);
          
          if (data.usado || new Date() > data.expiracion.toDate()) {
            console.log('Token expirado, generando nuevo...');
            await generarQRTest();
          } else {
            console.log('Reutilizando token v√°lido');
            tokenActual = data.token;
            tokenDisplay.textContent = tokenActual;
            
            // Regenerar QR con token existente
            const baseUrl = window.location.origin + window.location.pathname.replace('qr-test.html', 'index.html');
            const url = `${baseUrl}?qr=OFICINA2025&token=${tokenActual}&test=1`;
            
            const qr = new QRious({
              element: canvas,
              value: url,
              size: 250,
              foreground: '#155d27',
              background: '#ffffff'
            });
            
            loading.style.display = 'none';
            canvas.style.display = 'block';
            statusDisplay.textContent = 'Activo';
            statusDisplay.className = 'badge bg-success';
          }
        } else {
          console.log('No hay token, generando nuevo...');
          await generarQRTest();
        }
      } catch (error) {
        console.error('Error verificando token:', error);
        await generarQRTest();
      }
    }

    // Event listeners
    btnRegenerar.addEventListener('click', generarQRTest);

    // Inicializar
    console.log('üöÄ Iniciando generador de prueba...');
    
    // Verificar que QRious est√© disponible
    if (typeof QRious === 'undefined') {
      console.error('‚ùå QRious no est√° disponible');
      loading.innerHTML = `
        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 2rem;"></i>
        <p class="text-danger mt-2">Librer√≠a QR no disponible</p>
      `;
    } else {
      console.log('‚úÖ QRious disponible');
      verificarToken();
    }
  </script>
</body>
</html>